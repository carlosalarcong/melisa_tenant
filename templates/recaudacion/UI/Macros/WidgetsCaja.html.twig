{# Autor Osvaldo Valdenegro #}

{% macro resources() %}
    {% javascripts
        '@RegistroClinicoHospitalarioBundle/Resources/public/js/notificaciones.js'
    %}
        <script src="{{ asset_url }}"></script>
    {% endjavascripts %}
	<script type="text/javascript" src="{{ asset('js/uncompressed/Caja/Validate-keyup-customs.js') }}"></script>
	<script type="text/javascript" src="{{ asset('js/uncompressed/Caja/Events-div-seek.js') }}"></script>
	<script type="text/javascript" src="{{ asset('js/uncompressed/Caja/Events-rut-seek.js') }}"></script>
	<script type="text/javascript" src="{{ asset('js/uncompressed/Caja/Events-adv-seek.js') }}"></script>
	<script type="text/javascript" src="{{ asset('js/uncompressed/Caja/Events-add-people.js') }}"></script>
	<script type="text/javascript" src="{{ asset('js/uncompressed/Caja/Events-form-prestacion.js') }}"></script>
	<script type="text/javascript" src="{{ asset('js/uncompressed/Caja/choise-Style-custom.js') }}"></script>
	<script type="text/javascript" src="{{ asset('js/uncompressed/Caja/Transbank/pos.js') }}"></script>
	<script type="text/javascript" src="{{ asset('js/uncompressed/Caja/Events-Pay.js') }}"></script>
	<script type="text/javascript" src="{{ asset('js/uncompressed/Caja/Events-PayModes.js') }}"></script>
	<script type="text/javascript" src="{{ asset('js/uncompressed/Caja/jquery-scrollto.js') }}"></script>
	<script type="text/javascript" src="{{ asset('js/uncompressed/Caja/Events-Garantia.js') }}"></script>
	<script type="text/javascript" src="{{ asset('js/uncompressed/Caja/fnCommon_Caja.js') }}"></script>
	<script type="text/javascript" src="{{ asset('js/uncompressed/Caja/Events-Imed.js') }}"></script>
	<script type="text/javascript" src="{{ asset('js/uncompressed/Caja/Events-Tratamiento.js') }}"></script>
	<script type="text/javascript" src="{{ asset('bundles/hermes/js/FichaClinica/jquery.Rut.min.js') }}"></script>
	{# <script type="text/javascript" src="{{ asset('js/uncompressed/Caja/Events-Diferencias.js') }}"></script> #}
{% endmacro %}

{% macro resourcesApi() %}
{% endmacro %}

{% macro tippedlist() %}
    <script type='text/javascript'>
        function tippedlist() {
            $('.tooltip-from-element').each(function () {
                var selector = '#' + $(this).data('tooltip-id');
                Tipped.create(this, $(selector)[0], {
                    target: $(this).id,
                    hook: {target: 'rightmiddle', tooltip: 'leftmiddle'},
                    skin: 'white',
                    radius: {size: 1}
                });
            });
        }
    </script>
    <div id='tooltipborrarconvenio' style='display:none'>Limpiar convenio</div>
    <div id='tooltiphistoricopagos' style='display:none'>Puede revisar los pagos historicos del paciente</div>
{% endmacro %}

{% macro EventosDivBusqueda() %}
    <script type="text/javascript">
        function loadScriptEventosDivBusquedaMacro() {
            console.log('WidgetCaja::loadScriptEventosDivBusquedaMacro')
            $(".btn-edit-paciente, #btneditDatosPaciente").on('click', function () {
                $(".btn-volver").hide();
                $(".btn-btnback").hide();
                //   $(".btn-salvar").show();
                $("#pacienteform").slideDown(1000);
                $(".pacientefallecido").slideUp(1000);
                $("#listapacienteform").slideUp(1000);
                $("#pacienteresumen").slideUp(1000);
                $("#datosprestacion").slideUp(1000);
                $('#pacienteform').slideDown(1000);
                $("#volver-desde-formulario-paciente").hide();
                $("#volver-desde-formulario-paciente").addClass('hide ocultarDiv');
                $('.btn-edit-lista-prestaciones').hide();
                $('#btneditListaPrestaciones').hide();
                $(".alertaExisteFullDatos").hide();
                $(".alertaExisteDatos").slideDown(900);
                var data = {
                    idPersona: $("#idPersonainput").val()
                };
                var resultadoAjaxUsuario = $.ajax({
                    type: 'get',
                    url: "{{ path('Caja_Verifica_UsuarioNuevo') }}",
                    //   async: false,
                    data: data,
                    success: function (datar) {
                        datar = $.parseJSON(datar);
                        return datar;
                    }
                });
                if (resultadoAjaxUsuario === true) {
                    $(".permitidoUserNuervo").removeAttr("disabled");
                    $(".permitidoUserNuervo").removeAttr("readonly");
                    $(".permitidoTemp").removeAttr("disabled");
                    $(".permitidoTemp").removeAttr("readonly");
                    $("#rebsol_hermesbundle_PagoType_idSexo").removeAttr("disabled");
                    $("#rebsol_hermesbundle_PagoType_idSexo").removeAttr("readonly");
                    $("#rebsol_hermesbundle_PagoType_fechaNacimiento").removeAttr("disabled");
                    $("#rebsol_hermesbundle_PagoType_fechaNacimiento").removeAttr("readonly");
                    $("#rebsol_hermesbundle_PagoType_comuna").removeAttr("disabled");
                    $("#rebsol_hermesbundle_PagoType_comuna").removeAttr("readonly");
                } else {
                    $(".permitidoTemp").removeAttr("disabled");
                    $(".permitidoTemp").removeAttr("readonly");
                    $("#rebsol_hermesbundle_PagoType_comuna").removeAttr("disabled");
                    $("#rebsol_hermesbundle_PagoType_comuna").removeAttr("readonly");
                }
                if (!idReservaAtencion) {
                    botonesFormPaciente(9, null);
                } else {
                    botonesFormPaciente(10, null);
                }
            });
        }

        function validarFechaN() {
            setTimeout(function () {
                var data = {
                    fecha: $('#rebsol_hermesbundle_PagoType_fechaNacimiento').val()
                };
                $.ajax({
                    type: 'get',
                    url: "{{ path('Agenda_DatosMaestrosMedicos_Consulta_FechaNacimiento') }}",
                    async: false,
                    data: data,
                    success: function (datar) {
                        if (datar === "true") {
                            $(".fechansuperior").slideDown();
                            $('#rebsol_hermesbundle_PagoType_fechaNacimiento').val("");
                            return false;
                        } else {
                            $(".fechansuperior").slideUp();
                            return false;
                        }
                    }
                });
            }, 1000);
        }
    </script>
{% endmacro %}
{# Busqueda RUT #}
{% macro BusquedaRutDv() %}

    <script type='text/javascript'>

        var dataReserva = null;
        var idPersona = null;
        var usuario = null;
        var fechad = null;
        var fechanacimiento = null;
        var extranjeroFecha = 0;

        const habilitarPaisComuna = (tipoIdentificacion) => {
            if (habilitarPaisExtranjero && (tipoIdentificacion == 2 || tipoIdentificacion == 4) ) {
                $('#vistaComunaTh').hide();
                $('#vistaComunaTd').hide();
                $('#vistaPaisTh').show();
                $('#vistaPaisTd').show();
            } else {
                $('#vistaPaisTh').hide();
                $('#vistaPaisTd').hide();
                $('#vistaComunaTh').show();
                $('#vistaComunaTd').show();
            }
        }

        function verificaExtranjero() {
            console.log('RecaudacionBundle::verificaExtranjero')

            idReservaAtencion = (typeof idReservaAtencion !== 'undefined') ? idReservaAtencion : null;
            console.log('idReservaAtencion:: '+idReservaAtencion)
            $('#btnCargaFormPaciente').hide();
            var idPersonaExtrangero = 0;

            if (idReservaAtencion) {
                if (extranjero) {

                    $.ajax({
                        type: 'get',
                        url: "{{ path('Caja_Recaudacion_Pago_ValExtranjeros') }}",
                        data: {
                            r: identificacion
                        },
                        success: function (datar) {

                            if ((datar != 'vacio') && (datar != 'no')) {

                                $(".disableform").val('');
                                if (datar instanceof Object == false) {

                                    if (idReservaAtencion) {

                                        IngresaDatosFormReservaExtranjero(1, extranjero, identificacion);
                                    }

                                    BuscaComunaParaFormulario({
                                        comuna: idComuna1
                                    });
                                    botonesFormPaciente(1, fechad);
                                    return false;
                                } else {
                                    /** paciente nuevo, aparecer formulario sin datos y mensaje que paciente es nuevo */
                                    EventoSinDatosEnRegistro(1);
                                    return false;
                                }
                            } else {
                                /** paciente existente, cargar los datos del paciente, y mostrar formulario */
                                IngresaDatosFormReservaExtranjeroRegistrado(1, datar);

                                if (idReservaAtencion) {
                                    registroDireccion(idComuna1, direccion1, numero1, resto1);

                                    BuscaComunaParaFormulario({
                                        comuna: idComuna1
                                    });

                                } else {

                                    ObtieneDomicilioIdPersona({
                                        id: idPersona
                                    });
                                }

                                if (usuario == null) {
                                    $(".disablepago").attr("disabled", "disabled");
                                    $(".disablepago").attr("readonly", "readonly");
                                    $("#rebsol_hermesbundle_PagoType_fechaNacimiento").attr("readonly", "readonly");
                                    $("#rebsol_hermesbundle_PagoType_fechaNacimiento").attr("disabled", "disabled");
                                } else {
                                    setTimeout(function () {
                                        $(".infoesusuario").slideDown(800);
                                        $(".infoesusuario").slideUp(1000);
                                    }, 4800);
                                }

                                $("#busquedaPacientesForm").slideUp(1000);
                                $("#rutdv2").val(rut1);
                                $("#buscarPaciente_identificacion").attr("disabled", "disabled");
                                $("#buscarPaciente_identificacion").attr("readonly", "readonly");
                                PermiteCamposenFormulario();
                                $("#rebsol_hermesbundle_PagoType_comuna").addClass("chosen-select");
                                pasiregioncomunaBusca();
                                if (!fechad) {
                                    $(".btn-volver2").hide();
                                } else {
                                    fallecido(fechad);
                                }
                                botonesFormPaciente(2, fechad);
                                return false;
                            }
                            return false;
                        }
                    });

                    if (idPersonaExtrangero == 0) {

                        IngresaDatosFormReservaExtranjero(1, extranjero, identificacion);

                        BuscaComunaParaFormulario({
                            comuna: idComuna1
                        });

                        botonesFormPaciente(4, fechad);

                        return 1;
                    }
                    return 1;
                } else {
                    return 0;
                }
            } else {
                return 0;
            }
        }

        function ValidaRut(busquedaAvanzada = false) {
            console.log('RecaudacionBundle::WidgetCaja::ValidaRut')
            var Rut = $("#rebsol_hermesbundle_PagoType_rutPersona").val();
            var digitoVerificador = $("#rebsol_hermesbundle_PagoType_digitoVerifivador").val();
            if (parseInt($('#buscarPaciente_tipoIdentificacion').val()) === 1) {

                $('#btnCargaFormPaciente').hide();
                limpiarayapuntio();

                var append = $("#buscarPaciente_identificacion").closest(".input-append").children('span').children('i');
                append.removeClass('icon-asterisk green icon-remove icon-large red');
                append.addClass('icon-spinner icon-spin');
                if ($("#buscarPaciente_identificacion").val() !== '') {

                    var rdv = $("#buscarPaciente_identificacion").val();
                    var largo = rdv.length;
                    var r = $("#buscarPaciente_identificacion").val().substr(0, largo - 1);
                    var dv = $("#buscarPaciente_identificacion").val().substr(largo - 1, largo);
                    $("#rebsol_hermesbundle_PagoType_rutPersona").val(r);
                    $("#rebsol_hermesbundle_PagoType_digitoVerifivador").val(dv);
                }


                var rut = ($("#rebsol_hermesbundle_PagoType_rutPersona").val() == '' || $("#rebsol_hermesbundle_PagoType_digitoVerifivador").val() == '');
                var documento = ($("#rebsol_hermesbundle_PagoType_numeroDocumento").val() == '' || $("#rebsol_hermesbundle_PagoType_documento").val() == '');

                if (rut && documento) {

                    /** sin valores rut y dv */
                    if (idReservaAtencion) {

                        IngresaDatosFormReservaExtranjero(0, null, null);

                        BuscaComunaParaFormulario({
                            comuna: idComuna1
                        });

                        botonesFormPaciente(4, fechad);
                        return false;
                    } else {
                        return false;
                    }
                }
            } else {

                if ($('#otro-identificacion').val() === "") {

                    $('#otro-identificacion')[0].style.border = "1px solid red";

                    //Fix busquedaAvanzada PagoCuenta Con Tipo de Identificacion Distinto de Rut.
                    //return false;
                }

            }

            // $('#otro-identificacion')[0].style.border = "1px solid #ccc";
            if (verificaExtranjero() == 0) {
                /** no es extranjero desde reserva */
                if($('#buscarPaciente_tipoIdentificacion').val() == 1){
                reformat();
                }

                var seleccionDocumento = '';

                if ($('#buscarPaciente_identificacion').is(':visible')) {

                    seleccionDocumento = $('#buscarPaciente_identificacion').val();

                } else {

                    seleccionDocumento = $('#otro-identificacion').val();
                }

                $.get("{{ path('Caja_Recaudacion_Pago_ValRut') }}", {
                    idTipoIdentificacionExtranjero: $('#buscarPaciente_tipoIdentificacion').val(),
                    tipoDocumentoExtranjero: $('#buscarPaciente_identificacion').val(),
                    busquedaAvanzada: busquedaAvanzada
                }, function (datar) {

                    datar = $.parseJSON(datar);

                    if (datar) {

                        if ($('#buscarPaciente_tipoIdentificacion').val() == 1) {

                            if ((datar !== 'Rut pertenece a Empresa') && (datar !== 'Rut Inválido') && (datar !== 'Rut no debe ser vacío')) {

                                $('.disableform').val('');

                                if (datar instanceof Object == false) {


                                    if (idReservaAtencion) {

                                        if ($("#rebsol_hermesbundle_PagoType_numeroDocumento").val() == '' && $("#rebsol_hermesbundle_PagoType_documento").val() == '') {
                                            IngresaDatosFormReservaExtranjero(6, null, null);
                                        } else {
                                            IngresaDatosFormReservaExtranjero(2, extranjeroID, numDocumento);
                                        }

                                        BuscaComunaParaFormulario({
                                            comuna: idComuna1
                                        });

                                          botonesFormPaciente(5, fechad);
                                    } else {

                                        EventoSinDatosEnRegistro(0);
                                    }

                                } else {

                                    /** paciente existente, cargar los datos del paciente, y mostrar formulario */
                                    if (verificaRutDocumentoExtranjeroexiste == 1) {

                                        bootbox.dialog(
                                            "<div class='alert alert-block alert-warning'>" +
                                            "    <p>" +
                                            "    <strong><i class='icon-ok'></i> Se ha encontrado una coincidencia con Dato Ingresado,</strong>" +
                                            "    </p>" +
                                            "    <p>" +
                                            "   Advertencia: Se actualizarán los datos de Reserva con datos encontrados " +
                                            "    </p>" +
                                            "</div>", [{
                                                "label": "Aceptar",
                                                "class": "btn btn-mini btn-success",
                                                "callback": function () {

                                                    /** si tiene rut y no hubo necesidad de validarlo (desde reserva de atencion) */
                                                    IngresaDatosFormReservaExtranjeroRegistrado(0, datar);

                                                    if (idReservaAtencion) {
                                                        registroDireccion(idComuna1, direccion1, numero1, resto1);
                                                        var data = {
                                                            comuna: idComuna1
                                                        };
                                                        BuscaComunaParaFormulario(data);
                                                    } else {
                                                        if (dataReserva) {
                                                            registroDireccionDataReserva(datar)
                                                        } else {
                                                            var data = {
                                                                id: idPersona
                                                            };
                                                            ObtieneDomicilioIdPersona(data);
                                                        }
                                                    }
                                                    if (usuario) {
                                                        $(".disablepago").attr("disabled", "disabled");
                                                        $(".disablepago").attr("readonly", "readonly");
                                                        $("#rebsol_hermesbundle_PagoType_fechaNacimiento").attr("readonly", "readonly");
                                                        $("#rebsol_hermesbundle_PagoType_fechaNacimiento").attr("disabled", "disabled");
                                                        $(".infoesusuario").slideDown(800);
                                                        setTimeout(function () {
                                                            $(".infoesusuario").slideUp(1000);
                                                        }, 4800);
                                                    }

                                                    $("#busquedaPacientesForm").slideUp(1000);
                                                    if($('#recaudacion-informacion-paciente').length > 0){
                                                        $('#recaudacion-informacion-paciente').removeClass('hide');
                                                    }
                                                    disabledReadOnlyCampos();
                                                    botonesFormPaciente(6, fechad);
                                                    crearUsuarioSinRut = 1;
                                                }
                                            }]);

                                    } else {

                                        /** si tiene rut y no hubo necesidad de validarlo (desde reserva de atencion) */
                                        IngresaDatosFormReservaExtranjeroRegistrado(2, datar);

                                        if (idReservaAtencion) {
                                            registroDireccion(idComuna1, direccion1, numero1, resto1);
                                            var data = {
                                                comuna: idComuna1
                                            };
                                            BuscaComunaParaFormulario(data);
                                        } else {
                                            if (dataReserva) {
                                                registroDireccionDataReserva(datar)
                                            } else {
                                                var data = {
                                                    id: idPersona
                                                };
                                                ObtieneDomicilioIdPersona(data);
                                            }
                                        }

                                        if (usuario) {
                                            $(".disablepago").attr("disabled", "disabled");
                                            $(".disablepago").attr("readonly", "readonly");
                                            $("#rebsol_hermesbundle_PagoType_fechaNacimiento").attr("readonly", "readonly");
                                            $("#rebsol_hermesbundle_PagoType_fechaNacimiento").attr("disabled", "disabled");
                                            $(".infoesusuario").slideDown(800);
                                            setTimeout(function () {
                                                $(".infoesusuario").slideUp(1000);
                                            }, 4800);
                                        }

                                        $("#busquedaPacientesForm").slideUp(1000);
                                        if($('#recaudacion-informacion-paciente').length > 0){
                                            $('#recaudacion-informacion-paciente').removeClass('hide');
                                        }
                                        disabledReadOnlyCampos()
                                        botonesFormPaciente(7, fechad);
                                    }

                                    if (idReservaAtencion) {

                                        $("#rebsol_hermesbundle_PagoType_fechaNacimiento").datepicker('update', fechanacimiento1);
                                        $("#rebsol_hermesbundle_PagoType_telefonoMovil").val(celu1);
                                        $("#rebsol_hermesbundle_PagoType_telefonoFijo").val(fijo1);
                                        $("#rebsol_hermesbundle_PagoType_telefonoTrabajo").val(trabajo1);
                                        $("#rebsol_hermesbundle_PagoType_correoElectronico").val(mail11);
                                        $("#user").val(usuario1);
                                        registroDireccion(idComuna1, direccion1, numero1, resto1);
                                        verificaGarantia(garantias);
                                        var data = {
                                            comuna: idComuna1
                                        };
                                        BuscaComunaParaFormulario(data);
                                    }

                                    if (!idReservaAtencion) {
                                        //if (coreApi == 1) {
                                            choisestyle_campos_prevision();
                                        //}
                                    }
                                }

                            } else {

                                $('#errormsjrut').html(datar);
                                accionerror();
                            }
                        } else {

                            /** otro documento */
                            if (verificaRutDocumentoExtranjeroexiste == 1) {

                                bootbox.dialog(
                                    "<div class='alert alert-block alert-warning'>" +
                                    "    <p>" +
                                    "    <strong><i class='icon-ok'></i> Se ha encontrado una coincidencia con Dato Ingresado,</strong>" +
                                    "    </p>" +
                                    "    <p>" +
                                    "   Advertencia: Se actualizarán los datos de Reserva con datos encontrados " +
                                    "    </p>" +
                                    "</div>", [{
                                        "label": "Aceptar",
                                        "class": "btn btn-mini btn-success",
                                        "callback": function () {

                                            /** si tiene rut y no hubo necesidad de validarlo (desde reserva de atencion) */
                                            IngresaDatosFormReservaExtranjeroRegistrado(0, datar);

                                            if (idReservaAtencion) {
                                                registroDireccion(idComuna1, direccion1, numero1, resto1);
                                                var data = {
                                                    comuna: idComuna1
                                                };
                                                BuscaComunaParaFormulario(data);
                                            } else {
                                                if (dataReserva) {
                                                    registroDireccionDataReserva(datar)
                                                } else {
                                                    var data = {
                                                        id: idPersona
                                                    };
                                                    ObtieneDomicilioIdPersona(data);
                                                }
                                            }
                                            if (usuario) {
                                                $(".disablepago").attr("disabled", "disabled");
                                                $(".disablepago").attr("readonly", "readonly");
                                                $("#rebsol_hermesbundle_PagoType_fechaNacimiento").attr("readonly", "readonly");
                                                $("#rebsol_hermesbundle_PagoType_fechaNacimiento").attr("disabled", "disabled");
                                                $(".infoesusuario").slideDown(800);
                                                setTimeout(function () {
                                                    $(".infoesusuario").slideUp(1000);
                                                }, 4800);
                                            }

                                            $("#busquedaPacientesForm").slideUp(1000);
                                            if($('#recaudacion-informacion-paciente').length > 0){
                                                $('#recaudacion-informacion-paciente').removeClass('hide');
                                            }
                                            disabledReadOnlyCampos();
                                            botonesFormPaciente(6, fechad);
                                            crearUsuarioSinRut = 1;
                                        }
                                    }]);

                            } else {

                                /** si tiene rut y no hubo necesidad de validarlo (desde reserva de atencion) */
                                IngresaDatosFormReservaExtranjeroRegistrado(2, datar);

                                if (idReservaAtencion) {
                                    registroDireccion(idComuna1, direccion1, numero1, resto1);
                                    var data = {
                                        comuna: idComuna1
                                    };
                                    BuscaComunaParaFormulario(data);
                                } else {
                                    if (dataReserva) {
                                        registroDireccionDataReserva(datar)
                                    } else {
                                        var data = {
                                            id: idPersona
                                        };
                                        ObtieneDomicilioIdPersona(data);
                                    }
                                }

                                if (usuario) {
                                    $(".disablepago").attr("disabled", "disabled");
                                    $(".disablepago").attr("readonly", "readonly");
                                    $("#rebsol_hermesbundle_PagoType_fechaNacimiento").attr("readonly", "readonly");
                                    $("#rebsol_hermesbundle_PagoType_fechaNacimiento").attr("disabled", "disabled");
                                    $(".infoesusuario").slideDown(800);
                                    setTimeout(function () {
                                        $(".infoesusuario").slideUp(1000);
                                    }, 4800);
                                }

                                $("#busquedaPacientesForm").slideUp(1000);
                                if($('#recaudacion-informacion-paciente').length > 0){
                                    $('#recaudacion-informacion-paciente').removeClass('hide');
                                }
                                disabledReadOnlyCampos()
                                botonesFormPaciente(7, fechad);
                            }

                            if (idReservaAtencion) {

                                $("#rebsol_hermesbundle_PagoType_fechaNacimiento").datepicker('update', fechanacimiento1);
                                $("#rebsol_hermesbundle_PagoType_telefonoMovil").val(celu1);
                                $("#rebsol_hermesbundle_PagoType_telefonoFijo").val(fijo1);
                                $("#rebsol_hermesbundle_PagoType_telefonoTrabajo").val(trabajo1);
                                $("#rebsol_hermesbundle_PagoType_correoElectronico").val(mail11);
                                $("#user").val(usuario1);
                                registroDireccion(idComuna1, direccion1, numero1, resto1);
                                verificaGarantia(garantias);
                                var data = {
                                    comuna: idComuna1
                                };
                                BuscaComunaParaFormulario(data);
                            }

                            if (!idReservaAtencion) {
                                // if (coreApi == 1) {
                                    choisestyle_campos_prevision();
                                // }
                            }

                            // console.log(datar)
                        }
                    } else {

                        $('.alertaNoexiste').slideDown();
                    }
                });
            }
        }

        function IngresaDatosFormReservaExtranjero(from, idEx, numDoc) {


            //from = 0: Es reserva desde function validaRut(); from = 1: Es reserva desde function verificaEstranjero();
            //from = 2: Es reserva desde function validaRut(), Es Extranjero, Es Reserva
            //from = 6: Es reserva, viene de una reserva sin RUT, y creara persona con RUT agregado en pago y NO es extranjero

            accionok();
            killScroll();
           /* Se comenta esta línea debido que en agenda al pagar una reserva
            * genera error
            * */
            // pasiregioncomunaBusca();
            choisestyle_comuna();

            $('#rebsol_hermesbundle_PagoType_comuna').trigger("liszt:updated");
            $("#pacienteform").show();
            $(".disableform").val('');

            if (from == 1) {

                $('.disableFieldsStandar, .camposExtranjero').attr("readonly", "readonly");

                if (idEx) {

                    $("#rebsol_hermesbundle_PagoType_documento").show();
                    $("#rebsol_hermesbundle_PagoType_numeroDocumento").show();

                }

                $("#rutdv2").val('');


                if ($('#rebsol_hermesbundle_PagoType_documento').val() == '1') {

                    $('#rutdv2').parent().parent().style('display', 'table-cell');
                    $('#rebsol_hermesbundle_PagoType_numeroDocumento').parent().parent().style('display', 'none');
                } else {
                    $('#rutdv2').parent().parent().style('display', 'none');
                    $('#rebsol_hermesbundle_PagoType_numeroDocumento').parent().parent().style('display', 'table-cell');
                }

                $('#rebsol_hermesbundle_PagoType_documento').style('pointer-events', 'none');
                $("#rutdv2").val(rut1 + '-' + dv1);

            }
            if (from == 6) {

                if (idEx) {

                    $("#rebsol_hermesbundle_PagoType_documento").show();
                    $("#rebsol_hermesbundle_PagoType_numeroDocumento").show();

                }

                $("#rebsol_hermesbundle_PagoType_telefonoTrabajo").val(trabajo1);
                $('#rebsol_hermesbundle_PrestacionType_prevision').prop('readOnly', false);
                $('#rebsol_hermesbundle_PrestacionType_prevision').prop('disabled', false);


            }
            if (from == 2) {
                $("#rutdv2").val('');
                if (idEx) {

                    $("#rebsol_hermesbundle_PagoType_documento").show();
                    $("#rebsol_hermesbundle_PagoType_numeroDocumento").show();

                }

                var rutbusqueda = $("#buscarPaciente_identificacion").val();
                $("#rutdv2").val(rutbusqueda);
                $("#rebsol_hermesbundle_PagoType_telefonoTrabajo").val(trabajo1);
                $('#rebsol_hermesbundle_PrestacionType_prevision').prop('readOnly', false);
                $('#rebsol_hermesbundle_PrestacionType_prevision').prop('disabled', false);

            }
            if (from == 0) {

                $("#rutdv2").val('');
                $(".sinRutDesdeReserva").removeClass('hidden').show();
                $(".campoNoExtrangero, .camposExtranjero").prop("disabled", true);
                $("#rebsol_hermesbundle_PagoType_rutPersona").val("");
                $("#rebsol_hermesbundle_PagoType_digitoVerifivador").val("");
                $("#rebsol_hermesbundle_PagoType_nombrePnatural").val(nombre1);
                $("#rebsol_hermesbundle_PagoType_apellidoPaterno").val(apep1);
                $("#rebsol_hermesbundle_PagoType_apellidoMaterno").val(apem1);
                $('#rebsol_hermesbundle_PrestacionType_prevision').prop('readOnly', false);
                $('#rebsol_hermesbundle_PrestacionType_prevision').prop('disabled', false);

            }
            if (from == 1 || from == 2) {

                $(".alertaNoexiste").slideDown();
                $(".text-error").hide();

                if (idEx) {

                    $("#spanEsExtranjeroRut").show();
                    $("#rebsol_hermesbundle_PagoType_documento").val(idEx);
                    $("#rebsol_hermesbundle_PagoType_numeroDocumento").val(numDoc);

                } else {

                    $("#rebsol_hermesbundle_PagoType_documento").hide();
                    $("#rebsol_hermesbundle_PagoType_numeroDocumento").hide();

                }

                $("#rebsol_hermesbundle_PagoType_rutPersona").val(rut1);
                $("#rebsol_hermesbundle_PagoType_digitoVerifivador").val(dv1);
                $("#rebsol_hermesbundle_PagoType_nombrePnatural").val(nombre1);
                $("#rebsol_hermesbundle_PagoType_apellidoPaterno").val(apep1);
                $("#rebsol_hermesbundle_PagoType_apellidoMaterno").val(apem1);

            }
            extranjeroFecha = 1;

            $("#rebsol_hermesbundle_PagoType_idSexo").val(sexo1);

            $("#rebsol_hermesbundle_PagoType_fechaNacimiento").datepicker('update', fechanacimiento1);

            if (from == 1) {
                $("#rebsol_hermesbundle_PagoType_fechaNacimiento").attr("readonly", true)
            }

            $("#idPersonainput").val(idPersona);
            $("#rebsol_hermesbundle_PagoType_empresaSolicitante").val(empresaSolicitante);
            $("#rebsol_hermesbundle_PagoType_telefonoMovil").val(celu1);
            $("#rebsol_hermesbundle_PagoType_telefonoFijo").val(fijo1);
            $("#rebsol_hermesbundle_PagoType_telefonoTrabajo").val(trabajo1);
            $("#rebsol_hermesbundle_PagoType_correoElectronico").val(mail11);
            $("#user").val(usuario1);
            $("#rebsol_hermesbundle_PagoType_comuna").chosen().change();
            $('#rebsol_hermesbundle_PagoType_comuna').trigger('chosen:updated');
            if (idPais1) {
                $("#rebsol_hermesbundle_PagoType_pais").val(idPais1).delay(200,   choisestyle_pais());
            }
            $("#rebsol_hermesbundle_PagoType_comuna").val(idComuna1).delay(200, choisestyle_comuna());
            $('#rebsol_hermesbundle_PagoType_comuna').trigger("liszt:updated");
            $("#rebsol_hermesbundle_PagoType_direccion").val(direccion1);
            $("#rebsol_hermesbundle_PagoType_numero").val(numero1);
            $("#rebsol_hermesbundle_PagoType_resto").val(resto1);

            verificaGarantia(garantias);

            if (idReservaAtencion) {

                var idPersonaExtrangero = 1;
            } else {
                var idPersonaExtrangero = 0;
                $("#errormsjrut").html(datar);
                accionerror();
            }

            return;
        }

        function BuscaComunaParaFormulario(data) {
            $.ajax({
                type: 'get',
                url: "{{ path('Caja_ProvinciaporComuna') }}",
                data: data,
                success: function (datar) {
                    datar = $.parseJSON(datar);
                    if (datar instanceof Object == false) {
                    } else {
                        accionokadvv();
                        var provincia = datar["0"];
                        var region = datar["1"];
                        var pais = datar["2"];
                        $(".provincia, .provincialabel").slideDown();
                        $(".provincia").html(provincia);
                        $(".region, .regionlabel").slideDown();
                        $(".region").html(region);
                        $(".pais, .paislabel").slideDown();
                        $(".pais").html(pais);
                    }
                }
            });
        }

        function EventoSinDatosEnRegistro(from) {
            //from = 1: Es reserva desde function verificaEstranjero();
            //from = 0: Es reserva desde function validaRut();
            accionok();
            killScroll();
            pasiregioncomunaBusca();
            choisestyle_comuna();
            $('#rebsol_hermesbundle_PagoType_comuna').trigger("liszt:updated");
            $("#buscar, #limpiar, .text-error").hide();
            $(".alertaNoexiste").slideDown();
            $("#buscarPaciente_identificacion").attr("disabled", "disabled");
            $("#buscarPaciente_identificacion").attr("readonly", "readonly");
            $("#rutdv2").val($("#buscarPaciente_identificacion").val());
            if (from == 1) {
                $("#pacienteform").show();
            } else if (from == 0) {
                $("#pacienteform").hide();
            }
            botonesFormPaciente(8, null);
        }

        function IngresaDatosFormReservaExtranjeroRegistrado(from, datar) {

            //from = 1: Es reserva desde function verificaEstranjero();
            //from = 0: Es reserva desde function validaRut();

            accionok();
            killScroll();

            var nombre = datar.nombre;
            var rut = datar.rut;
            var dv = datar.dv;
            var apep = datar.apep;
            var apem = datar.apem;
            var celu = datar.celu;
            var fijo = datar.fijo;
            var trabajo = datar.trabajo;
            var mail1 = datar.mail1;
            usuario = datar.usuario;
            idPersona = datar.idPersona;

            if (datar.fechad) {

                fechad = datar.fechad.date;
            } else {

                fechad = datar.fechad;
            }

            var garantias = datar.garantias;

            if (from == 1) {

                fechanacimiento = CalculaFechaParaDatePicker(datar.fechan);
                var extranjeroID = datar.extranjero;
                var numDocumento = datar.numeroDocumento;
                var sexo = datar.sexo;

                if (extranjeroID != null || extranjeroID != '') {

                    $("#rebsol_hermesbundle_PagoType_documento").val(extranjeroID);
                    $("#rebsol_hermesbundle_PagoType_numeroDocumento").val(numDocumento);
                    $("#spanEsExtranjeroRut").show();
                } else {

                    $("#rebsol_hermesbundle_PagoType_documento").hide();
                    $("#rebsol_hermesbundle_PagoType_numeroDocumento").hide();
                }

                $("#rebsol_hermesbundle_PagoType_idSexo").val(sexo);
                $("#rebsol_hermesbundle_PagoType_fechaNacimiento").datepicker('update', fechanacimiento);


            } else if (from == 0) {

                $(".sinRutDesdeReserva").addClass('hidden').hide();


            } else if (from == 2) {
                //NO APLICA ACCIONES INDIVIDUALES

            }
            if (from == 0 || from == 2) {
                // if (coreApi == 1) {
                    fechanacimiento = CalculaFechaParaDatePicker(datar.fechan);
                    var sexo = datar.sexo;
                    var extranjeroID = datar.extranjero;
                    var numDocumento = datar.numeroDocumento
                // }
                /*if (coreApi != 1) {
                    $('#MascotasCliente').show().append("<i class='icon-spinner icon-spin'></i> <span id='infoCarga'>Buscando Mascotas de Cliente...</span>");
                    var datoPersona = {
                        idPersona: idPersona
                    };
                    $.ajax({
                        type: 'post',
                        url: "{{ path('Caja_Recaudacion_ConsultaMascotas') }}",
                        async: false,
                        data: datoPersona,
                        success: function (respuesta) {
                            if (respuesta.length > 0) {
                                $('#MascotasCliente').html("");
                                $('#MascotasCliente').html(respuesta);
                            } else {
                                $('#MascotasCliente').hide().html("");
                                $('#FormCliente').show();
                            }
                        }
                    });
                }*/

                $('#rebsol_hermesbundle_PrestacionType_prevision').prop('readOnly', false);
                $('#rebsol_hermesbundle_PrestacionType_prevision').prop('disabled', false);

                // if (coreApi == 1) {
                    $("#rebsol_hermesbundle_PagoType_idSexo").val(sexo);
                    $("#rebsol_hermesbundle_PagoType_fechaNacimiento").datepicker('update', fechanacimiento);
                    if (extranjeroID != null || extranjeroID != '') {
                        //tiene ID extranjero
                        $("#rebsol_hermesbundle_PagoType_documento").show();
                        $("#rebsol_hermesbundle_PagoType_numeroDocumento").show();
                        $("#rebsol_hermesbundle_PagoType_documento").val(extranjeroID);
                        $("#rebsol_hermesbundle_PagoType_numeroDocumento").val(numDocumento);
                        $("#spanEsExtranjeroRut").show();
                    } else {
                        $("#rebsol_hermesbundle_PagoType_documento").hide();
                        $("#rebsol_hermesbundle_PagoType_numeroDocumento").hide();
                    }
                // }

                dataReserva = datar.dataReserva;

                if (parseInt($('#rebsol_hermesbundle_PagoType_documento').val()) === 1) {

                    $('#rutdv2').parent().parent().show();
                    $('#rebsol_hermesbundle_PagoType_numeroDocumento').parent().parent().hide();
                } else {

                    $('#rutdv2').parent().parent().hide();
                    $('#rebsol_hermesbundle_PagoType_numeroDocumento').parent().parent().show();
                }
            }


            $("#rebsol_hermesbundle_PagoType_rutPersona").val(rut);
            $("#rebsol_hermesbundle_PagoType_digitoVerifivador").val(dv);
            $("#rutdv2").val(rut + '-' + dv);
            var nombreAux = (nombre != null) ? nombre.toUpperCase() : "";
            $("#rebsol_hermesbundle_PagoType_nombrePnatural").val(nombreAux);
            var apepAux = (apep != null) ? apep.toUpperCase() : "";
            $("#rebsol_hermesbundle_PagoType_apellidoPaterno").val(apepAux);
            var apemAux = (apem != null) ? apem.toUpperCase() : "";
            $("#rebsol_hermesbundle_PagoType_apellidoMaterno").val(apemAux);
            var mailAux = (mail1 != null) ? mail1.toUpperCase() : "";
            $("#rebsol_hermesbundle_PagoType_correoElectronico").val(mailAux);
            $("#rebsol_hermesbundle_PagoType_telefonoMovil").val(celu);
            $("#rebsol_hermesbundle_PagoType_telefonoFijo").val(fijo);
            $("#rebsol_hermesbundle_PagoType_telefonoTrabajo").val(trabajo);
            $("#user").val(usuario);
            $("#idPersonainput").val(idPersona);
            $('#rebsol_hermesbundle_PagoType_comuna').trigger("liszt:updated");
            $(".permitidoTemp").html();
            $("#pacienteform").slideDown(1000);

            verificaGarantia(garantias);

        }

        function CalculaFechaParaDatePicker(datar) {
            var testfecha = datar;
            if (extranjeroFecha == 0) {
                if (testfecha) {
                    var fechan = testfecha.date;
                } else {
                    var fechan = "00000000000000";
                }
            } else {
                fechan = testfecha;
                return fechan;
            }

            if (fechan) {
                var año = fechan.substr(0, 4);
                var mes = fechan.substr(5, 2);
                var dia = fechan.substr(8, 2);
                fechanacimiento = dia + "-" + mes + "-" + año;
            }
            return fechanacimiento;
        }

        function registroDireccion(idCom, dir, num, res) {

            if (idCom != null) {
                $("#rebsol_hermesbundle_PagoType_comuna").chosen().change();
                $('#rebsol_hermesbundle_PagoType_comuna').trigger('chosen:updated');
                $('#rebsol_hermesbundle_PagoType_comuna').val(idCom).delay(200, choisestyle_comuna());
                $('#rebsol_hermesbundle_PagoType_comuna').trigger("liszt:updated");
            } else {
                $('#rebsol_hermesbundle_PagoType_comuna').parent().find('i').removeClass('green icon-ok').addClass('icon-asterisk');
            }


            $("#rebsol_hermesbundle_PagoType_direccion").val(dir);
            $("#rebsol_hermesbundle_PagoType_numero").val(num);
            $("#rebsol_hermesbundle_PagoType_resto").val(res);
        }

        function registroDireccionDataReserva(datar) {
            var direccion = datar.direccion;
            var numero = datar.numero;
            var resto = datar.resto;
            var comun = datar.idComuna;
            $("#rebsol_hermesbundle_PagoType_direccion").val(direccion);
            $("#rebsol_hermesbundle_PagoType_numero").val(numero);
            $("#rebsol_hermesbundle_PagoType_resto").val(resto);
            pasiregioncomunaBuscaconIdDataReserva(comun);
        }

        function ObtieneDomicilioIdPersona(data) {
            $.ajax({
                type: 'get',
                url: "{{ path('Caja_Recaudacion_Pago_ObtieneDomicilio') }}",
                async: false,
                data: data,
                success: function (datar) {
                    datar = $.parseJSON(datar);
                    if (datar !== "") {
                        if (datar instanceof Object == false) {
                            var append = $("#rebsol_hermesbundle_PagoType_comuna").closest(".input-append").children('span').children('i');
                            append.removeClass(' icon-spinner icon-spin green icon-remove red  icon-large');
                            append.addClass('icon-asterisk');
                        } else {
                            var direccion = datar.direccion;
                            var numero = datar.numero;
                            var resto = datar.resto;
                            var comuna = datar.comuna;
                            var pais = datar.pais;
                            registroDireccion(null, direccion, numero, resto);
                            if (validaComunaPais(pais, comuna,$('#rebsol_hermesbundle_PagoType_documento').val())) {

                                if (habilitarPaisExtranjero && ($('#rebsol_hermesbundle_PagoType_documento').val() == 2 || $('#rebsol_hermesbundle_PagoType_documento').val() == 4)) {
                                    $("#rebsol_hermesbundle_PagoType_pais").val(pais);
                                } else {
                                    pasiregioncomunaBuscaconId(comuna, fechad);
                                    $("#rebsol_hermesbundle_PagoType_comuna").val(comuna);
                                }
                                habilitarPaisComuna($('#rebsol_hermesbundle_PagoType_documento').val());
                            } else {
                                if (habilitarPaisExtranjero && ($('#rebsol_hermesbundle_PagoType_documento').val() == 2 || $('#rebsol_hermesbundle_PagoType_documento').val() == 4)) {
                                    var append = $("#rebsol_hermesbundle_PagoType_pais").closest(".input-append").children('span').children('i');
                                    append.removeClass(' icon-spinner icon-spin green icon-remove red  icon-large');
                                    append.addClass('icon-asterisk');
                                    $("#rebsol_hermesbundle_PagoType_pais").val(pais);
                                } else {
                                    var append = $("#rebsol_hermesbundle_PagoType_comuna").closest(".input-append").children('span').children('i');
                                    append.removeClass(' icon-spinner icon-spin green icon-remove red  icon-large');
                                    append.addClass('icon-asterisk');
                                    // validaDatosCompletos(fechad);
                                    $("#rebsol_hermesbundle_PagoType_comuna").val(comuna);
                                }
                                habilitarPaisComuna($('#rebsol_hermesbundle_PagoType_documento').val());
                            }
                        }
                    }
                }
            });
        }

        function disabledReadOnlyCampos() {
            $("#rutdv2").val($("#buscarPaciente_identificacion").val());
            $(" #rutdv, #rutdv2, .permitidoUserNuervo," +
                " #rebsol_hermesbundle_PagoType_fechaNacimiento," +
                " #rebsol_hermesbundle_PagoType_idSexo," +
                " #rebsol_hermesbundle_PagoType_documento," +
                " #rebsol_hermesbundle_PagoType_numeroDocumento").attr("disabled", "disabled");
            $(" #rutdv, #rutdv2, .permitidoUserNuervo," +
                " #rebsol_hermesbundle_PagoType_fechaNacimiento," +
                " #rebsol_hermesbundle_PagoType_idSexo," +
                " #rebsol_hermesbundle_PagoType_documento," +
                " #rebsol_hermesbundle_PagoType_numeroDocumento").attr("readonly", "readonly");
            $("#rebsol_hermesbundle_PagoType_comuna").addClass("chosen-select");
            PermiteCamposenFormulario();
            pasiregioncomunaBusca();
            if (!fechad) {
                $(".btn-volver2").hide();
            } else {
                fallecido(fechad);
            }
        }

        function disabledReadOnlyCamposNuevoRegistro() {
            $("#rutdv2").val($("#buscarPaciente_identificacion").val());
            $(" #rutdv, #rutdv2," +
                " #rebsol_hermesbundle_PagoType_documento," +
                " #rebsol_hermesbundle_PagoType_numeroDocumento").attr("disabled", "disabled");
            $(" #rutdv, #rutdv2," +
                " #rebsol_hermesbundle_PagoType_documento," +
                " #rebsol_hermesbundle_PagoType_numeroDocumento").attr("readonly", "readonly");
            $("#rebsol_hermesbundle_PagoType_comuna").addClass("chosen-select");
            if ($("#rebsol_hermesbundle_PagoType_numeroDocumento").val() == '') {
                $("#rebsol_hermesbundle_PagoType_numeroDocumento, #rebsol_hermesbundle_PagoType_documento").hide();
            }
        }

        function botonesFormPaciente(from, fechad) {

            if (!fechad) {

                if ($("#idPersonainput").val() == '' || $("#idPersonainput").val() == null) {
                    if (from == 8) {
                        disabledReadOnlyCamposNuevoRegistro();
                    }
                    botonesFormPacienteNoFullDatos(from);
                } else {
                    // if(from == 7){
                    //     botonesFormPacienteNoFullDatos(from);
                    // }
                    if ($("#rebsol_hermesbundle_PagoType_telefonoMovil").val() == "" &&
                        $("#rebsol_hermesbundle_PagoType_telefonoFijo").val() == "" &&
                        $("#rebsol_hermesbundle_PagoType_telefonoTrabajo").val() == ""
                    ) {
                        botonesFormPacienteNoFullDatos(from);
                    } else {
                        if (from == 9) {
                            $(".btnCargaFormPaciente").hide();
                            $(".btn-salvar-edit, #btnbackfromedit").show();

                        } else if (from == 10) {
                            $(".btnCargaFormPaciente").hide();
                            $(".btn-salvar-edit, #btnbackfromedit").show();
                        }

                        if (from != 9 && from != 10) {
                            disabledReadOnlyCampos();
                            $(".alertaExisteDatos").hide();
                            $(".alertaExisteFullDatos").slideDown(900);
                        }
                    }
                }
            } else {
                botonesFormPacienteNoFullDatos(from);
            }

            setTimeout(function () {
                if ($("#rebsol_hermesbundle_PagoType_comuna").val() == null) {
                    $('#rebsol_hermesbundle_PagoType_comuna').parent().find('i').removeClass('green icon-ok').addClass('icon-asterisk');
                }
            }, 1000);
        }

        function verificaGarantia(garantias) {
            if (garantias >= 1) {
                $(".infoTieneGarantia").show();
                $("#numeroGarantiasSinRegularizar").html(garantias);
                if (garantias > 1) {
                    $(".usoPluralGarantia").html("s");
                }
            }
        }

        function botonesFormPacienteNoFullDatos(from) {
            $(".alertaExisteDatos").slideDown(900);
            //CASO: 8 = usuarios nuevos
            //CASO: 3 = Desde Agenda Reserva
            //CASO: 4 = Viene desde Agenda, reserva, no tiene rut ni OTRO.
            //CASO: 7 = es nuevo, sin rut, y debe tener habilitado los campos
            switch (from) {
                case 7:
                    $(".btn-salvar").show();
                    $("#btnback").show();
                    $(".disableFieldsStandar").attr('disabled', false);
                    $(".disableFieldsStandar").attr('readOnly', false);
                    break;
                case 8:
                    $(".btn-salvar").show();
                    $("#volver-desde-formulario-paciente").show();
                    break;
                case 4:
                    $(".btn-salvar").show();
                    break;
                case 3:
                    $(".btn-salvar").show();
                    break;
            }
        }
    </script>

{% endmacro %}

{% macro BusquedaAvanzada() %}
    <script type='text/javascript'>
        //funcion AJAX, envia rut, lo comprueba en el servidor, y devuelve si encuentra datos, los datos del relacionado desde la tabla PERSONA  y PNATURAL
        function Validainfo() {
            var apep = $("#ApellidoP").val();
            var apem = $("#ApellidoM").val();
            var adv = {apep: apep, apem: apem};
            $.ajax({
                type: 'get',
                url: "{{ path('Caja_Recaudacion_Pago_Avanzada') }}",
                data: adv,
                success: function (datar) {
                    datar = $.parseJSON(datar);

                    if (datar == "no") {
                        //Pasa a crear un nuevo Usuario desde aqui.
                        $("#buscaradv").hide();
                        $("#limpiaradv").hide();
                        $(".alertaNoexisteadv").slideDown();
                        var append = $("#ApellidoP").closest(".input-append").children('span').children('i');
                        append.removeClass('icon-spinner icon-spin add-on dark-opaque icon-asterisk');
                        append.addClass('icon-asterisk');
                        var append = $("#ApellidoM").closest(".input-append").children('span').children('i');
                        append.removeClass('icon-spinner icon-spin add-on dark-opaque green icon-asterisk');
                        append.addClass('icon-asterisk');
                        $("#rebsol_hermesbundle_PagoType_apellidoPaterno").val(apep);
                        $("#rebsol_hermesbundle_PagoType_apellidoMaterno").val(apem);
                        killScroll();
                        pasiregioncomunaBusca();
                        choisestyle_comuna();
                        //Pasa a crear un nuevo Usuario hasta aqui.
                    }
                    if (datar == "muchos") {
                        //recibe muchos
                        $("#listapacienteform").load(location.href + " #listapacienteform");
                        $('#divCarga').slideDown(500);
                        var apep = $("#ApellidoP").val();
                        var apem = $("#ApellidoM").val();
                        //si encuentra muchos resultados, envia una nueva petición ajax, solicitando todos los resultados para poder recorrerlos y mostrarlos en listado
                        var muchos = {apep: apep, apem: apem};
                        $.ajax({
                            type: 'get',
                            url: "{{ path('Caja_Recaudacion_Pago_ObtieneDatosNUsuarios') }}",
                            //async: false,
                            data: muchos,
                            success: function (muchos) {
                                $('#divCarga').slideDown();
                                $("#listapacienteform").html(muchos);
                                $('#listapacienteform').slideDown();
                                $('.show').on('click', function () {
                                    var idpaciente = $(this).closest('tr').attr('id');
                                    buscaUNusuarioporIdPersona(idpaciente);
                                });
                            }
                        });
                    }
                }
            });
        }

        function buscaUNusuarioporIdPersona(idpaciente) {
            $("#listapacienteform").slideUp(500);
            $("#resultadosBusquedaAvanzadaPaciente").slideUp(500);
            $("#listapacienteform").load(location.href + " #listapacienteform");
            var data = {idpaciente: idpaciente};
            $.ajax({
                type: 'get',
                url: "{{ path('Caja_Recaudacion_Pago_ObtieneDatosUnUsuario') }}",
                data: data,
                success: function (datar) {
                    datar = $.parseJSON(datar);
                    if (datar instanceof Object == false) {
                        EventoSinDatosEnRegistro(1);
                        //paciente nuevo, aparecer formulario sin datos y mensaje que paciente es nuevo
                    } else {
                        //paciente existente, cargar los datos del paciente, y mostrar formulario
                        // var rut = datar.rut;
                        // var dv = datar.dv;
                        $("#buscarPaciente_tipoIdentificacion").val(datar.extranjero);
                        $("#buscarPaciente_identificacion").val(datar.numeroDocumento);
                        ValidaRut();
                    }
                }
            });
        }
    </script>
{% endmacro %}

{% macro funcionGuardar() %}
    <script type='text/javascript'>

        const validaComunaPais = (pais, comuna, tipoIdentificacion) => {
            let bValidacion = false;

            if (habilitarPaisExtranjero == 1 && (tipoIdentificacion == 2 || tipoIdentificacion == 4)) {
                if (pais != null) {
                    bValidacion = true;
                }
            } else {
                if (comuna != null) {
                    bValidacion = true;
                }
            }
            return bValidacion;
        }

        function guardar() {


            if ($("#rebsol_hermesbundle_PagoType_numeroDocumento").is(":disabled") &&
                $("#rebsol_hermesbundle_PagoType_numeroDocumento").val() === '' &&
                $("#rebsol_hermesbundle_PagoType_numeroDocumento").is(":visible") &&
                $("#rebsol_hermesbundle_PagoType_documento").is(":disabled") &&
                $("#rebsol_hermesbundle_PagoType_documento").val() === '' &&
                $("#rebsol_hermesbundle_PagoType_documento").is(":visible") &&
                $("#rutdv2").val() === '' && $("#rutdv2").is(":visible") && $("#rutdv2").is(":disabled")) {

                $('.rutdv2val, .numdocval, .docval').slideDown(500);

                return;

            }

            console.log('funcionGuardar')

            //if (coreApi == 1) {

                if ($("#rebsol_hermesbundle_PagoType_rutPersona").val() === '' || $("#rebsol_hermesbundle_PagoType_digitoVerifivador").val() === '') {

                    if ($("#rutdv2").val() !== '') {

                        var rdv = $("#rutdv2").val();
                        var largo = rdv.length;
                        var r = $("#rutdv2").val().substr(0, largo - 1);
                        var dv = $("#rutdv2").val().substr(largo - 1, largo);

                        $("#rebsol_hermesbundle_PagoType_rutPersona").val(r);
                        $("#rebsol_hermesbundle_PagoType_digitoVerifivador").val(dv);
                    }

                    var sinRut = 1;

                } else {

                    var sinRut = 0;
                }

                var nombre = $('#rebsol_hermesbundle_PagoType_nombrePnatural').val();
                var apep = $('#rebsol_hermesbundle_PagoType_apellidoPaterno').val();
                var apem = $('#rebsol_hermesbundle_PagoType_apellidoMaterno').val();
                var sexo = $('#rebsol_hermesbundle_PagoType_idSexo').val();
                var fecha = $('#rebsol_hermesbundle_PagoType_fechaNacimiento').val();
                var cel = $('#rebsol_hermesbundle_PagoType_telefonoMovil').val();
                var fijo = $('#rebsol_hermesbundle_PagoType_telefonoFijo').val();
                var trabajo = $('#rebsol_hermesbundle_PagoType_telefonoTrabajo').val();
                var direccion = $('#rebsol_hermesbundle_PagoType_direccion').val();
                var comuna = $('#rebsol_hermesbundle_PagoType_comuna').val();
                var numero = $('#rebsol_hermesbundle_PagoType_numero').val();
                var pais = $('#rebsol_hermesbundle_PagoType_pais').val();

                var rut = $('#rebsol_hermesbundle_PagoType_rutPersona').val();
                var dv = $('#rebsol_hermesbundle_PagoType_digitoVerifivador').val();

                var documentoExtranjero = $('#rebsol_hermesbundle_PagoType_numeroDocumento').val();
                var tipoDocumentoExtranjero = $('#rebsol_hermesbundle_PagoType_documento').val();

                var documentoPorDefecto = rut + '-' + dv;

                if (tipoDocumentoExtranjero == 1) {

                    documentoPorDefecto = documentoPorDefecto;
                } else {

                    documentoPorDefecto = documentoExtranjero;
                }

                if ((rut && dv) || (documentoExtranjero && tipoDocumentoExtranjero)) {

                } else {
                    validaConstraint();
                    return;
                }

                if (nombre && apep && sexo && fecha && validaComunaPais(pais, comuna, tipoDocumentoExtranjero) && direccion && numero && (cel || fijo || trabajo)) {
                    if ($("#rebsol_hermesbundle_PagoType_correoElectronico").val()) {
                        if (validarEmail($("#rebsol_hermesbundle_PagoType_correoElectronico").val())) {
                            $(".emailvalida").slideDown(500);
                            return false;
                        }
                    }
                    $(".emailvalida").slideUp(500);
                    if ($("#idPersonainput").val() == "") {

                        if (verificaRutDocumentoExtranjeroexiste == 1 && crearUsuarioSinRut == 1) {
                            GuardarSinRut();
                            return;

                        }

                        if (verificaRutDocumentoExtranjeroexiste == 1 && crearUsuarioSinRut == 0) {
                            CrearSinRut();
                            return;
                        }

                        $.ajax({
                            type: 'get',
                            url: "{{ path('Caja_CreaPaciente') }}",
                            data: {
                                rut: $("#rebsol_hermesbundle_PagoType_rutPersona").val(),
                                dv: $("#rebsol_hermesbundle_PagoType_digitoVerifivador").val(),
                                nombre: $("#rebsol_hermesbundle_PagoType_nombrePnatural").val(),
                                apep: $("#rebsol_hermesbundle_PagoType_apellidoPaterno").val(),
                                apem: $("#rebsol_hermesbundle_PagoType_apellidoMaterno").val(),
                                sexo: $("#rebsol_hermesbundle_PagoType_idSexo").val(),
                                fecha: $("#rebsol_hermesbundle_PagoType_fechaNacimiento").val(),
                                cel: $("#rebsol_hermesbundle_PagoType_telefonoMovil").val(),
                                fijo: $("#rebsol_hermesbundle_PagoType_telefonoFijo").val(),
                                email: $("#rebsol_hermesbundle_PagoType_correoElectronico").val(),
                                trabajo: $("#rebsol_hermesbundle_PagoType_telefonoTrabajo").val(),
                                direccion: $("#rebsol_hermesbundle_PagoType_direccion").val(),
                                numero: $("#rebsol_hermesbundle_PagoType_numero").val(),
                                resto: $("#rebsol_hermesbundle_PagoType_resto").val(),
                                comuna: $("#rebsol_hermesbundle_PagoType_comuna").val(),
                                pais: $('#rebsol_hermesbundle_PagoType_pais').val(),
                                sinRut: sinRut,
                                idReserva: idReservaAtencion,
                                extranjero: extranjero,
                                identificacion: identificacion,
                                tipoIdentificacion: $("#rebsol_hermesbundle_PagoType_documento").val()
                            },
                            success: function (datar) {

                                datar = $.parseJSON(datar);

                                if (datar !== "falta") {

                                    if (datar === "ok") {

                                        var creado = "" +
                                            "<div class='alert alert-block alert-success'>" +
                                            " <p>" +
                                            " <strong><i class='icon-ok'></i> Objeto creado exitosamente!</strong>" +
                                            " </p>" +
                                            "</div>";
                                        bootbox.dialog(creado, [{
                                            "label": "Ok",
                                            "class": "btn btn-mini btn-info"
                                        }]);

                                        $.ajax({
                                            type: 'get',
                                            url: "{{ path('Caja_ConsultaPacienteIdPnatural') }}",
                                            data: {
                                                tipoDocumentoExtranjero: tipoDocumentoExtranjero,
                                                documentoPorDefecto: documentoPorDefecto
                                            },
                                            success: function (datar) {
                                            },
                                            error: function (datar) {
                                                falla();
                                            }
                                        });

                                        post_create_update();
                                    } else {
                                        if (idReservaAtencion) {

                                            $("#rebsol_hermesbundle_PagoType_rutPersona").val("");
                                            $("#rebsol_hermesbundle_PagoType_digitoVerifivador").val("");
                                        }
                                        $(".errorfalla").slideDown("slow");
                                        setTimeout(function () {
                                            $(".errorfalla").slideUp("slow");
                                        }, 6000);
                                    }
                                } else {

                                    if (idReservaAtencion) {

                                        $("#rebsol_hermesbundle_PagoType_rutPersona").val("");
                                        $("#rebsol_hermesbundle_PagoType_digitoVerifivador").val("");
                                    }
                                    validaConstraint();
                                }
                            },
                            error: function (datar) {
                                if (idReservaAtencion) {
                                    $("#rebsol_hermesbundle_PagoType_rutPersona").val("");
                                    $("#rebsol_hermesbundle_PagoType_digitoVerifivador").val("");
                                }
                                $(".btn-salvar, .btn-salvar-edit").css('pointer-events', 'auto');
                                falla();
                            }
                        });
                    } else {
                        if (verificaRutDocumentoExtranjeroexiste == 1 && crearUsuarioSinRut == 1) {
                            GuardarSinRut();

                            return;
                        }
                        if (verificaRutDocumentoExtranjeroexiste == 1 && crearUsuarioSinRut == 0) {
                            CrearSinRut();
                            return;
                        }
                        if (verificaRutDocumentoExtranjeroexiste == 0 && crearUsuarioSinRut == 0) {
                            GuardarEdit();
                            return;
                        }
                    }
                } else {
                    $(".btn-salvar, .btn-salvar-edit").css('pointer-events', 'auto');
                    validaConstraint();
                }

                $(".btn-salvar, .btn-salvar-edit").css('pointer-events', 'auto');
                /*} else {

                    if ($("#rebsol_hermesbundle_PagoType_rutPersona").val() === '' || $("#rebsol_hermesbundle_PagoType_digitoVerifivador").val() === '') {
                        if ($("#rutdv2").val() !== '') {
                            var rdv = $("#rutdv2").val();
                            var largo = rdv.length;
                            var r = $("#rutdv2").val().substr(0, largo - 1);
                            var dv = $("#rutdv2").val().substr(largo - 1, largo);
                            $("#rebsol_hermesbundle_PagoType_rutPersona").val(r);
                            $("#rebsol_hermesbundle_PagoType_digitoVerifivador").val(dv);
                        }
                        var sinRut = 1;
                    } else {
                        var sinRut = 0;
                    }

                    var rut = $("#rebsol_hermesbundle_PagoType_rutPersona").val();
                    var dv = $("#rebsol_hermesbundle_PagoType_digitoVerifivador").val();
                    var nombre = $("#rebsol_hermesbundle_PagoType_nombrePnatural").val();
                    var apep = $("#rebsol_hermesbundle_PagoType_apellidoPaterno").val();
                    var apem = $("#rebsol_hermesbundle_PagoType_apellidoMaterno").val();
                    var cel = $("#rebsol_hermesbundle_PagoType_telefonoMovil").val();
                    var fijo = $("#rebsol_hermesbundle_PagoType_telefonoFijo").val();
                    var trabajo = $("#rebsol_hermesbundle_PagoType_telefonoTrabajo").val();
                    var direccion = $("#rebsol_hermesbundle_PagoType_direccion").val();
                    var numero = $("#rebsol_hermesbundle_PagoType_numero").val();
                    var comuna = $("#rebsol_hermesbundle_PagoType_comuna").val();
                    var pais = $("#rebsol_hermesbundle_PagoType_pais").val();
                    var tipoDocumentoExtranjero = $('#rebsol_hermesbundle_PagoType_documento').val();

                    if (rut && dv && nombre && apep && validaComunaPais(pais, comuna, tipoDocumentoExtranjero) && (cel || fijo || trabajo) && direccion && numero) {
                        if ($("#rebsol_hermesbundle_PagoType_correoElectronico").val()) {
                            if (validarEmail($("#rebsol_hermesbundle_PagoType_correoElectronico").val())) {
                                $(".emailvalida").slideDown(500);
                                return false;
                            }
                        }
                        $(".emailvalida").slideUp(500);
                        if ($("#idPersonainput").val() == "") {
                            if (verificaRutDocumentoExtranjeroexiste == 1 && crearUsuarioSinRut == 1) {
                                GuardarSinRut();
                                return;
                            }
                            if (verificaRutDocumentoExtranjeroexiste == 1 && crearUsuarioSinRut == 0) {
                                CrearSinRut();
                                return;
                            }

                            $.ajax({
                                type: 'get',
                                url: "{{ path('Caja_CreaPacienteApi') }}",
                            data: {
                                rut: $("#rebsol_hermesbundle_PagoType_rutPersona").val(),
                                dv: $("#rebsol_hermesbundle_PagoType_digitoVerifivador").val(),
                                nombre: $("#rebsol_hermesbundle_PagoType_nombrePnatural").val(),
                                apep: $("#rebsol_hermesbundle_PagoType_apellidoPaterno").val(),
                                apem: $("#rebsol_hermesbundle_PagoType_apellidoMaterno").val(),
                                cel: $("#rebsol_hermesbundle_PagoType_telefonoMovil").val(),
                                fijo: $("#rebsol_hermesbundle_PagoType_telefonoFijo").val(),
                                email: $("#rebsol_hermesbundle_PagoType_correoElectronico").val(),
                                trabajo: $("#rebsol_hermesbundle_PagoType_telefonoTrabajo").val(),
                                direccion: $("#rebsol_hermesbundle_PagoType_direccion").val(),
                                numero: $("#rebsol_hermesbundle_PagoType_numero").val(),
                                resto: $("#rebsol_hermesbundle_PagoType_resto").val(),
                                comuna: $("#rebsol_hermesbundle_PagoType_comuna").val(),
                                pais: $('#rebsol_hermesbundle_PagoType_pais').val(),

                            },
                            success: function (datar) {
                                datar = $.parseJSON(datar);
                                if (datar !== "falta") {
                                    if (datar === "ok") {
                                        var creado = "" +
                                            "<div class='alert alert-block alert-success'>" +
                                            " <p>" +
                                            " <strong><i class='icon-ok'></i> Objeto creado exitosamente!</strong>" +
                                            " </p>" +
                                            "</div>";
                                        bootbox.dialog(creado, [{
                                            "label": "Ok",
                                            "class": "btn btn-mini btn-info"
                                        }]);

                                        $.ajax({
                                            type: 'get',
                                            url: "{{ path('Caja_ConsultaPacienteIdPnatural') }}",
                                            data: {
                                                tipoDocumentoExtranjero: tipoDocumentoExtranjero,
                                                documentoPorDefecto: documentoPorDefecto
                                            },
                                            success: function (datar) {
                                            },
                                            error: function (datar) {
                                                falla();
                                            }
                                        });


                                        post_create_updateApi1();
                                    } else {
                                        if (idReservaAtencion) {
                                            $("#rebsol_hermesbundle_PagoType_rutPersona").val("");
                                            $("#rebsol_hermesbundle_PagoType_digitoVerifivador").val("");
                                        }
                                        $(".errorfalla").slideDown("slow");
                                        setTimeout(function () {
                                            $(".errorfalla").slideUp("slow");
                                        }, 6000);
                                    }
                                } else {
                                    if (idReservaAtencion) {
                                        $("#rebsol_hermesbundle_PagoType_rutPersona").val("");
                                        $("#rebsol_hermesbundle_PagoType_digitoVerifivador").val("");
                                    }
                                    $(".btn-salvar, .btn-salvar-edit").css('pointer-events', 'auto');
                                    validaConstraintApi();
                                }
                            },
                            error: function (datar) {
                                if (idReservaAtencion) {
                                    $("#rebsol_hermesbundle_PagoType_rutPersona").val("");
                                    $("#rebsol_hermesbundle_PagoType_digitoVerifivador").val("");
                                }
                                $(".btn-salvar, .btn-salvar-edit").css('pointer-events', 'auto');
                                falla();
                            }
                        });
                    } else {

                        if (verificaRutDocumentoExtranjeroexiste == 1 && crearUsuarioSinRut == 1) {
                            GuardarSinRut();
                            return;
                        }
                        if (verificaRutDocumentoExtranjeroexiste == 1 && crearUsuarioSinRut == 0) {
                            CrearSinRut();
                            return;
                        }
                        if (verificaRutDocumentoExtranjeroexiste == 0 && crearUsuarioSinRut == 0) {
                            GuardarEdit();
                            return;
                        }

                    }

                } else {
                    validaConstraintApi();
                }
                $(".btn-salvar, .btn-salvar-edit").css('pointer-events', 'auto');
            }*/

        }

        function CrearSinRut() {
            GuardarSinRut();
        }

        function GuardarSinRut() {

            if ($("#rebsol_hermesbundle_PagoType_rutPersona").val() === '' || $("#rebsol_hermesbundle_PagoType_digitoVerifivador").val() === '') {
                if ($("#rutdv2").val() !== '') {
                    var rdv = $("#rutdv2").val();
                    var largo = rdv.length;
                    var r = $("#rutdv2").val().substr(0, largo - 1);
                    var dv = $("#rutdv2").val().substr(largo - 1, largo);
                    $("#rebsol_hermesbundle_PagoType_rutPersona").val(r);
                    $("#rebsol_hermesbundle_PagoType_digitoVerifivador").val(dv);
                }
                var sinRut = 1;
            } else {
                var sinRut = 0;
            }

            var rut = $("#rebsol_hermesbundle_PagoType_rutPersona").val();
            var dv = $("#rebsol_hermesbundle_PagoType_digitoVerifivador").val();
            var nombre = $("#rebsol_hermesbundle_PagoType_nombrePnatural").val();
            var apep = $("#rebsol_hermesbundle_PagoType_apellidoPaterno").val();
            var apem = $("#rebsol_hermesbundle_PagoType_apellidoMaterno").val();
            var sexo = $("#rebsol_hermesbundle_PagoType_idSexo").val();
            var fecha = $("#rebsol_hermesbundle_PagoType_fechaNacimiento").val();
            var cel = $("#rebsol_hermesbundle_PagoType_telefonoMovil").val();
            var fijo = $("#rebsol_hermesbundle_PagoType_telefonoFijo").val();
            var trabajo = $("#rebsol_hermesbundle_PagoType_telefonoTrabajo").val();
            var direccion = $("#rebsol_hermesbundle_PagoType_direccion").val();
            var comuna = $("#rebsol_hermesbundle_PagoType_comuna").val();
            var numero = $("#rebsol_hermesbundle_PagoType_numero").val();
            var pais = $("#rebsol_hermesbundle_PagoType_pais").val();

            var documentoExtranjero = $("#rebsol_hermesbundle_PagoType_numeroDocumento").val();
            var tipoDocumentoExtranjero = $("#rebsol_hermesbundle_PagoType_documento").val();


            var documentoPorDefecto = rut + '-' + dv;

            if (tipoDocumentoExtranjero == 1) {

                documentoPorDefecto = documentoPorDefecto;
            } else {

                documentoPorDefecto = documentoExtranjero;
            }

            if ((rut && dv) || (documentoExtranjero && tipoDocumentoExtranjero)) {

            } else {
                validaConstraint();
                return;
            }

            if (validaComunaPais(pais, comuna, tipoDocumentoExtranjero) && nombre && apep && sexo && fecha && (cel || fijo || trabajo) && direccion && numero) {
                if ($("#rebsol_hermesbundle_PagoType_correoElectronico").val()) {
                    if (validarEmail($("#rebsol_hermesbundle_PagoType_correoElectronico").val())) {
                        $(".emailvalida").slideDown(500);
                        return false;
                    }
                }
                $(".emailvalida").slideUp(500);

                var data = {
                    rut: $("#rebsol_hermesbundle_PagoType_rutPersona").val(),
                    dv: $("#rebsol_hermesbundle_PagoType_digitoVerifivador").val(),
                    nombre: $("#rebsol_hermesbundle_PagoType_nombrePnatural").val(),
                    apep: $("#rebsol_hermesbundle_PagoType_apellidoPaterno").val(),
                    apem: $("#rebsol_hermesbundle_PagoType_apellidoMaterno").val(),
                    sexo: $("#rebsol_hermesbundle_PagoType_idSexo").val(),
                    fecha: $("#rebsol_hermesbundle_PagoType_fechaNacimiento").val(),
                    cel: $("#rebsol_hermesbundle_PagoType_telefonoMovil").val(),
                    fijo: $("#rebsol_hermesbundle_PagoType_telefonoFijo").val(),
                    email: $("#rebsol_hermesbundle_PagoType_correoElectronico").val(),
                    trabajo: $("#rebsol_hermesbundle_PagoType_telefonoTrabajo").val(),
                    direccion: $("#rebsol_hermesbundle_PagoType_direccion").val(),
                    numero: $("#rebsol_hermesbundle_PagoType_numero").val(),
                    resto: $("#rebsol_hermesbundle_PagoType_resto").val(),
                    comuna: $("#rebsol_hermesbundle_PagoType_comuna").val(),
                    pais: $("#rebsol_hermesbundle_PagoType_pais").val(),
                    sinRut: sinRut,
                    extranjero: extranjero,
                    documentoExtranjero: documentoExtranjero,
                    tipoDocumentoExtranjero: tipoDocumentoExtranjero,
                    identificacion: identificacion,
                    idPersona: $("#idPersonainput").val(),
                    idReserva: idReservaAtencion
                };
                $("#idPersonainput").val(),

                $.ajax({
                    type: 'get',
                    url: "{{ path('Caja_ActualizaPacienteSinRut') }}",
                    data: data,
                    success: function (datar) {
                        datar = $.parseJSON(datar);
                        if (datar !== "falta") {
                            if (datar === "ok") {
                                var creado = "" +
                                    "<div class='alert alert-block alert-success'>" +
                                    " <p>" +
                                    " <strong><i class='icon-ok'></i> Objeto creado exitosamente!</strong>" +
                                    " </p>" +
                                    "</div>";
                                bootbox.dialog(creado, [{
                                    "label": "Ok",
                                    "class": "btn btn-mini btn-info"
                                }]);
                                $.ajax({
                                    type: 'get',
                                    url: "{{ path('Caja_ConsultaPacienteIdPnatural') }}",
                                    data: {
                                        tipoDocumentoExtranjero: tipoDocumentoExtranjero,
                                        documentoPorDefecto: documentoPorDefecto
                                    },
                                    success: function (datar) {
                                    },
                                    error: function (datar) {
                                        falla();
                                    }
                                });

                                post_create_update();


                            } else {

                                if (idReservaAtencion) {
                                    $("#rebsol_hermesbundle_PagoType_rutPersona").val("");
                                    $("#rebsol_hermesbundle_PagoType_digitoVerifivador").val("");
                                }


                                $(".errorfalla").slideDown("slow");
                                setTimeout(function () {
                                    $(".errorfalla").slideUp("slow");
                                }, 6000);
                            }
                        } else {

                            if (idReservaAtencion) {
                                $("#rebsol_hermesbundle_PagoType_rutPersona").val("");
                                $("#rebsol_hermesbundle_PagoType_digitoVerifivador").val("");
                            }
                            $(".btn-salvar, .btn-salvar-edit").css('pointer-events', 'auto');
                            validaConstraint();
                        }

                    },
                    error: function (datar) {
                        if (idReservaAtencion) {
                            $("#rebsol_hermesbundle_PagoType_rutPersona").val("");
                            $("#rebsol_hermesbundle_PagoType_digitoVerifivador").val("");
                        }
                        $(".btn-salvar, .btn-salvar-edit").css('pointer-events', 'auto');
                        falla();
                    }
                });
            } else {
                $(".btn-salvar, .btn-salvar-edit").css('pointer-events', 'auto');
                validaConstraint();
            }
        }


        function GuardarEdit() {
            if ($("#idPersonainput").val() == '' || $("#idPersonainput").val() == null) {
                guardar();
                return;
            }
            if (habilitarPaisExtranjero && ($('#rebsol_hermesbundle_PagoType_documento').val() == 2 || $('#rebsol_hermesbundle_PagoType_documento').val() == 4)) {
                if ($("#rebsol_hermesbundle_PagoType_pais").val() == null) {
                    validaConstraint();
                    return;
                }
            } else {
                if ($("#rebsol_hermesbundle_PagoType_comuna").val() == null) {
                    validaConstraint();
                    return;
                }
            }
            if (coreApi == 1) {
                var data = {
                    cel: $("#rebsol_hermesbundle_PagoType_telefonoMovil").val(),
                    fijo: $("#rebsol_hermesbundle_PagoType_telefonoFijo").val(),
                    email: $("#rebsol_hermesbundle_PagoType_correoElectronico").val(),
                    trabajo: $("#rebsol_hermesbundle_PagoType_telefonoTrabajo").val(),
                    direccion: $("#rebsol_hermesbundle_PagoType_direccion").val(),
                    numero: $("#rebsol_hermesbundle_PagoType_numero").val(),
                    resto: $("#rebsol_hermesbundle_PagoType_resto").val(),
                    comuna: $("#rebsol_hermesbundle_PagoType_comuna").val(),
                    idPersona: $("#idPersonainput").val(),
                    idReserva: idReservaAtencion,
                    pais: $("#rebsol_hermesbundle_PagoType_pais").val(),
                    tipoDocumentoExtranjero: $('#rebsol_hermesbundle_PagoType_documento').val()
                };
                $.ajax({
                    type: 'get',
                    url: "{{ path('Caja_ActualizaPaciente') }}",
                    data: data,
                    success: function (datar) {
                        datar = $.parseJSON(datar);
                        if (datar !== "falta") {
                            if (datar !== "ok") {
                                $(".errorfalla").slideDown("slow");
                                setTimeout(function () {
                                    $(".errorfalla").slideUp("slow");
                                }, 6000);
                            } else {
                                $('#backdropBootboxVentanaEdicionReserva').css('z-index', 1050);
                                console.log('antes')
                                var update = "" +
                                    "<div class='alert alert-block alert-success'>" +
                                    " <p>" +
                                    " <strong><i class='icon-ok'></i> Objeto editado exitosamente!</strong>" +
                                    " </p>" +
                                    "</div>";
                                bootbox.dialog(update, [{
                                    "label": "Ok",
                                    "class": "btn btn-mini btn-info",
                                    "callback": function() {
                                        console.log('despues')
                                        $('#backdropBootboxVentanaEdicionReserva').css('z-index', 1040);
                                    }
                                }]);
                                post_create_update();
                            }
                        } else {
                            validaConstraint();
                        }
                    },
                    error: function (datar) {
                        falla();
                    }
                });
                $(".btn-salvar, .btn-salvar-edit").css('pointer-events', 'auto');
            } else {

                var data = {
                    cel: $("#rebsol_hermesbundle_PagoType_telefonoMovil").val(),
                    fijo: $("#rebsol_hermesbundle_PagoType_telefonoFijo").val(),
                    email: $("#rebsol_hermesbundle_PagoType_correoElectronico").val(),
                    trabajo: $("#rebsol_hermesbundle_PagoType_telefonoTrabajo").val(),
                    direccion: $("#rebsol_hermesbundle_PagoType_direccion").val(),
                    numero: $("#rebsol_hermesbundle_PagoType_numero").val(),
                    resto: $("#rebsol_hermesbundle_PagoType_resto").val(),
                    comuna: $("#rebsol_hermesbundle_PagoType_comuna").val(),
                    idPersona: $("#idPersonainput").val()
                };
                $.ajax({
                    type: 'get',
                    url: "{{ path('Caja_ActualizaPaciente_Api1') }}",
                    data: data,
                    success: function (datar) {
                        datar = $.parseJSON(datar);
                        if (datar !== "falta") {
                            if (datar !== "ok") {
                                $(".errorfalla").slideDown("slow");
                                setTimeout(function () {
                                    $(".errorfalla").slideUp("slow");
                                }, 6000);
                            } else {

                                var update = "" +
                                    "<div class='alert alert-block alert-success'>" +
                                    " <p>" +
                                    " <strong><i class='icon-ok'></i> Objeto editado exitosamente!</strong>" +
                                    " </p>" +
                                    "</div>";
                                bootbox.dialog(update, [{
                                    "label": "Ok",
                                    "class": "btn btn-mini btn-info"
                                }]);
                                post_create_updateApi1();
                            }
                        } else {
                            validaConstraint();
                        }
                    },
                    error: function (datar) {
                        falla();
                    }
                });
                $(".btn-salvar, .btn-salvar-edit").css('pointer-events', 'auto');
            }
        }
    </script>
{% endmacro %}
{% macro FormPrestacion() %}
    <script type='text/javascript'>
        var prestador = 0;
        var idPrestadorContador = 0;
        var esPaquete = 0;

        function cargaDatos(datoDesdeSelect) {
            $('#rebsol_hermesbundle_PrestacionType_plan').prop('disabled', false).trigger("liszt:updated");
            $('.alertaSinDatos').slideUp('slow');
            $.ajaxSetup({
                cache: false
            });
            var data = {
                sucursal: idSucursal,
                dato: datoDesdeSelect
            }
            //Envia por ajax la variable data que contiene el tipo de previsión y sucursal y se dirige a la ruta del controlador del url
            $.ajax({
                type: 'get',
                url: "{{ path('Caja_Consulta_Planes') }}",
                async: false,
                data: data,
                success: function (data) {
                    data = $.parseJSON(data);
                    if (data) {
                        /*var options = '<option value="" disabled="disabled" selected="selected">Seleccionar Plan</option>';
                        for (var i = 0; i < data.length; i++) {
                            options += "<option value=" + data[i].id + ">" + data[i].nombre + '</option>';
                        }*/
                        var options = '';
                        if($("#rebsol_hermesbundle_PrestacionType_plan").val()=== null){
                            options = '<option value="" disabled="disabled" selected="selected">Seleccionar Plan</option>';
                        }
                        let seleccionado = '';
                        for (var i = 0; i < data.length; i++) {
                            if(parseInt($("#rebsol_hermesbundle_PrestacionType_plan").val()) === data[i].id){
                                seleccionado = data[i].id;
                                options += '<option value="' + data[i].id + '" selected="selected">' + data[i].nombre + '</option>';
                            }else {
                                options += "<option value=" + data[i].id + ">" + data[i].nombre + '</option>';
                            }
                        }
                        ;
                        $('#rebsol_hermesbundle_PrestacionType_plan').html(options);
                        //$('.alertafalta').slideUp('slow');
                        $('#rebsol_hermesbundle_PrestacionType_plan').prop('disabled', false).trigger("liszt:updated");
                        $('.alertaSinDatos').slideUp('slow');
                        //choisestyle_campo_plan();
                        // $('#rebsol_hermesbundle_PrestacionType_plan').val('').trigger('chosen:updated');
                        $('#rebsol_hermesbundle_PrestacionType_plan').val(seleccionado).trigger('chosen:updated');
                        $('#rebsol_hermesbundle_PrestacionType_plan').trigger("liszt:updated");
                        // $('#rebsol_hermesbundle_PrestacionType_plan').val('').trigger('chosen:updated');
                        $('#rebsol_hermesbundle_PrestacionType_plan').val(seleccionado).trigger('chosen:updated');

                        //$('.alertafaltaPrestador').hide();
                        $('#rebsol_hermesbundle_PrestacionType_plan').prop('disabled', false).trigger("liszt:updated");
                        $("#ConvenioSelect").slideDown('slow').fadeIn('slow');
                        $('#selectplan').slideDown('slow').fadeIn('slow');
                        verificaConvenioNovacio();
                        // Desliza el combobox de previsión una vez que la sucursal y el tipo de previsión se hayan seleccionado #

                    } else {
                        $('.alertaSinDatos').slideDown('slow');
                        verificaConvenioNovacio();
                    }
                }
            });
        }

        function cargaProfesionalesSelect() {
            var data = {
                sucursal: idSucursal
            };
            $.ajax({
                type: 'get',
                url: "{{ path('Caja_Consulta_Profesionales') }}",
                async: false,
                data: data,
                success: function (data) {
                    data = $.parseJSON(data);
                    ///////////////CARGA AMBOS CAMPOS DE PROFESIONALES///////
                    $('#rebsol_hermesbundle_PrestacionType_derivadoSelect').html("");
                    $('#rebsol_hermesbundle_PrestacionType_derivadoSelect').trigger("liszt:updated");
                    var options = '<option value="" disabled="disabled" selected="selected">Seleccionar Profesional</option>';
                    for (var i = 0; i < data.length; i++) {
                        options += "<option value=" + data[i].id + ">" + data[i].apep + " " + data[i].apem + ", " + data[i].nombre + '</option>';
                    }
                    ;
                    $('#rebsol_hermesbundle_PrestacionType_derivadoSelect').html(options);
                    $('#rebsol_hermesbundle_PrestacionType_derivadoSelect').trigger("liszt:updated");
                    // if (coreApi == 1) {
                        choisestyle_campos_profesionales();
                    // }
                }
            });
        }

        function cargaOrigenSelect() {
            var data = {
                sucursal: idSucursal
            };
            $.ajax({
                type: 'get',
                url: "{{ path('Caja_Consulta_Origen') }}",
                async: false,
                data: data,
                success: function (data) {
                    data = $.parseJSON(data);
                    ///////////////CARGA AMBOS CAMPOS DE ORIGEN///////
                    $('#rebsol_hermesbundle_PrestacionType_origenSelect').html("");
                    var options = '<option value="" disabled="disabled" selected="selected">Seleccionar Origen</option>';
                    for (var i = 0; i < data.length; i++) {
                        options += "<option value=" + data[i].id + ">" + data[i].nombre + '</option>';
                    }
                    ;
                    $('#rebsol_hermesbundle_PrestacionType_origenSelect').html(options);
                    // if (coreApi == 1) {
                        choisestyle_campos_origen();
                    // }
                }

            });

        }

        ////////////////////////////////////////////////////////////////////////////////////////////
        // Listado de Prestaciones, Insumos y Paquetes
        ///////////////////////////////////////////////////////////////////////////////////////////
        function agregarPrestacion(id, dataAjax) {
            console.log('RecaudacionBundle::WidgetCaja::agregarPrestacion')
            var idPrestacion = id;
            if (esDiferencia == 1) {
                anularDiferencia();
                return;
            }

            var selector = "#rebsol_hermesbundle_PrestacionType_prestaciones_" + id + "";
            var exist = $(selector);

            if (exist.length == 1) {
                var valorActual = parseInt($("#" + dataAjax.prestacion).val());
                var valorActualizado = valorActual + 1;

                if ($('#prestacionesTable').find('#td' + dataAjax.prestacion)) {

                    if (esTratamiento == 0) {
                        $("#div" + dataAjax.prestacion).empty();
                        $("#div" + dataAjax.prestacion).append("<div class='ace-spinner'><div class='input-append btn-group btn-group-vertical'><input type='text' class='input-mini spinner-input cambioCantidad cantidadLista" + dataAjax.prestacion + "' id='" + dataAjax.prestacion + "' maxlength='3' style='width: 30px;'></div></div>");
                        $("#" + id).ace_spinner({
                            value: valorActualizado,
                            min: 1,
                            max: 50,
                            step: 1,
                            icon_up: 'icon-plus',
                            icon_down: 'icon-minus',
                            btn_up_class: "btn-success sumarestaCantidad up" + dataAjax.prestacion + "",
                            btn_down_class: "btn-danger sumarestaCantidad down" + dataAjax.prestacion + ""
                        });

                        var precio = $("#precio" + dataAjax.prestacion).html();
                        var spanTotalFila = "sumaCantidad" + dataAjax.prestacion;

                        SumarFila(valorActualizado, precio, spanTotalFila);
                        obtienevalorCantidad();

                        $('#resultadoPrestacionBuscar').html('');
                        $('#divPrestacionBuscar').hide();

                        return false;
                    } else {
                        var div = $("<div class='alertTratamientoDialog'></div>");
                        var code = " <div class='alert alert-block alert-error'>" +
                            " <p>" +
                            " <strong><i class='icon-remove'></i> No es Posible agregar una Prestación que se encuentra actualmente cargado en Tratamiento Selecionado. </strong>" +
                            " </p>" +
                            " </div>";

                        bootbox.dialog(div.append(code), [{
                            "label": "Aceptar",
                            "class": "btn btn-mini btn-info",
                            "callback": function () {
                                $('#resultadoPrestacionBuscar').html('');
                                $('#divPrestacionBuscar').hide();
                            }
                        }]);
                        return;
                    }
                }
                return;
            }
            /* * *
             *  Valida dataAjax: si viene de garantía trae valores de lo contrario es undefined
             *  parche aplicado y acordado con Alvaro Peña. 26-07-2021
             * * */

            sTipoAtencion = TipoAtencion;
            if (dataAjax != undefined) {
                sTipoAtencion = dataAjax.tipoAtencion;
            }
            if (dataAjax == undefined) {
                dataAjax = {
                    tipoAtencion:  sTipoAtencion
                };
            }
            let bPagoCuenta = false;
            let idAccionClinicaPaciente = null;
            if (dataAjax.pagoCuenta != undefined) {
                bPagoCuenta = true;
                idAccionClinicaPaciente = dataAjax.prestacion;
            }

            var dataForm = {
                idPrestacion: id,
                plan: $("#rebsol_hermesbundle_PrestacionType_plan").val(),
                TipoAtencion: sTipoAtencion,
                financiador: $("#prestadorspan").text(),
                idReservaAtencion: idReservaAtencion,
                bPagoCuenta: bPagoCuenta,
                idAccionClinicaPaciente: idAccionClinicaPaciente,
                idPagoCuenta: dataAjax.idPagoCuenta
            };

            $.ajax({
                type: 'get',
                url: "{{ path('Caja_getPrestacion') }}",
                data: dataForm,
                async: false,
                success: function (data) {
                    if (data == 0) {
                        agregarPrestacionHonorarios(idPrestacion);
                        // localStorage.setItem('reservaFolioTmp', null);
                    } else if (data == "nosubempresa") {
                        noSubEmpresa();
                        return false;
                    } else {
                        console.log('Caja_getPrestacion')
                        var data = $.parseJSON(data);
                        console.log(data);
                        var reservaFolio = reservarFolioGlobal(data.id, dataForm.financiador);
                        // localStorage.setItem('reservaFolioTmp', reservaFolio);
                        if (!reservaFolio) {
                            console.log(reservaFolio);
                            return false;
                        }

                        {# TEST #}
                        if (data.showFormRisLis == true) {
                            $('#formRisLis').css('display', 'block');
                        }
                        {# #}

                        let id = data.id;
                        if (dataAjax.prestacion != undefined ) {
                            id = dataAjax.prestacion;
                        }
                        var tr = $("<tr data-show-rislis=" + data.showFormRisLis + " id='prestacion_" + id + "' name='" + data.id + "'></tr>");
                        var td = $("<td id='codigoItem_" + id + "' class='codigo'>" + data.codigo + "-" + data.codigoFonasa + "</td>");
                        tr.append(td);

                        if (data.pabellon !== 0) {
                            var td = $("<td class='pabellon'>" + data.pabellon + "</td>");
                        } else {
                            var td = $("<td class='pabellon'><span class='label label-light'>No Aplica</span></td>");
                        }
                        tr.append(td);

                        var td = $("<td id='nombreItem_" + id + "' class='nombre'>" + data.nombre + "</td>");
                        tr.append(td);

                        // var td = $("<td id='td" + id + "' class='cantidad'><div id='div" + id + "'><div class='ace-spinner'><div class='input-append btn-group btn-group-vertical'><input type='text' class='" + id + " input-mini spinner-input cambioCantidad cantidadLista" + data.id + "'' id='" + id + "'maxlength='3' style='width: 30px;'></div></div></div><div align='right' class='spanResumen hide'><span id='spanResumen" + id + "' class='hide spanResumen'></span></div></td>");
                        var td = $("<td id='td" + id + "' class='cantidad' data-iddetalletratamiento><div id='div" + id + "'><div class='ace-spinner'><div class='input-append btn-group btn-group-vertical'><input type='text' class='ace_prestacion_" + id + " input-mini spinner-input cambioCantidad cantidadLista" + id + "' id='" + id + "' maxlength='3' style='width: 30px;'></div></div></div><div align='right' class='spanResumen hide'><span id='spanResumen" + id + "' class='hide spanResumen'></span></div></td>");

                        tr.append(td);
                        var precioItem = addCommas(data.precio);
                        var td = $("<td class='precio'><div align='right'><span>$</span><span id='precio" + id + "'>" + precioItem + "</span><span id='tipoDoc" + id + "' class='hide'>1</span></div></td>");
                        tr.append(td);

                        var td = $("<td class='preciocantidad'><div align='right'><b><span>$</span><span id='sumaCantidad" + id + "'' class='sumaCantidad'>" + precioItem + "</span></b></div></td>");
                        tr.append(td);

                        var td = $("<td ></td>");
                        var input = $("<input type='hidden' id='rebsol_hermesbundle_PrestacionType_prestaciones_" + id + "' name='rebsol_hermesbundle_PrestacionType[prestaciones][" + id + "]' value='" + id + "' class='removePrestacion'>");
                        var ahref = $("<a data-id='" + id + "' class='btn btn-app btn-danger btn-mini removePrestacion' onClick='eliminarPrestacion(this)'><i class='icon-trash'></i></a>");

						if(data.idExamenPacienteFc) {
							var inputExamen = $("<input type='hidden' id='examenPacienteFc" + id + "' name='examenPacienteFc[" + id + "]' value='" + data.idExamenPacienteFc + "' class='removePrestacion'>");
						}

                        var inputIdPagoCuenta = $("<input type='hidden' id='idPagoCuenta" + id + "' name='idPagoCuenta[" + id + "]' value='" + dataAjax.idPagoCuenta + "' >");
                        var inputIdAccionClinicaPaciente = $("<input type='hidden' id='idAccionClinicaPaciente" + id + "' name='idAccionClinicaPaciente[" + id + "]' value='" + data.idAccionClinicaPaciente + "' >");


                        td.append(input);
						td.append(inputExamen);
						td.append(inputIdPagoCuenta);
						td.append(inputIdAccionClinicaPaciente);
						td.append(ahref);
						tr.append(td);

                        $('#prestacionesTable').append(tr);

                    }

                    if ($('#trDiferencia').length >= 1) {
                        if ($('#trDiferencia').is(':visible')) {
                            $('#trDiferencia').empty();
                            $('#prestacionesTable').find('#trDiferencia').remove();
                        } else {
                            $('#trDiferencia').empty();
                            $('#prestacionesTable').find('#trDiferencia').remove();
                            var trDiferencia = $("<tr id='trDiferencia' style='text-align:right; background-color: #F2F5A9' class='hidden hide'></tr>");
                            var td = $("<td colspan='5' style='text-align:right;' ><span><b>Diferencia Aplicada:</b></span></td>");
                            trDiferencia.append(td);
                            var td = $("<td style=' font-size: medium; padding:0 0 0 0;' ><div align='right'><b><span>$</span><span id='diferenciaTotal'></span></b></div></td>");
                            trDiferencia.append(td);
                            var td = $("<td ></td>");
                            var ahref = $("<a id='anularDiferencia' class='btn btn-app btn-danger btn-mini removeDiferencia' onClick='anularDiferencia()'><i class='icon-trash'></i></a>");
                            trDiferencia.append(td);
                            td.append(ahref);
                            $('#prestacionesTable').append(trDiferencia);
                        }
                    } else {
                        var trDiferencia = $("<tr id='trDiferencia' style='text-align:right; background-color: #F2F5A9' class='hidden hide'></tr>");
                        var td = $("<td colspan='5' style='text-align:right;' ><span><b>Diferencia Aplicada:</b></span></td>");
                        trDiferencia.append(td);
                        var td = $("<td style=' font-size: medium; padding:0 0 0 0;' ><div align='right'><b><span>$</span><span id='diferenciaTotal'></span></b></div></td>");
                        trDiferencia.append(td);
                        var td = $("<td ></td>");
                        var ahref = $("<a id='anularDiferencia' class='btn btn-app btn-danger btn-mini removeDiferencia' onClick='anularDiferencia()'><i class='icon-trash'></i></a>");
                        trDiferencia.append(td);
                        td.append(ahref);
                        $('#prestacionesTable').append(trDiferencia);
                    }

                    if ($('#prestacionesTable').find('#total').length == 0) {
                        var trtotal = $("<tr id='total' style='text-align:right; background-color: whitesmoke'></tr>");
                        var td = $("<td colspan='5' style='text-align:right;' ><span><b>Total Cuenta:</b></span></td>");
                        trtotal.append(td);
                        var td = $("<td colspan='2' style=' font-size: medium; padding:0 45px 0 0;' ><div align='right'><b><span>$</span><span id='sumaTotal'></span></b></div></td>");
                        trtotal.append(td);
                        $('#prestacionesTable').append(trtotal);
                        //captura el Input si cambia, toma su id, del id su valor en TEXT y lo envia a funcion para Multiplicar su valor

                        SumarColumna();

                    } else {
                        $('#total').empty();
                        $('#prestacionesTable').find('#total').remove();
                        var trtotal = $("<tr id='total' style='text-align:right; background-color: whitesmoke'></tr>");
                        var td = $("<td colspan='5' style='text-align:right;' ><span><b>Total Cuenta:</b></span></td>");
                        trtotal.append(td);
                        var td = $("<td colspan='2' style=' font-size: medium; padding:0 45px 0 0;' ><div align='right'><b><span>$</span><span id='sumaTotal'></span></b></div></td>");
                        trtotal.append(td);
                        $('#prestacionesTable').append(trtotal);
                        SumarColumna();
                    }

                    $('#prestaciones').show();
                    if (tratamiento == 0) {
                        $('.btn-pre-pagar').show();
                    }


                }
            });
            $('.removePrestacion').css('zoom', '0.75');
            $('.removeDiferencia').css('zoom', '0.75');

            if (dataForm !== "nosubempresa") {

                $('#resultadoPrestacionBuscar').html('');
                $('#divPrestacionBuscar').hide();
                $('#inputPrestacionBuscar').val('');
                $('#inputPaquetePrestacionBuscar').val('');
                $(".ace_prestacion_" + id).ace_spinner({
                    value: 1,
                    min: 1,
                    max: 1000,
                    step: 1,
                    icon_up: 'icon-plus',
                    icon_down: 'icon-minus',
                    btn_up_class: "btn-success sumarestaCantidad up" +id,
                    btn_down_class: "btn-danger sumarestaCantidad down" + id
                }).on('change', function(){
                    cambioCantidad(id);
                });
                obtienevalorCantidad();

            }
        }

        function agregarInsumo(id, dataAjax = null, ArticuloPaciente = null) {

            if (esDiferencia == 1) {
                anularDiferencia();
                return;
            }

            var selector = "#rebsol_hermesbundle_PrestacionType_insumo_" + id + "";
            var exist = $(selector);

            if (exist.length == 1) {

                if (esTratamiento == 0) {

                    var valorActual = parseInt($("#" + id).val());
                    var valorActualizado = valorActual + 1;

                    if ($('#prestacionesTable').find('#td' + id)) {
                        $("#div" + id).empty();
                        $("#div" + id).append("<div class='ace-spinner'><div class='input-append btn-group btn-group-vertical'><input type='text' class='input-mini spinner-input cambioCantidad cantidadLista" + id + "' id='" + id + "' maxlength='3' style='width: 30px;'></div></div>");

                        $("#" + id).ace_spinner({
                            value: valorActualizado,
                            min: 1,
                            max: 50,
                            step: 1,
                            icon_up: 'icon-plus',
                            icon_down: 'icon-minus',
                            btn_up_class: "btn-success up" + id + "",
                            btn_down_class: "btn-danger down" + id + ""
                        });

                        var precio = $("#precio" + id).html();
                        var spanTotalFila = "sumaCantidad" + id;
                        SumarFila(valorActualizado, precio, spanTotalFila);
                        obtienevalorCantidad();

                        $('#resultadoInsumoBuscar').html('');
                        $('#divInsumoBuscar').hide();

                        return false;
                    }
                } else {

                    var div = $("<div class='alertTratamientoDialog'></div>");
                    var code = " <div class='alert alert-block alert-error'>" +
                        " <p>" +
                        " <strong><i class='icon-remove'></i> No es Posible agregar un Insumo que se encuentra actualmente cargado en Tratamiento Selecionado. </strong>" +
                        " </p>" +
                        " </div>";

                    bootbox.dialog(div.append(code), [{
                        "label": "Aceptar",
                        "class": "btn btn-mini btn-info",
                        "callback": function () {
                            $('#resultadoInsumoBuscar').html('');
                            $('#divInsumoBuscar').hide();
                        }
                    }]);
                    return;
                }
                return;
            }

            let bPagoCuenta = false;
            let idArticuloPaciente = null;
            if (dataAjax != undefined && dataAjax.pagoCuenta != undefined) {
                bPagoCuenta = true;
                idArticuloPaciente = ArticuloPaciente['idArticuloPaciente'];
            }

            var data = {
                idInsumo: id,
                sucursal: idSucursal,
                TipoAtencion: TipoAtencion,
                plan: $("#rebsol_hermesbundle_PrestacionType_plan").val(),
                prevision: ($('#rebsol_hermesbundle_PrestacionType_convenio').val()) ? $('#rebsol_hermesbundle_PrestacionType_convenio').val() : $("#rebsol_hermesbundle_PrestacionType_prevision").val(),
                bPagoCuenta: bPagoCuenta,
                idPaciente: $('#idPacientePagoCuenta').val(),
                idArticuloPaciente: idArticuloPaciente,
            }

            $.ajax({
                type: 'get',
                url: "{{ path('Caja_getInsumo') }}",
                data: data,
                async: false,
                success: function (data) {

                    if (data == "nosubempresa") {
                        noSubEmpresa();
                        return false;
                    } else {

                        var data = $.parseJSON(data);

                        var tr = $("<tr id='insumo_" + data.id + "'  name='" + data.id + "'></tr>");
                        var td = $("<td id='codigoItem_" + data.id + "'>" + data.codigo + "</td>");
                        tr.append(td);

                        var td = $("<td ><span class='label label-light'>No Aplica</span></td>");
                        tr.append(td);

                        var td = $("<td id='nombreItem_" + data.id + "'>" + data.nombre + "</td>");
                        tr.append(td);

                        var td = $("<td id='td" + id + "'><div id='div" + id + "'><div class='ace-spinner'><div class='input-append btn-group btn-group-vertical'><input type='text' class='" + id + " input-mini spinner-input cambioCantidad cantidadLista" + data.id + "'' id='" + id + "'maxlength='3' style='width: 30px;'></div></div></div><div align='right' class='spanResumen hide'><span id='spanResumen" + id + "' class='hide spanResumen'></span></div></td>");
                        tr.append(td);

                        var precioItem = addCommas(data.precio);
                        var td = $("<td class='precio'><div align='right'><span>$</span><span id='precio" + id + "'>" + precioItem + "</span><span id='tipoDoc" + id + "' class='hide'>2</span></div></td>");
                        tr.append(td);

                        var td = $("<td><div align='right'><b><span>$</span><span id='sumaCantidad" + id + "'' class='sumaCantidad'>" + precioItem + "</span></b></div></td>");
                        tr.append(td);

                        var td = $("<td></td>");
                        var input = $("<input type='hidden' id='rebsol_hermesbundle_PrestacionType_insumo_" + data.id + "' name='rebsol_hermesbundle_PrestacionType[prestaciones][" + data.id + "]' value='" + data.id + "' class='removePrestacion'>");
                        var ahref = $("<a data-id='" + data.id + "' class='btn btn-app btn-danger btn-mini removePrestacion' onClick='eliminarPrestacion(this)'><i class='icon-trash'></i></a>");

                        td.append(input);
                        td.append(ahref);
                        tr.append(td);

                        $('#prestacionesTable').append(tr);

                        if ($('#trDiferencia').length >= 1) {
                            if ($('#trDiferencia').is(':visible')) {
                                $('#trDiferencia').empty();
                                $('#prestacionesTable').find('#trDiferencia').remove();
                            } else {
                                $('#trDiferencia').empty();
                                $('#prestacionesTable').find('#trDiferencia').remove();
                                var trDiferencia = $("<tr id='trDiferencia' style='text-align:right; background-color: #F2F5A9' class='hidden hide'></tr>");
                                var td = $("<td colspan='5' style='text-align:right;' ><span><b>Diferencia Aplicada:</b></span></td>");
                                trDiferencia.append(td);
                                var td = $("<td style=' font-size: medium; padding:0 0 0 0;' ><div align='right'><b><span>$</span><span id='diferenciaTotal'></span></b></div></td>");
                                trDiferencia.append(td);
                                var td = $("<td ></td>");
                                var ahref = $("<a id='anularDiferencia' class='btn btn-app btn-danger btn-mini removeDiferencia' onClick='anularDiferencia()'><i class='icon-trash'></i></a>");
                                trDiferencia.append(td);
                                td.append(ahref);
                                $('#prestacionesTable').append(trDiferencia);
                            }
                        } else {
                            var trDiferencia = $("<tr id='trDiferencia' style='text-align:right; background-color: #F2F5A9' class='hidden hide'></tr>");
                            var td = $("<td colspan='5' style='text-align:right;' ><span><b>Diferencia Aplicada:</b></span></td>");
                            trDiferencia.append(td);
                            var td = $("<td style=' font-size: medium; padding:0 0 0 0;' ><div align='right'><b><span>$</span><span id='diferenciaTotal'></span></b></div></td>");
                            trDiferencia.append(td);
                            var td = $("<td ></td>");
                            var ahref = $("<a id='anularDiferencia' class='btn btn-app btn-danger btn-mini removeDiferencia' onClick='anularDiferencia()'><i class='icon-tr'></i></a>");
                            trDiferencia.append(td);
                            td.append(ahref);
                            $('#prestacionesTable').append(trDiferencia);
                        }


                        if ($('#prestacionesTable').find('#total').length == 0) {

                            var trtotal = $("<tr id='total' style='text-align:right; background-color: whitesmoke'></tr>");
                            var td = $("<td colspan='5' style='text-align:right;' ><span><b>Total Cuenta:</b></span></td>");
                            trtotal.append(td);
                            var td = $("<td colspan='2' style=' font-size: medium; padding:0 45px 0 0;' ><div align='right'><b><span>$</span><span id='sumaTotal'></span></b></div></td>");
                            trtotal.append(td);
                            $('#prestacionesTable').append(trtotal);
                            //captura el Input si cambia, toma su id, del id su valor en TEXT y lo envia a funcion para Multiplicar su valor

                            SumarColumna();

                        } else {
                            $('#total').empty();
                            $('#prestacionesTable').find('#total').remove();
                            var trtotal = $("<tr id='total' style='text-align:right; background-color: whitesmoke'></tr>");
                            var td = $("<td colspan='5' style='text-align:right;' ><span><b>Total Cuenta:</b></span></td>");
                            trtotal.append(td);
                            var td = $("<td colspan='2' style=' font-size: medium; padding:0 45px 0 0;' ><div align='right'><b><span>$</span><span id='sumaTotal'></span></b></div></td>");
                            trtotal.append(td);
                            $('#prestacionesTable').append(trtotal);
                            SumarColumna();
                        }

                        $('#prestaciones').show();
                        if (tratamiento == 0) {
                            $('.btn-pre-pagar').show();
                        }
                    }
                }
            });

            $('.removePrestacion').css('zoom', '0.75');
            $('.removeDiferencia').css('zoom', '0.75');
            $('#resultadoInsumoBuscar').html('');
            $('#divInsumoBuscar').hide();
            $('#inputInsumoBuscar').val('');

            $("." + id).ace_spinner({
                value: 1,
                min: 1,
                max: 50,
                step: 1,
                icon_up: 'icon-plus',
                icon_down: 'icon-minus',
                btn_up_class: "btn-success sumarestaCantidad up" + id + "",
                btn_down_class: "btn-danger sumarestaCantidad down" + id + ""
            });


            obtienevalorCantidad();
        }

        function agregarPrestacionHonorarios(id) {

            var data = {
                idPrestacion: id,
                plan: $("#rebsol_hermesbundle_PrestacionType_plan").val(),
                sucursal: idSucursal,
                TipoAtencion: TipoAtencion
            };

            $.ajax({
                type: 'get',
                url: "{{ path('Caja_getPrestacionHonorarios') }}",
                data: data,
                async: false,
                success: function (data) {

                    if (data == "nosubempresa") {

                        noSubEmpresa();
                        return false;

                    } else if (data == "nohonorario") {

                        noHonorarios();
                        return false;

                    } else {

                        var data = $.parseJSON(data);

                        for (i = 0; i < data.length; i++) {

                            if ($("#prestacion_" + data[i].id + "_" + data[i].idad).length !== 0) {

                                var valorActual = parseInt($("#" + data[i].id + "_" + data[i].idad).val());
                                var valorActualizado = valorActual + 1;

                                if ($('#prestacionesTable').find('#td' + data[i].id + "_" + data[i].idad)) {

                                    $("#div" + data[i].id + "_" + data[i].idad).empty();

                                    $("#div" + data[i].id + "_" + data[i].idad).append("<div class='ace-spinner'><div class='input-append btn-group btn-group-vertical'><input type='text' class='input-mini spinner-input cambioCantidad cantidadLista" + id + "' id='" + data[i].id + "_" + data[i].idad + "' maxlength='3' style='width: 30px;'></div></div>");

                                    $("#" + data[i].id + "_" + data[i].idad).ace_spinner({
                                        value: valorActualizado,
                                        min: 1,
                                        max: 50,
                                        step: 1,
                                        icon_up: 'icon-plus',
                                        icon_down: 'icon-minus',
                                        btn_up_class: "btn-success sumarestaCantidad up" + id + "",
                                        btn_down_class: "btn-danger sumarestaCantidad down" + id + ""
                                    });
                                }
                                var precio = $("#precio" + data[i].id + "_" + data[i].idad).html();
                                var spanTotalFila = "sumaCantidad" + data[i].id + "_" + data[i].idad;
                                SumarFila(valorActualizado, precio, spanTotalFila);
                                obtienevalorCantidad();
                                $('#resultadoPrestacionBuscar').html('');
                                $('#divPrestacionBuscar').hide();

                                if (i === data.length) {
                                    return false;
                                }
                            } else {

                                var tr = $("<tr id='prestacion_" + data[i].id + "_" + data[i].idad + "'  name='" + data[i].id + "'></tr>");
                                var td = $("<td id='codigoItem_" + data[i].id + "_" + data[i].idad + "'>" + data[i].codigo + "-" + data[i].codigoFonasa + "</td>");
                                tr.append(td);

                                if (data[i].pabellon !== 0) {

                                    if (data[i].precio !== "0") {
                                        var td = $("<td>" + data[i].pabellon + "</td>");
                                    } else {
                                        var td = $("<td><span class='label label-light'>No Aplica</span></td>");
                                    }

                                } else {

                                    var td = $("<td><span class='label label-light'>No Aplica</span></td>");

                                }

                                tr.append(td);


                                var td = $("<td id='nombreItem_" + data[i].id + "_" + data[i].idad + "'>" + data[i].nombre + " - " + data[i].nombreItem + "</td>");

                                tr.append(td);

                                var td = $("<td id='td" + id + "_" + data[i].idad + "' class='td" + id + "'><div id='div" + id + "_" + data[i].idad + "' class='div" + id + "'><div class='ace-spinner'><div class='input-append btn-group btn-group-vertical'><input type='text' class='" + id + " input-mini spinner-input cambioCantidad cantidadLista" + data[i].id + "'' id='" + id + "_" + data[i].idad + "'maxlength='3' style='width: 30px;'></div></div></div><div align='right' class='spanResumen hide'><span id='spanResumen" + id + "_" + data[i].idad + "' class='hide spanResumen'></span></div></td>");

                                tr.append(td);

                                var precio = data[i].precio;

                                if (precio === "0") {
                                    var precio = "0";
                                }

                                var precioItem = addCommas(precio);
                                var td = $("<td class='precio'><div align='right'><span>$</span><span id='precio" + id + "_" + data[i].idad + "''>" + precioItem + "</span><span id='precio" + id + "' class='hide'>" + precio + "</span><span id='tipoDoc" + id + "_" + data[i].idad + "' class='hide'>1</span></div></td>");
                                tr.append(td);

                                tr.append(td);

                                var td = $("<td><div align='right'><b><span>$</span><span id='sumaCantidad" + id + "_" + data[i].idad + "'' class='sumaCantidad'>" + precioItem + "</span></b></div></td>");

                                tr.append(td);

                                var td = $("<td></td>");

                                var input = $("<input type='hidden' id='rebsol_hermesbundle_PrestacionType_prestaciones_" + data[i].id + "_" + data[i].idad + "' name='rebsol_hermesbundle_PrestacionType[prestaciones][" + data[i].id + "_" + data[i].idad + "]' value='" + data[i].id + "_" + data[i].idad + "' class='removePrestacion'>");

                                var ahref = $("<a data-id='" + data[i].id + "' class='btn btn-app btn-danger btn-mini removePrestacion' onClick='eliminarPrestacion(this)'><i class='icon-trash'></i></a>");

                                td.append(input);
                                td.append(ahref);
                                tr.append(td);
                                $('#prestacionesTable').append(tr);
                                $('.removePrestacion').css('zoom', '0.75');
                                $('.removeDiferencia').css('zoom', '0.75');

                            }
                        }
                    }
                }
            });
        }

        function agregarPaquete(id) {
            bootbox.dialog(
                "<div class='alert alert-block alert-success modalEsperaPaquete'>" +
                " <i class='icon-spinner icon-spin green bigger-125'> </i><strong class='green'> Cargando Paquete,</strong><br>Por favor espere..." +
                "<div class='clearfix'></div>" +
                "</div>"
            ).delay(500).promise().done(function () {
                generaPaquete(id);
            });
        }

        function generaPaquete(id) {
            var data = {
                idPaquete: id,
            };
            $.ajax({
                type: 'get',
                url: "{{ path('Caja_getPaquete') }}",
                data: data,
                async: false,
                success: function (data) {
                    esPaquete = 1;
                    data = $.parseJSON(data);
                    agregarPrestacion(data.idPrestacion);
                    var count = data.arrArticulos.length;

                    if (count > 0) {

                        if (count == 1) {

                            agregarInsumo(data.arrArticulos[0].idArticulo)
                            $("." + data.arrArticulos[0].idArticulo).val(data.arrArticulos[0].cantidad);
                            $("." + data.arrArticulos[0].idArticulo).css("width", "40px");
                            $("." + data.arrArticulos[0].idArticulo).attr('maxlength', '4')
                            obtienevalorCantidad();
                            SumarColumna();

                        }

                        if (count > 1) {
                            for (var i = 0; i < count; i++) {

                                agregarInsumo(data.arrArticulos[i].idArticulo);
                                $("." + data.arrArticulos[i].idArticulo).val(data.arrArticulos[i].cantidad);
                                $("." + data.arrArticulos[i].idArticulo).css("width", "40px");
                                $("." + data.arrArticulos[i].idArticulo).attr('maxlength', '4')
                                obtienevalorCantidad();
                                SumarColumna();

                            }
                        }
                    }

                    if (esPaquete == 1) {

                        $(".modalEsperaPaquete").closest('.modal').modal("hide");
                        esPaquete = 2;

                    }

                    $('#resultadoPaqueteBuscar').html('');
                    $('#divPaqueteBuscar').hide();
                }
            });
        }

        function noSubEmpresa() {

            var error = "" +
                "<div class='alert alert-block alert-danger'>" +
                "    <p>" +
                "    <strong>Error en Seleccion de Prestación Insumo:</strong>" +
                "    <br>" +
                "    <br>Motivo: Item no relacionado a Sub-Empresa de Talonarios asociados o " +
                "    <br>Sub-Empresa de nuevo Item seleccionado, no corresponde a misma Sub-Empresa de Items Seleccionados Anteriormente" +
                "    <br>Por favor, purebe con una selección diferente." +
                "    </p>" +
                "</div>";
            bootbox.dialog(error, [{
                "label": "Aceptar",
                "class": "btn btn-mini",
                "callback": function () {
                }
            }]);
            return;
        }

        function noHonorarios() {
            //bootbox.hideAll();

            $("#tablePrestacionHeader").parent().hide();
            var error = "" +
                "<div class='alert alert-block alert-danger'>" +
                "    <p>" +
                "    <strong>Error en Seleccion de Prestación con Honorarios:</strong>" +
                "    <br>" +
                "    <br>Motivo: La Prestación está relacionada a Honorarios, " +
                "    <br>existe y esta vigente sin embargo no cuenta con las valorizaciones" +
                "    <br>de sus honorarios relacionado activos." +
                "    <br>Por favor, purebe con una selección diferente." +
                "    </p>" +
                "</div>";
            bootbox.dialog(error, [{
                "label": "Aceptar",
                "class": "btn btn-mini",
                "callback": function () {
                    $('#divPrestacionBuscar').hide();
                    $('#divInsumoBuscar').hide();
                    $("#inputPrestacionBuscar, #inputInsumoBuscar").val('');
                    if ($(".precio").length == 0) {
                        $("#tablePrestacionHeader").parent().hide();
                    }
                }
            }]);
            return;
        }


        /**
         * enBusqueda: Estará en true mientras se esté buscando una prestación
         * @type {Boolean}
         */
        var enBusqueda = false;

        /**
         * buscarPrestacion: Busca las prestaciones que cumplen con el filtro del input.
         */
        function buscarPrestacion() {
            var texto = $('#inputPrestacionBuscar').val();
            if (enBusqueda) {
                return false;
            }
            ;
            if (texto.length < 4) {
                return false;
            }
            ;
            var append = $('#iconPrestacionBuscar');
            append.removeClass('icon-asterisk');
            append.addClass('icon-spinner icon-spin');
            $('#resultadoPrestacionBuscar').html('');
            $('#divPrestacionBuscar').hide();

            enBusqueda = true;
            var data = {
                textoBusqueda: texto
            };
            $.ajax({
                type: 'get',
                url: "{{ path('Caja_BuscarPrestacion') }}",
                data: data,
                success: function (data) {
                    $('#resultadoPrestacionBuscar').html(data);

                    $('#divPrestacionBuscar').show();

                    append.removeClass('icon-spinner icon-spin');
                    append.addClass('icon-asterisk');
                    enBusqueda = false;

                }
            });
        }

        function buscarInsumo() {
            var texto = $('#inputInsumoBuscar').val();
            if (enBusqueda) {
                return false;
            }
            ;
            if (texto.length < 4) {
                return false;
            }
            ;
            var append = $('#iconInsumoBuscar');
            append.removeClass('icon-asterisk');
            append.addClass('icon-spinner icon-spin');
            $('#resultadoInsumoBuscar').html('');
            $('#divInsumoBuscar').hide();

            enBusqueda = true;
            var data = {
                textoBusqueda: texto
            };
            $.ajax({
                type: 'get',
                url: "{{ path('Caja_BuscarInsumos') }}",
                data: data,
                success: function (data) {
                    $('#resultadoInsumoBuscar').html(data);
                    $('#divInsumoBuscar').show();
                    append.removeClass('icon-spinner icon-spin');
                    append.addClass('icon-asterisk');
                    enBusqueda = false;
                }
            });
        }

        function buscarPaquete() {
            var texto = $('#inputPaqueteBuscar').val();
            if (enBusqueda) {
                return false;
            }
            ;
            if (texto.length < 4) {
                return false;
            }
            ;
            var append = $('#iconPaqueteBuscar');
            append.removeClass('icon-asterisk');
            append.addClass('icon-spinner icon-spin');
            $('#resultadoPaqueteBuscar').html('');
            $('#divPaqueteBuscar').hide();

            enBusqueda = true;
            var data = {
                textoBusqueda: texto
            };
            $.ajax({
                type: 'get',
                url: "{{ path('Caja_BuscarPaquete') }}",
                data: data,
                success: function (data) {
                    $('#resultadoPaqueteBuscar').html(data);
                    $('#divPaqueteBuscar').show();
                    append.removeClass('icon-spinner icon-spin');
                    append.addClass('icon-asterisk');
                    enBusqueda = false;
                }
            });
        }

        /**
         * eliminarPrestacion: Elimina una prestación del listado seleccionado
         * @param  jQueryElement elemento
         */
        ////////////////////////////////////////////////////////////////////////////////////////////
        // Acciones de Listado de Isumos Prestaciones
        ///////////////////////////////////////////////////////////////////////////////////////////

        function Caja_Valmacena_Total_Suma(vSumaCantidad) {
            var data = {
                vSumaCantidad: vSumaCantidad
            };
            $.ajaxSetup({
                cache: false
            });
            $.ajax({
                type: 'get',
                url: "{{ path('Caja_Valmacena_Total_Suma') }}",
                async: false,
                data: data,
                success: function (data) {
                    $("#sumaTotal").html(addCommas(data));
                }
            });
        }

    </script>
{% endmacro %}

	{% macro MediosDePago() %}

        <script type='text/javascript'>

            //parte con la funcion que inicia los medios de pago, entregando los valores iniciales a Total a pagar y Saldo a Pagar

            function Caja_Valor_Pagar(Valor_Pagar) {
                var data = {
                    Valor_Pagar: Valor_Pagar
                };
                $.ajaxSetup({
                    cache: false
                });
                $.ajax({
                    type: 'get',
                    url: "{{ path('Caja_Valor_Pagar') }}",
                    async: false,
                    data: data,
                    success: function (data) {
                        IniciamedioPago(addCommas(data));
                        IniciamedioPagoPagoParcial(addCommas(data));
                    }
                });
            }

            function Caja_Valor_Pagar_Pago_Cuenta(Valor_Pagar) {
                var data = {
                    Valor_Pagar: Valor_Pagar
                };
                $.ajaxSetup({
                    cache: false
                });
                $.ajax({
                    type: 'get',
                    url: "{{ path('Caja_Valor_Pagar_Pago_Cuenta') }}",
                    async: false,
                    data: data,
                    success: function (data) {
                        IniciamedioPago(addCommas(data));
                        IniciamedioPagoPagoParcial(addCommas(data));
                    }
                });
            }

            function Caja_Valor_Pagar_Comparar_Tabs(Valor_Pagar) {
                var data = {
                    Valor_Pagar: Valor_Pagar
                };
                $.ajaxSetup({
                    cache: false
                });
                $.ajax({
                    type: 'get',
                    url: "{{ path('Caja_Valor_Pagar_Comparar_Tabs') }}",
                    async: false,
                    data: data,
                    success: function (data) {

                        IniciamedioPago(addCommas(data));
                        IniciamedioPagoPagoParcial(addCommas(data));

                    }
                });
            }


            /**
             * @return {null}
             */
            function VerificarPagosTransbank() {
                var pagarTransbank = null;
                let retornar = true;
                $('input.transbank').each(function () {
                    if (!this.readOnly && this.value !== '') {
                        pagarTransbank = 'falta_transaccion';
                        MensajePOSTransbank(pagarTransbank);
                        retornar = false;
                        return retornar;
                    }
                });

                return retornar;

                /*console.log('pagarTransbank sin each');
                console.log(pagarTransbank);
                return pagarTransbank;*/
            }

            /*async function EnvioPagoTransbank(id, cantidad) {
                var pagarTransbank = await PagarTransbank(id, cantidad);
               // MensajePOSTransbank(pagarTransbank);
            }*/

            function MensajePOSTransbank(pagarTransbank) {
                console.log('MensajePOSTransbank::pagarTransbank');
                console.log(pagarTransbank);

                if (pagarTransbank === 'falta_transaccion') {
                    bootbox.dialog("<div class='alert alert-block alert-danger'>" +
                        "    <p> <strong><i class='icon-ok'> </i> No se puede generar el pago ya que hay transacciones de Transbank que no se han realizado </strong> </p> </div>", [
                        {
                            "label": "Aceptar",
                            "class": "btn btn-mini alert",
                            "callback": function () {
                            }
                        }]);
                } else if (pagarTransbank === undefined) {
                    bootbox.dialog("<div class='alert alert-block alert-danger'>" +
                        "    <p> <strong><i class='icon-ok'> </i> Error en SDK por favor ejecutarlo nuevamente </strong> </p> </div>", [
                        {
                            "label": "Aceptar",
                            "class": "btn btn-mini alert",
                            "callback": function () {
                            }
                        }]);
                } else if (pagarTransbank['result'] === true) {
                    bootbox.dialog("<div class='alert alert-block alert-success'>" +
                        "    <p> <strong><i class='icon-ok'> </i>" + pagarTransbank['result'] + "</strong> </p> </div>", [
                        {
                            "label": "Aceptar",
                            "class": "btn btn-mini alert",
                            "callback": function () {
                            }
                        }]);
                } else if (pagarTransbank['result'] === false) {
                    bootbox.dialog("<div class='alert alert-block alert-danger'>" +
                        "    <p> <strong><i class='icon-ok'> </i>" + pagarTransbank['result'] + "</strong> </p> </div>", [
                        {
                            "label": "Aceptar",
                            "class": "btn btn-mini alert",
                            "callback": function () {
                            }
                        }]);
                }

            }

            /**
             * @return {array}
             */
            async function PagarTransbank(id, cantidad) {

                var montoATransbank = $('#rebsol_hermesbundle_MediosPagoType_monto_' + id + '_' + cantidad).val();
                console.log(montoATransbank);
                console.log('PagarTransbank');
                if (montoATransbank.trim() !== '') {
                    //if (localStorage.getItem("connectPOS") !== null && localStorage.getItem("connectPOS") === 'true') {
                    console.log('PagarTransbank:conectarPOSTransbankPago()');
                    await conectarPOSTransbankPago();
                    Transbank.POS.doSale(montoATransbank, "0").then((saleResponse) => {
                        console.log('PagarTransbank::POS.doSale');
                        //Acá llega la respuesta de la venta. Si saleResponse.responseCode es 0, entonces la comproa fue aprobada
                        console.log(saleResponse.responseCode);
                        if (saleResponse.responseCode === 0) {
                            document.getElementById('rebsol_hermesbundle_MediosPagoType_voucher_' + id + '_' + cantidad).value
                                = saleResponse.operationNumber;
                            document.getElementById('rebsol_hermesbundle_MediosPagoType_codAutorizacion_' + id + '_' + cantidad).value
                                = saleResponse.authorizationCode;
                            document.getElementById('rebsol_hermesbundle_MediosPagoType_ultimos4Numeros_' + id + '_' + cantidad).value
                                = saleResponse.last4Digits;
                            document.getElementById('rebsol_hermesbundle_MediosPagoType_nombreTarjeta_' + id + '_' + cantidad).value
                                    = saleResponse.cardBrand;
                            document.getElementById('rebsol_hermesbundle_MediosPagoType_tarjetaTipo_' + id + '_' + cantidad).value
                                = saleResponse.cardType;
                            // Mostramos mensaje de éxito y limpiamos el total de la venta si response code es 0
                            document.getElementById('rebsol_hermesbundle_MediosPagoType_monto_' + id + '_' + cantidad).readOnly = true;
                            document.getElementById('btn_tbk_pagar_' + id + '_' + cantidad).style.visibility = 'hidden';
                            document.getElementById('btn_tbk_anular_' + id + '_' + cantidad).style.visibility = 'visible';

                            bootbox.dialog("<div class='alert alert-block alert-success'>" +
                                "    <p> <strong><i class='icon-ok'> </i>Transacción realizada exitosamente</strong> </p> </div>", [
                                {
                                    "label": "Aceptar",
                                    "class": "btn btn-mini alert",
                                    "callback": function () {
                                    }
                                }]);

                        } else if (saleResponse.responseCode === 14 || saleResponse.responseCode === 18 || saleResponse.responseCode === 1) {
                            console.log('Error en selección de tipo tarjeta, por favor reintente nuevamente');
                            bootbox.dialog("<div class='alert alert-block alert-danger'>" +
                                "    <p> <strong><i class='icon-ok'> </i>Error en selección de tipo tarjeta, por favor reintente nuevamente </strong> </p> </div>", [
                                {
                                    "label": "Aceptar",
                                    "class": "btn btn-mini alert",
                                    "callback": function () {
                                    }
                                }]);
                        } else if (saleResponse.responseCode === 3) {
                            console.log('Conexión falló, por favor reintente nuevamente');
                            bootbox.dialog("<div class='alert alert-block alert-danger'>" +
                                "    <p> <strong><i class='icon-ok'> </i>Conexión falló, por favor reintente nuevamente </strong> </p> </div>", [
                                {
                                    "label": "Aceptar",
                                    "class": "btn btn-mini alert",
                                    "callback": function () {
                                    }
                                }]);
                        } else if (saleResponse.responseCode === 7 || saleResponse.responseCode === 22) {
                            console.log('Transacción fallida, por favor reintente nuevamente');
                            bootbox.dialog("<div class='alert alert-block alert-danger'>" +
                                "    <p> <strong><i class='icon-ok'> </i>Transacción fallida, por favor reintente nuevamente</strong> </p> </div>", [
                                {
                                    "label": "Aceptar",
                                    "class": "btn btn-mini alert",
                                    "callback": function () {
                                    }
                                }]);

                        } else if (saleResponse.responseCode === 27) {
                            console.log('Transacción fallida, tarjeta inválida');
                            bootbox.dialog("<div class='alert alert-block alert-danger'>" +
                                "    <p> <strong><i class='icon-ok'> </i>Transacción fallida, tarjeta inválida</strong> </p> </div>", [
                                {
                                    "label": "Aceptar",
                                    "class": "btn btn-mini alert",
                                    "callback": function () {
                                    }
                                }]);
                        }
                    }).catch((e) => {
                        console.log(e);
                        bootbox.dialog("<div class='alert alert-block alert-danger'>" +
                            "    <p> <strong><i class='icon-ok'> </i>Transacción fallida, conectar el POS en la pestaña Transbank</strong> </p> </div>", [
                            {
                                "label": "Aceptar",
                                "class": "btn btn-mini alert",
                                "callback": function () {
                                }
                            }]);
                    });

                } else {
                    console.log('Debe ingresar un monto válido');
                    bootbox.dialog("<div class='alert alert-block alert-danger'>" +
                        "    <p> <strong><i class='icon-ok'> </i>Debe ingresar un monto válido</strong> </p> </div>", [
                        {
                            "label": "Aceptar",
                            "class": "btn btn-mini alert",
                            "callback": function () {
                            }
                        }]);

                }
            }


            async function AnularTransbank(id, cantidad) {
                var operationId = document.getElementById('rebsol_hermesbundle_MediosPagoType_voucher_' + id + '_' + cantidad).value;
                console.log('AnularTransbank');
                console.log('PagarTransbank:conectarPOSTransbankPago()');
                await conectarPOSTransbankPago();
                Transbank.POS.refund(operationId).then((saleResponse) => {
                    //Acá llega la respuesta de la venta. Si saleResponse.responseCode es 0, entonces la comproa fue aprobada
                    //console.log(saleResponse);
                    if (saleResponse.responseCode === 0) {
                        console.log(saleResponse);
                        var cantidadInt = parseInt(cantidad);
                        var cantidadIntSig = cantidadInt + 1;
                        if (cantidadInt === 0) {
                            if (typeof $('#rebsol_hermesbundle_MediosPagoType_monto_' + id + '_' + cantidadIntSig).val() !== 'undefined') {
                                $('#tabla_' + id + '_' + cantidad).empty().remove();
                            } else {
                                document.getElementById('rebsol_hermesbundle_MediosPagoType_monto_' + id + '_' + cantidad).readOnly = false;
                                document.getElementById('rebsol_hermesbundle_MediosPagoType_monto_' + id + '_' + cantidad).value = '';
                                document.getElementById('btn_tbk_pagar_' + id + '_' + cantidad).style.visibility = 'visible';
                                document.getElementById('btn_tbk_anular_' + id + '_' + cantidad).style.visibility = 'hidden';
                            }
                        }

                        if (cantidadInt >= 1) {
                            if (typeof $('#rebsol_hermesbundle_MediosPagoType_monto_' + id + '_' + cantidadIntSig).val() !== 'undefined') {
                                $('#tabla_' + id + '_' + cantidad).empty().remove();
                            } else {
                                //$('#tabla_' + id + '_' + cantidad).empty().remove();
                                for (var i = cantidadInt; i >= 0; i--) {
                                    if (typeof $('#rebsol_hermesbundle_MediosPagoType_monto_' + id + '_' + i).val() !== 'undefined') {
                                        $('.clonar_' + id + '_' + i).show();
                                        document.getElementById('rebsol_hermesbundle_MediosPagoType_monto_' + id + '_' + cantidad).readOnly = false;
                                        document.getElementById('rebsol_hermesbundle_MediosPagoType_monto_' + id + '_' + cantidad).value = '';
                                        document.getElementById('btn_tbk_pagar_' + id + '_' + cantidad).style.visibility = 'visible';
                                        document.getElementById('btn_tbk_anular_' + id + '_' + cantidad).style.visibility = 'hidden';
                                        break;
                                    }
                                    /*if (typeof $('#rebsol_hermesbundle_MediosPagoType_monto_' + id + '_' + i).val() !== 'undefined') {
                                            $('.clonar_' + id + '_' + i).show();
                                            break;
                                        }*/
                                }
                            }
                        }
                        SumaSaldoVsMediosPago();

                        bootbox.dialog("<div class='alert alert-block alert-success'>" +
                            "    <p> <strong><i class='icon-ok'> </i> Transacción anulada exitosamente </strong> </p> </div>", [
                            {
                                "label": "Aceptar",
                                "class": "btn btn-mini alert",
                                "callback": function () {
                                }
                            }]);
                    } else if (saleResponse.responseCode === 8 || saleResponse.responseCode === 21) {
                        bootbox.dialog("<div class='alert alert-block alert-danger'>" +
                            "    <p> <strong><i class='icon-ok'> </i> No puede anular transaccion de débito </strong> </p> </div>", [
                            {
                                "label": "Aceptar",
                                "class": "btn btn-mini alert",
                                "callback": function () {
                                }
                            }]);
                    } else if (saleResponse.responseCode === 20 || saleResponse.responseCode === 5) {
                        bootbox.dialog("<div class='alert alert-block alert-danger'>" +
                            "    <p> <strong><i class='icon-ok'> </i> No Existe Transacción para Anular </strong> </p> </div>", [
                            {
                                "label": "Aceptar",
                                "class": "btn btn-mini alert",
                                "callback": function () {
                                }
                            }]);
                    } else {

                        // Mostramos mensaje de error si response code es distinto de 0
                        bootbox.dialog("<div class='alert alert-block alert-danger'>" +
                            "    <p> <strong><i class='icon-ok'> </i> Anulación fallida </strong> </p> </div>", [
                            {
                                "label": "Aceptar",
                                "class": "btn btn-mini alert",
                                "callback": function () {
                                }
                            }]);
                    }
                });
                /*} else {
                    console.log('Debe ingresar un monto válido');
                    bootbox.dialog("<div class='alert alert-block alert-danger'>" +
                        "    <p> <strong><i class='icon-ok'> </i>Debe conectar el POS en la pestaña Transbank</strong> </p> </div>", [
                        {
                            "label": "Aceptar",
                            "class": "btn btn-mini alert",
                            "callback": function () {
                            }
                        }]);

                }*/

            }

            async function conectarPOSTransbankPago() {
                console.log('Transbank::conectarPOS');
                Transbank.POS.connect();
                return await Transbank.POS.autoconnect().then((port) => {
                    console.log('port');
                    console.log(port);
                    if (port === false) {
                        mensajePOS('alert-danger', 'No se encontró ningún POS en modo integrado');
                        console.log('No se encontró ningún POS en modo integrado');
                        return false;
                    }
                    console.log('Dispositivo detectado y conectado: ' + port.path);
                    return true;
                    // mensajePOS('alert-success', 'Dispositivo detectado y conectado: ' + port.path);
                }).catch(
                    error => console.log(error)
                );
            }

            //CREA NUEVO FORMULARIO DINAMICO//
            function NuevoFormDinamico(idMedioPago) {

                var cantidad = $('.tabla_' + idMedioPago).length;
                //da valor solo si es bono//
                if ($('#tabla' + idMedioPago).find('.bono_' + idMedioPago)) {
                    var AuxCantidad = cantidad - 1;
                    /*
                    *  con el req 
                    * */
                    // var BonoAnterior = $('#tabla_' + idMedioPago).find('.bono_' + idMedioPago + "_" + AuxCantidad).val();
                }
                var data = {
                    cantidad: cantidad,
                    idMedioPago: idMedioPago
                };
                $.ajaxSetup({
                    cache: false
                });
                $.ajax({
                    type: 'get',
                    url: "{{ path('Caja_getNuevoFormDinamico') }}",
                    async: false,
                    data: data,
                    success: function (data) {
                        var cantidadSuma = $('.tabla_' + idMedioPago).length;
                        var cantidadResta = cantidadSuma - 1;
                        $('#rebsol_hermesbundle_MediosPagoType_dinamico_' + idMedioPago).val(cantidadSuma);
                        $('.clonar_' + idMedioPago + '_' + cantidadResta).hide();
                        $('#tabla_' + idMedioPago).append("<div class='tabla_" + idMedioPago + "_" + cantidadSuma + " hide tabla_" + idMedioPago + "'></div>");
                        $('.tabla_' + idMedioPago + '_' + cantidadSuma).html(data).slideDown();
                        var cantidadSuma = $('.tabla_' + idMedioPago).length;
                        $('#rebsol_hermesbundle_MediosPagoType_dinamico_' + idMedioPago).val(cantidadSuma);
                        // if (BonoAnterior > 0) {
                        //     var BonoAnteriorMasUno = parseInt(BonoAnterior) + 1;
                        // }
                        var CantidadAnterior = cantidadResta + 1;

                        // $('.bono_' + idMedioPago + '_' + CantidadAnterior).val(BonoAnteriorMasUno);
                        $('#rebsol_hermesbundle_MediosPagoType_validaBonoOculto_' + idMedioPago + '_' + CantidadAnterior).val(0)
                    }
                });

            }

            //VALIDA RUT DINAMICO//

            //funcion AJAX, envia rut, lo comprueba en el servidor
            function ValidaRutDinamico(aux) {
                aux = aux.closest("td").children("span").text();
                var append = $("#rebsol_hermesbundle_MediosPagoType_rut_" + aux).closest(".input-append").children('span').children('i');
                append.removeClass('icon-asterisk green icon-remove icon-large red');
                append.addClass('icon-spinner icon-spin');
                if ($("#rebsol_hermesbundle_MediosPagoType_rut_" + aux).val() !== '') {
                    var rdv = $("#rebsol_hermesbundle_MediosPagoType_rut_" + aux).val();
                    var rut = preparaRutDinamico(rdv);
                    camporutFormatDinamico(rdv, aux);
                    var rutdv = {
                        rdv: rut
                    };
                    var returnVar = $.ajax({
                        type: 'get',
                        url: "{{ path('Common_Validador_Rut') }}",
                        data: rutdv,
                        async: false
                    }).responseText;
                    if (returnVar == 'true') {
                        accionokDinamico(aux);
                        return true;
                    } else {
                        accionerrorDinamico(aux);
                        return false;
                    }
                } else {

                    var append = $("#rebsol_hermesbundle_MediosPagoType_rut_" + aux).closest(".input-append").children('span').children('i');
                    append.removeClass('icon-spinner icon-spin');
                    append.addClass('dark-opaque icon-asterisk');
                }
            }
        </script>
    {% endmacro %}

{# Pago Garantia #}
{% macro PagoGarantia() %}
    <script type='text/javascript'>
        //INICIO Busca Informacion Garantia
        function PreparaVistaGarantia(id) {
            garantia = 1;
            bootbox.dialog(
                "<div class='alert alert-block alert-success modalEsperaGarantia'>" +
                " <i class='icon-spinner icon-spin green bigger-125'> </i><strong class='green'> Buscando Información para regularizar Garantía,</strong><br>Por favor espere..." +
                "<div class='clearfix'></div>" +
                "</div>"
            ).delay(500).promise().done(function () {
                regGarantia = true;
                console.log('PagoGarantia::PreparaVista::delay');
                ConsultaDatosGarantia(id, regGarantia);
            });
        }

        function PreparaVista(idPagoCuenta) {
            console.log('PagoGarantia::PreparaVista');
            garantia = 1;
            ConsultaDatosGarantia(idPagoCuenta,false);
        }

        function cargaPrevision() {
            $.ajax({
                type: 'get',
                url: "{{ path('Caja_PagoCuenta_Prevision_CuentaPaciente') }}",
                async: false,
                success: function (data) {
                    $('#datosprestador').html(data);
                }
            });
        }

        function ConsultaDatosGarantia(id, regGarantia = false) {
            console.log('RecaudacionBundle::WidgetCaja::ConsultaDatosGarantia')
            var okSubempresa = 0;
            var dataPagoCuenta = {id: id};
            console.log('dataPagoCuenta');
            console.log(dataPagoCuenta);
            $.ajaxSetup({cache: false});
            $.ajax({
                type: 'get',
                url: "{{ path('Caja_PostPago_PagoGarantia') }}",
                async: false,
                data: dataPagoCuenta,
                success: function (data) {
                    var data = $.parseJSON(data);
                    if (data instanceof Object == false) {
                    } else {
                        data.pagoCuenta = true;
                        data.idPrePagoCuenta = idPrePagoCuenta;
                        console.log(data)
                        VerificaDatosPreCarga(data, dataPagoCuenta, regGarantia);
                    }
                }
            });

            $('div.modalEsperaGarantia').parents('div').modal('hide');
            $('.opcionTratamiento').hide();

            bootbox.dialog("<div class='alert alert-block alert-success'>" +
                "    <p> <strong><i class='icon-ok'> </i> Datos Generados Exitosamente</strong> </p> </div>", [
                {
                    "label": "Aceptar",
                    "class": "btn btn-mini alert",
                    "callback": function () {
                    }
                }]);
        }

        function ConsultaDatosRegularizarGarantia(id) {
            console.log('RecaudacionBundle::WidgetCaja::ConsultaDatosRegularizarGarantia')
            var okSubempresa = 0;
            var dataPagoCuenta = {id: id};
            $.ajaxSetup({cache: false});
            $.ajax({
                type: 'get',
                url: "{{ path('Caja_PostPago_PagoGarantia') }}",
                async: false,
                data: dataPagoCuenta,
                success: function (data) {
                    var data = $.parseJSON(data);

                    if (data instanceof Object == false) {
                    } else {
                        console.log(data)
                        VerificaDatosPreCarga(data, dataPagoCuenta);
                    }
                }
            });

            $('div.modalEsperaGarantia').parents('div').modal('hide');
            $('.opcionTratamiento').hide();

            bootbox.dialog("<div class='alert alert-block alert-success'>" +
                "    <p> <strong><i class='icon-ok'> </i> Datos Generados Exitosamente</strong> </p> </div>", [
                {
                    "label": "Aceptar",
                    "class": "btn btn-mini alert",
                    "callback": function () {
                    }
                }]);
        }

        function VerificaDatosPreCarga(data, dataPagoCuenta, regGarantia) {
            console.log('RecaudacionBundle::WidgetCaja::VerificaDatosPreCarga')
            console.log(data)
            var dataAjax = {
                id: data.idPaciente,
                tipoAtencion: data.tipoAtencion
            };

            $.ajax({
                type: 'get',
                url: "{{ path('Caja_PostPago_PagoGarantia_VerificaSubEmpresaActualCajero_PrestacionesInsumos') }}",
                async: false, data: dataAjax,
                success: function (answer) {
                    okSubempresa = (answer == 1) ? answer : 0;
                }
            });

            if (okSubempresa == 1) {
                noSubEmpresa();
            }
            if (okSubempresa == 0) {
                CargaDatosFinanciadorImed(data, dataAjax, dataPagoCuenta, regGarantia);
            }

        }

        function CargaDatosFinanciadorImed(data, dataAjax, dataPagoCuenta, regGarantia) {
            console.log('RecaudacionBundle::WidgetCaja::CargaDatosFinanciadorImed')
            console.log(data)
            cargaDatos(data.financiador);
            $("#rebsol_hermesbundle_PrestacionType_prevision").val(data.financiador);
            if (data.convenio) {
                $("#rebsol_hermesbundle_PrestacionType_convenio").val(data.convenio);
                cargaDatos(data.convenio);
            }
            $("#rebsol_hermesbundle_PrestacionType_origenSelect").val(data.origen);
            if (data.profesional) {
                $("#rebsol_hermesbundle_PrestacionType_derivadoSelect").val(data.profesional);
            } else {
                $("#rebsol_hermesbundle_PrestacionType_derivadoExterno").val(data.externo);
            }
            if(data.idPagoCuenta){
                $("#idPrePagoCuenta").val(data.idPagoCuenta);
            }
            $("#rebsol_hermesbundle_PrestacionType_plan").val(data.plan);
            if (data.fechaPago !== '' && data.fechaPago !== null && data.fechaPago !== "null") {
                var fechaP = data.fechaPago.date;
                var año = fechaP.substr(0, 4);
                var mes = fechaP.substr(5, 2);
                var dia = fechaP.substr(8, 2);
                var fechaDePago = dia + "/" + mes + "/" + año;
            } else {
                var fechaDePago = "Falta Fecha de Registro";
            }

            $("#fechaspan").html(fechaDePago);
            $("#usuariospan").html(data.nombreUsuario);

            if (!regGarantia) {
                MotrarOcultarBuscarPrestacionInsumoPaquete();
            }

            if (!regGarantia) {
                CargaDatosPrestacionIMed(data, dataAjax, dataPagoCuenta);
                SumarColumna();
            }
                cargaresumenprestadorform();
                $('.cambioCantidad').each(function () {
                    $(this).closest('td').find('.spanResumen').html($(this).val()).show().closest('td').find('div').first().hide();
                });
            if (!regGarantia) {
                localStorage.setItem('totalmonto', $("#sumaTotal").text());
                var Valor_Pagar = localStorage.getItem('totalmonto');
                Caja_Valor_Pagar_Pago_Cuenta(Valor_Pagar);
            }
                CargadatosAdicionalImed(dataPagoCuenta);
                $('#prestaciones,  #datosgarantia').show();
                $(".omdp").hide();

                $("#btneditDatosPrestacion, #historicoPacientePagos, #btneditDatosPaciente, #agregar-prestacion-insumo-paquete, .ace-spinner, .removePrestacion, #btn-pre-pagar, .btn-pre-pagar, #cancelar-desde-prestador, #saltosTeporales, .cancelar-desde-prestador").hide();
            if (!regGarantia) {
                $("#mediodepago").slideDown();
                $("#formPrestaciones").show();
                $("#tablePrestacionHeader").parent().parent().show();
                $("#regularizaGarantia").hide();
            } else {
                $('#checkRegularizar').attr('data-idpagocuenta' , dataPagoCuenta.id);
                $("#datosprestacion").hide();
                $("#mediodepago").hide();
                $("#regularizaGarantia").show();
            }
                if (idReservaAtencion) {
                    var fechan = $("#rebsol_hermesbundle_PagoType_fechaNacimiento").val();
                    var anio_nacim = fechan.substr(6, 4);
                    var mes_nacim = fechan.substr(3, 2);
                    var dia_nacim = fechan.substr(0, 2);
                    $("#rutspanG").html($("#rutdv2").val());
                    $("#nombrespanG").html($("#rebsol_hermesbundle_PagoType_nombrePnatural").val());
                    $("#apepspanG").html($("#rebsol_hermesbundle_PagoType_apellidoPaterno").val());
                    $("#apemspanG").html($("#rebsol_hermesbundle_PagoType_apellidoMaterno").val());
                    $("#fechanspanG").html(fechan);
                    $("#edadspanG").html(calcular_edad(dia_nacim, mes_nacim, anio_nacim));
                    $("#pacienteform, #pacienteresumen, #ExitosoGarantia").hide();
                    $("#ResumenPacienteGarantiaAgenda, #PagoIndex, #datosprestacion").show();

                }
        }

        function IngresaHonorarios(arr, id, datos) {
            if (id != garantiaAuxPrestacion) {
                var data = {datos: datos};
                $.ajax({
                    type: 'get',
                    url: "{{ path('Caja_PostPago_PagoGarantia_BuscarHonorario') }}",
                    data: data,
                    async: false,
                    success: function (data) {

                        if (data == "nosubempresa") {

                            noSubEmpresa();
                            return false;

                        } else {

                            var data = $.parseJSON(data);

                            for (i = 0; i < data.length; i++) {
                                var tr = $("<tr id='prestacion_" + data[i].id + "_" + data[i].idad + "'  name='" + data[i].id + "'></tr>");
                                var td = $("<td id='codigoItem_" + data[i].id + "_" + data[i].idad + "'>" + data[i].codigo + "-" + data[i].codigoFonasa + "</td>");
                                tr.append(td);

                                if (data[i].pabellon !== 0) {
                                    if (data[i].precio !== "0") {
                                        var td = $("<td>" + data[i].pabellon + "</td>");
                                    } else {
                                        var td = $("<td><span class='label label-light'>No Aplica</span></td>");
                                    }
                                } else {
                                    var td = $("<td><span class='label label-light'>No Aplica</span></td>");
                                }
                                tr.append(td);

                                var td = $("<td id='nombreItem_" + data[i].id + "_" + data[i].idad + "'>" + data[i].nombre + " - " + data[i].nombreItem + "</td>");

                                tr.append(td);

                                var td = $("<td id='td" + data[i].id + "_" + data[i].idad + "' class='td" + data[i].id + "'><div id='div" + id + "_" + data[i].idad + "' class='div" + data[i].id + "'><div class='ace-spinner'><div class='input-append btn-group btn-group-vertical'><input type='text' class='" + data[i].id + " input-mini spinner-input cambioCantidad cantidadLista" + data[i].id + "'' id='" + data[i].id + "_" + data[i].idad + "'maxlength='3' style='width: 30px;'></div></div></div><div align='right' class='spanResumen hide'><span id='spanResumen" + data[i].id + "_" + data[i].idad + "' class='hide spanResumen'></span></div></td>");

                                tr.append(td);

                                var precio = data[i].precio;

                                if (precio === "0") {
                                    var precio = "0";
                                }

                                var precioItem = addCommas(precio);
                                var td = $("<td class='precio'><div align='right'><span>$</span><span id='precio" + data[i].id + "_" + data[i].idad + "''>" + precioItem + "</span><span id='precio" + data[i].id + "' class='hide'>" + precio + "</span><span id='tipoDoc" + data[i].id + "_" + data[i].idad + "' class='hide'>1</span></div></td>");
                                tr.append(td);

                                tr.append(td);

                                var td = $("<td><div align='right'><b><span>$</span><span id='sumaCantidad" + data[i].id + "_" + data[i].idad + "'' class='sumaCantidad'>" + precioItem + "</span></b></div></td>");
                                tr.append(td);

                                var td = $("<td></td>");
                                var input = $("<input type='hidden' id='rebsol_hermesbundle_PrestacionType_prestaciones_" + data[i].id + "_" + data[i].idad + "' name='rebsol_hermesbundle_PrestacionType[prestaciones][" + data[i].id + "_" + data[i].idad + "]' value='" + data[i].id + "_" + data[i].idad + "' class='removePrestacion'>");
                                var ahref = $("<a data-id='" + data[i].id + "' class='btn btn-mini btn-danger removePrestacion' onClick='eliminarPrestacion(this)'><i class='icon-remove'></i></a>");

                                td.append(input);
                                td.append(ahref);
                                tr.append(td);
                                $('#prestacionesTable').append(tr);
                                //$("#"+id+"_"+data[i].idad").ace_spinner({value:1,min:1,max:50,step:1, icon_up:'icon-plus', icon_down:'icon-minus', btn_up_class:"btn-success up"+id+"" , btn_down_class:"btn-danger down"+id+""});
                                $("#" + data[i].id + "_" + data[i].idad).val(data[i].cantidad);
                                var id = $("#" + data[i].id + "_" + data[i].idad).closest('input').attr('id');
                                var valor = parseFloat($("#" + id).val());
                                var precio = $("#precio" + id).html();
                                var spanTotalFila = "sumaCantidad" + id;
                                if (valor === 0) {
                                    $("#" + id).val("1");
                                    var valor = parseFloat($("#" + id).val());
                                    SumarFila(valor, precio, spanTotalFila);
                                } else {
                                    SumarFila(valor, precio, spanTotalFila);
                                }
                            }
                        }
                    }
                });

            }

            garantiaAuxPrestacion = id;

        }

        function CargaDatosPrestacionIMed(data, dataAjax, dataPagoCuenta) {
            console.log('CargaDatosPrestacionIMed');
            console.log(data);
            console.log(dataAjax);
            console.log(dataPagoCuenta);
            dataAjax.idPagoCuenta = data.idPagoCuenta;
            $.ajaxSetup({cache: false});
            if (data.pagoCuenta != undefined) {
                dataAjax.pagoCuenta = data.pagoCuenta;
            }
            $.ajax({
                type: 'get',
                url: "{{ path('Caja_PostPago_PagoGarantia_BuscarPrestaciones') }}",
                async: false,
                data: dataAjax,
                success: function (dataPrestacion) {
                    console.log('Caja_PostPago_PagoGarantia_BuscarPrestaciones');
                    console.log(dataPrestacion);
                    if (dataPrestacion != 0) {
                        var dataPrestacion = $.parseJSON(dataPrestacion);
                        console.log(dataPrestacion);
                        var count = dataPrestacion.length;

                        columna = "prestacion";
                        if (dataAjax.tipoAtencion == 2 || dataAjax.tipoAtencion == 3) {
                            columna = "prestacionAccionClinicaPaciente";
                        }

                        for (var i = 0; i < count; i++) {

                            if (dataPrestacion[i]['tipo'] == "p") {
                                dataAjax.prestacion = dataPrestacion[i][columna];
                                agregarPrestacion(dataPrestacion[i]['prestacion'], dataAjax);
                                $("#" + dataPrestacion[i][columna]).val(dataPrestacion[i]['cantidad']);
                                var id = $("#" + dataPrestacion[i][columna]).closest('input').attr('id');
                                var valor = parseFloat($("#" + id).val());
                                var precio = $("#precio" + id).html();
                                var spanTotalFila = "sumaCantidad" + id;

                                if (valor === 0) {
                                    $("#" + id).val("1");
                                    var valor = parseFloat($("#" + id).val());
                                    SumarFila(valor, precio, spanTotalFila);
                                } else {
                                    SumarFila(valor, precio, spanTotalFila);
                                }
                            }
                            if (dataPrestacion[i]['tipo'] == "h") {
                                var datos = {
                                    idPrestacion: dataPrestacion[i]['prestacion'],
                                    plan: $("#rebsol_hermesbundle_PrestacionType_plan").val(),
                                    sucursal: idSucursal,
                                    TipoAtencion: TipoAtencion,
                                    idPaciente: data.idPaciente
                                };
                                IngresaHonorarios(dataPrestacion[i], dataPrestacion[i]['prestacion'], datos);
                            }
                        }
                        almacenaTotal();
                    }
                }
            });
            $.ajaxSetup({cache: false});
            $.ajax({
                type: 'get',
                url: "{{ path('Caja_PostPago_PagoGarantia_BuscarArticulos') }}",
                async: false,
                data: dataAjax,
                success: function (dataArticulo) {
                    if (dataArticulo != 0) {
                        var dataArticulo = $.parseJSON(dataArticulo);
                        var count = dataArticulo.length;
                        for (var i = 0; i < count; i++) {
                            if (dataArticulo[i]) {
                                agregarInsumo(dataArticulo[i]['articulo'], dataAjax, dataArticulo[i]);
                                if (dataAjax.pagoCuenta) {
                                    $("#" + dataArticulo[i]['articulo']).val(dataArticulo[i]['cantidad']);
                                    let spanTotalFila = "sumaCantidad" + dataArticulo[i]['articulo'];
                                    SumarFila(dataArticulo[i]['cantidad'], $('#precio' + dataArticulo[i]['articulo']).html(), spanTotalFila);
                                } else {
                                    $("#" + dataArticulo[i]['articulo']).val(dataArticulo[i]['cantidad']);
                                    let spanTotalFila = "sumaCantidad" + dataArticulo[i]['articulo'];
                                    SumarFila(dataArticulo[i]['cantidad'], $('#precio' + dataArticulo[i]['articulo']).html(), spanTotalFila);
                                }
                            }
                        }
                        almacenaTotal();
                    }
                }
            });

        }

        function CargadatosAdicionalImed(dataPagoCuenta) {
            $.ajax({
                type: 'get',
                url: "{{ path('Caja_PostPago_PagoGarantia_BuscaOtrosMedios') }}",
                async: false, data: dataPagoCuenta,
                success: function (arrayGarantias) {
                    var arrayGarantias = $.parseJSON(arrayGarantias);
                    var countG = arrayGarantias.length;
                    for (var i = 0; i <= countG; i++) {
                        var codeMediosDiv = "<span class='medio" + i + "'></span>";
                        $("#garantiaspan").append(codeMediosDiv);
                        (arrayGarantias[i]) ? (countG > 1) ? $(".medio" + i).html("- " + arrayGarantias[i]['nombre']) :
                            $(".medio" + i).html((arrayGarantias[i]['nombre'] == null) ? ' - ' : arrayGarantias[i]['nombre'])
                            : $("#garantiaspan").append("<div class='clearfix'></div>");
                        $("#garantiaspan").append("<div class='clearfix'></div>");
                        var montoMediosDiv = "<span class='algospan" + i + "'></span>";
                        $("#algospan").append(montoMediosDiv);
                        (arrayGarantias[i]) ? (countG > 1) ? $(".algospan" + i).html("- " + arrayGarantias[i]['montoPagoCuenta']) :
                            $(".algospan" + i).html((arrayGarantias[i]['montoPagoCuenta'] == null) ? ' - ': '$'+ addCommas(arrayGarantias[i]['montoPagoCuenta'])
                        ) : $("#algospan").append("<div class='clearfix'></div>");
                        $("#algospan").append("<div class='clearfix'></div>");
                    }

                }
            });
        }

        /** FIN Busca Informacion Garantia */

    </script>

{% endmacro %}
{# Pago Reserva #}
{% macro PagoReserva() %}
    <script type='text/javascript'>
        //INICIO Busca Informacion Reserva
        function PreparaVistaReserva(id) {
            reserva = 1;
            bootbox.dialog(
                "<div class='alert alert-block alert-success modalEsperaReserva'>" +
                " <i class='icon-spinner icon-spin green bigger-125'> </i><strong class='green'> Cargando Información para Pago de Reserva,</strong><br>Por favor espere..." +
                "<div class='clearfix'></div>" +
                "</div>"
            ).delay(500).promise().done(function () {
                ConsultaDatosReserva(id);
            });
        }

        function ConsultaDatosReserva(id) {
            var okSubempresa = 0;
            var dataReserva = {id: id};
            $.ajaxSetup({cache: false});
            $.ajax({
                type: 'get',
                url: "{{ path('Caja_PostPago_PagoReserva') }}",
                async: false,
                data: dataReserva,
                success: function (data) {
                    var data = $.parseJSON(data);
                    if (data instanceof Object == false) {
                    } else {
                        VerificaDatosPreCargar(data, dataReserva);
                    }
                }
            });
            $('div.modalEsperaReserva').parents('div').modal('hide');
            /*const reservaFolioTmp = localStorage.getItem('reservaFolioTmp');
            localStorage.removeItem('reservaFolioTmp');
            if(!reservaFolioTmp){
                bootbox.dialog("<div class='alert alert-block alert-success'>" +
                    "    <p> <strong><i class='icon-ok'> </i> Datos Cargados Exitósamente</strong> </p> </div>", [
                    {
                        "label": "Aceptar",
                        "class": "btn btn-mini alert",
                        "callback": function () {
                        }
                    }]);
            }*/
        }

        function VerificaDatosPreCargar(data, dataReserva) {
            var dataAjax = dataReserva;
            $.ajax({
                type: 'get',
                url: "{{ path('Caja_PostPago_PagoReserva_VerificaSubEmpresaActualCajero_PrestacionesInsumos') }}",
                async: false, data: dataAjax,
                success: function (answer) {
                    okSubempresa = answer;
                }
            });
            if (okSubempresa == 1) {
                noSubEmpresa();
            }
            if (okSubempresa == 0) {
                CargaDatosFinanciadorReserva(data, dataAjax, dataReserva);
            }

        }

        function CargaDatosFinanciadorReserva(data, dataAjax, dataReserva) {
            console.log('CargaDatosFinanciadorReserva::data')
            console.log(data)
            // cargaDatos(data.financiador);
            if($("#rebsol_hermesbundle_PrestacionType_prevision").val()===null){
                cargaDatos(data.financiador);
            }else{
                cargaDatos(parseInt($("#rebsol_hermesbundle_PrestacionType_prevision").val()));
            }
            esTratamientoAgenda = (data.esTratamiento) ? 1 : 0;
            if($("#rebsol_hermesbundle_PrestacionType_prevision").val()===null) {
                 $("#rebsol_hermesbundle_PrestacionType_prevision").val(data.financiador);
                ;
            }
            $("#rebsol_hermesbundle_PrestacionType_prevision").trigger("liszt:updated");
            if (data.convenio) {
                if($("#rebsol_hermesbundle_PrestacionType_convenio").val()===null) {
                    $("#rebsol_hermesbundle_PrestacionType_convenio").val(data.convenio).attr("disabled", true);
                    ;
                }
                $("#rebsol_hermesbundle_PrestacionType_convenio").trigger("liszt:updated");
                // cargaDatos(data.convenio);
                if($("#rebsol_hermesbundle_PrestacionType_convenio").val()===null) {
                    cargaDatos(data.convenio);
                }else{
                    cargaDatos(parseInt($("#rebsol_hermesbundle_PrestacionType_convenio").val()));
                }
            } else {
                if($("#rebsol_hermesbundle_PrestacionType_convenio").val()===null) {
                    $("#rebsol_hermesbundle_PrestacionType_convenio").val(data.convenio).attr("disabled", false);
                    ;
                }
                $("#rebsol_hermesbundle_PrestacionType_convenio").trigger("liszt:updated");
            }
            if (data.profesional) {
                $("#rebsol_hermesbundle_PrestacionType_derivadoSelect").val(data.profesional).attr("disabled", true);
                ;
                $("#rebsol_hermesbundle_PrestacionType_derivadoSelect").trigger("liszt:updated");
                $(".ExternoField").hide();
            }
            if (esTratamientoAgenda == 0) {
                CargaDatosPrestacionReserva(dataAjax);
            } else {
                $(".AlertEsTratamiento").show();
            }
            creaListaHistorica();
        }

        function CargaDatosPrestacionReserva(dataAjax) {
            console.log('CargaDatosPrestacionReserva::dataAjax')
            console.log(dataAjax)
            $.ajaxSetup({cache: false});
            $.ajax({
                type: 'get',
                url: "{{ path('Caja_PostPago_PagoReserva_BuscarPrestaciones') }}",
                async: false,
                data: dataAjax,
                success: function (dataPrestacion) {
                    if (dataPrestacion != 0) {
                        var dataPrestacion = $.parseJSON(dataPrestacion);
                        Listaprestaciones = dataPrestacion;
                        formularioSinTratamiento();
                    }
                }
            });
        }

        //FIN Busca Informacion Reserva

    </script>

{% endmacro %}
					{# Genera Diferencia #}
					{% macro Diferencia() %}
                        <script type='text/javascript'>


                            $('#btn-diferencia').on('click', function (e) {
                                // $("#btn-diferencia").css('pointer-events','none');
                                if (verificaPrestacionInsumoExiste() == true) {

                                    var Listaprestaciones = [];
                                    var d = 0;

                                    $('.cambioCantidad').each(function () {
                                        var row = $(this).closest('tr');
                                        var a = row.attr('name');
                                        var aa = ($(this).parents().eq(5).attr('id').replace("td", "") !== 'prestacionesTable') ? $(this).parents().eq(5).attr('id').replace("td", "") : $(this).parents().eq(3).attr('id').replace("td", "");
                                        var b = $(this).val();
                                        var c = $("#precio" + aa).text();
                                        var x = $("#tipoDoc" + aa).text();
                                        var xa = $("#codigoItem_" + aa).text();
                                        var xb = $("#nombreItem_" + aa).text();
                                        var prestaciones = [a, b, c, x, xa, xb];
                                        Listaprestaciones[d] = prestaciones;
                                        d++;
                                        var prestaciones = [];

                                    });

                                    const esPrestacionCero = (prestacion) => {
                                        return prestacion[2] === "0";
                                    }
                                    let prestacionesValorCero = Listaprestaciones.filter(esPrestacionCero);
                                    /* /
                                     * Se elimina validación de de prestacion costo cero
                                     * */
                                    // if (prestacionesValorCero.length === 0) {
                                    if (0 === 0) {
                                        var dato = {
                                            count: $(".cambioCantidad").length,
                                            listaPrestaciones: Listaprestaciones
                                        };

                                        $.ajax({
                                            type: 'get',
                                            url: "{{ path('Caja_Diferencia_SendCountPrestacionArticulo') }}",
                                            async: false,
                                            data: dato
                                        });

                                        /*
                                        //Solución hi-8445; se comenta bloque de codigo ya que al momento de aplicar una diferencia y deseas no aplicar y le das volver,
                                        // este bloque de codigo cancela el evento enter de busqueda paciente.
                                        $(document).on('keypress', function (e) {
                                            if (e.which == 13) {
                                                e.preventDefault();
                                                e.stopPropagation();
                                                return false;
                                            }
                                        });*/
                                        e.preventDefault();
                                        {# var route = "{{ path('Caja_Diferencia_Generar', { 'id': 000 }) }}";
								window.location = route.replace(000, $(".cambioCantidad").length); #}
                                        $(".modalDiferencia").load($(this).attr('href'), function (response, status, xhr) {
                                            $(".modalDiferencia").html('');
                                            EnviarFormularioDiferencia(response, '#formDiferencia');
                                        });
                                        $(".modalDiferencia").html('');

                                    } else {
                                        bootbox.dialog("<strong class='red'>Alerta</strong>,<br><strong>No Puede Aplicar Diferencia a una prestación con $0.", [{
                                            "label": "Aceptar",
                                            "class": "btn btn-mini alert",
                                            "callback": function () {
                                            }
                                        }]);
                                    }


                                } else {

                                    bootbox.dialog("<strong class='red'>Alerta</strong>,<br><strong>Debe seleccionar algun servicio para poder generar Diferencia.", [{
                                        "label": "Aceptar",
                                        "class": "btn btn-mini alert",
                                        "callback": function () {

                                        }

                                    }]);
                                }
                            });

							$('#btn-diferencia-saldo').on('click', function (e) {
								//$("#btn-diferencia-saldo").css('pointer-events', 'none');
								if (verificaPrestacionInsumoExiste() == true) {


                                    var saldo = $("#SaldoTotalMediosDePago").text();
                                    saldo = saldo.replace(",", "");


                                    if (parseInt(saldo) === 0) {
                                        bootbox.dialog("<strong class='red'>Alerta</strong>,<br><strong>No Puede Aplicar Diferencia a Saldo $0.", [
                                            {
                                                "label": "Aceptar",
                                                "class": "btn btn-mini alert",
                                                "callback": function () {

                                                }
                                            }]);
                                    } else {
                                        var data = {saldo: saldo};

                                        var ruta = $(this).attr('href');
                                        $.ajax({
                                            type: 'get',
                                            url: ruta,
                                            data: data,
                                            success: function (response) {
                                                $(".modalDiferencia").html('');
                                                EnviarFormularioDiferencia(response, '#formDiferenciaSaldo');
                                            }
                                        });
                                    }

                                } else {
                                    bootbox.dialog("<strong class='red'>Alerta</strong>,<br><strong>Debe seleccionar algun servicio para poder generar Diferencia.", [
                                        {
                                            "label": "Aceptar",
                                            "class": "btn btn-mini alert",
                                            "callback": function () {

                                            }
                                        }]);
                                }
                            });

                            function EnviarFormularioDiferencia(vistaHtml, form) {
                                $(".modalDiferencia").html('');
                                bootbox.dialog(vistaHtml);
                            }

                            function obtieneCantidadPrestaciones() {
                                return $(".cambioCantidad").length;
                            }

                            function anularDiferencia() {
                                var dato = {
                                    idDiferencia: ListaInformacionDiferencia['idDiferencia']
                                };
                                mensajeAnulacionDiferencia(dato);


                            }

                            function mensajeAnulacionDiferencia(a) {
                                bootbox.dialog("<div class='alert alert-block alert-danger'><strong class='red'>Alerta</strong>,<br><strong>Se anulará la Diferencia Actual, Desea continuar?</div>", [
                                    {
                                        "label": "Continuar",
                                        "class": "btn btn-mini alert",
                                        "callback": function () {
                                            anulaDiferencia(a, addCommas(ListaInformacionDiferencia['subTotal']));
                                        }
                                    }, {

                                        "label": "Cancelar",
                                        "class": "btn btn-mini alert",
                                        "callback": function () {

                                        }
                                    }]);
                            }

                            function anulaDiferencia(a, b) {
                                $.ajax({
                                    type: 'get',
                                    url: "{{ path('Caja_Diferencia_Anular') }}",
                                    async: false,
                                    data: a,
                                    success: function (o) {
                                        bootbox.dialog("<div class='alert alert-block alert-success'><strong class='green'></strong><strong>Diferencia Anulada Exitosamente</div>", [
                                            {
                                                "label": "Aceptar",
                                                "class": "btn btn-mini alert",
                                                "callback": function () {
                                                    esDiferencia = 0;
                                                    SumarColumna();
                                                    $("#trDiferencia").hide();
                                                    $("#trDiferencia").addClass("hidden");
                                                    $("#btn-diferencia").removeClass('hidden');
                                                    $("#btn-diferencia").show();
                                                    $("#btn-diferencia").css('pointer-events', 'auto');
                                                    $('#diferenciaTotal').html("");
                                                    $('#sumaTotal').html(b);
                                                    $('#sumaTotalMediosDePago').html(b);
                                                    var ListaInformacionDiferencia = [];
                                                    localStorage.setItem('VariableSumaCantidad', removeComas(b));
                                                    let VariableSumaCantidad = localStorage.getItem('VariableSumaCantidad');
                                                    Caja_Valmacena_Total_Suma(VariableSumaCantidad)
                                                    Caja_Valor_Pagar(b)
                                                    $('#btn-diferencia').show();

                                                }
                                            }
                                        ]);
                                    }
                                });
                            }

                            function calculaNuevoMontoDiferencia(totalConGarantia) {

                                localStorage.setItem('VariableSumaCantidad', totalConGarantia);
                                var vSumaCantidad = localStorage.getItem('VariableSumaCantidad');
                                var data = {
                                    vSumaCantidad: vSumaCantidad
                                };
                                $.ajaxSetup({cache: false});
                                $.ajax({
                                    type: 'get',
                                    url: "{{ path('Caja_Valmacena_Total_Suma') }}",
                                    async: false,
                                    data: data,
                                    success: function (data) {
                                        $("#sumaTotal").html(addCommas(data));
                                    }
                                });
                            }


                        </script>
                    {% endmacro %}

				{# Pagar #}

				{% macro Pagar() %}

                    <script type='text/javascript'>

                        function SPC() {

                            $(".bar").css({width: "20%"}).delay(100);
                            localStorage.setItem('CMP_VP', removeComas($("#sumaTotalMediosDePago").text()));
                            var CMP_VP = localStorage.getItem('CMP_VP');

                            $(".bar").css({width: "20%"}).delay(100).promise().done(function () {
                                SPF();
                            });

                        }

                        function SPF() {
                            $(".spcb").hide()
                            $(".bar").css({width: "40%"}).delay(100);
                            var CantidadPrestaciones = $(".cambioCantidad ").length;
                            var ListaDiferencia = [];
                            var ListaDiferenciaSaldo = [];

                            var Listaprestaciones = [];
                            var d = 0;


                            $('.cambioCantidad').each(function () {
                                var row = $(this).closest('tr');
                                var a = row.attr('name');
                                var aa = ($(this).parents().eq(5).attr('id').replace("td", "") !== 'prestacionesTable') ? $(this).parents().eq(5).attr('id').replace("td", "") : $(this).parents().eq(3).attr('id').replace("td", "");
                                var b = $(this).val();
                                var c = removeComas($("#precio" + aa).text());
                                var x = $("#tipoDoc" + aa).text();
                                if ($("#examenPacienteFc" + a).length == 0) {
                                    var idExamen = null;
                                } else {
                                    var idExamen = $("#examenPacienteFc" + a).val();
                                }
                                var idPagoCuenta = $("#idPagoCuenta" + aa).val();
                                var idAccionClinicaPaciente = $("#idAccionClinicaPaciente" + aa).val();
                                var idDetalleTratamiento = $("#td" + aa).data('iddetalletratamiento');
                                var prestaciones = [a, b, c, x, idExamen, idPagoCuenta, idAccionClinicaPaciente, idDetalleTratamiento]
                                Listaprestaciones[d] = prestaciones;
                                d++;
                                var prestaciones = [];

                            });

                            if (esDiferencia == 1) {
                                for (i = 0; i < 7; i++) {
                                    var n = arrayParaDiferencia(i);
                                    ListaDiferencia[i] = ListaInformacionDiferencia[n];
                                }
                            }
                            if (esDiferenciaSaldo == 1) {
                                for (i = 0; i < 5; i++) {
                                    var n = arrayParaDiferenciaSaldo(i);
                                    ListaDiferenciaSaldo[i] = ListaInformacionDiferenciaSaldo[n];
                                }
                            }

                            if ($(".mdp").hasClass("active")) {
                                var formaPago = 0;
                            }

                            if ($(".omdp").hasClass("active")) {
                                var formaPago = 1;
                            }

                            let formProfesional = {};
                            if ($('#formRisLis').is(":visible")) {
                                var rutProfesional = $('#inputRutProfesionalRisLis').val();
                                var nombresProfesional = $('#inputNombresProfesionalRisLis').val();
                                var apePaternoProfesional = $('#inputApellidoPatProfesionalRisLis').val();
                                var apeMaternoProfesional = $('#inputApellidoMatProfesionalRisLis').val();
                                var observacion = $('#inputObservacionRisLis').val();

                                formProfesional = {
                                    'rutProfesional': rutProfesional,
                                    'nombresProfesional': nombresProfesional,
                                    'apePaternoProfesional': apePaternoProfesional,
                                    'apeMaternoProfesional': apeMaternoProfesional,
                                    'observacion': observacion
                                }
                            }

                            var rut = $('#rebsol_hermesbundle_PagoType_rutPersona').val();
                            var dv = $('#rebsol_hermesbundle_PagoType_digitoVerifivador').val();

                            var documentoExtranjero = $('#rebsol_hermesbundle_PagoType_numeroDocumento').val();
                            var tipoDocumentoExtranjero = $('#rebsol_hermesbundle_PagoType_documento').val();

                            var documentoPorDefecto = rut + '-' + dv;

                            if (tipoDocumentoExtranjero == 1) {

                                documentoPorDefecto = documentoPorDefecto;
                            } else {

                                documentoPorDefecto = documentoExtranjero;
                            }

                            $.ajax({
                                type: 'GET',
                                url: "{{ path('Caja_PeopleId') }}",
                                data: {
                                    'tipoDocumentoExtranjero': tipoDocumentoExtranjero,
                                    'documentoPorDefecto': documentoExtranjero
                                }, success: function (data) {
                                    var data = $.parseJSON(data);
                                    $(".bar").css({width: "40%"}).delay(100).promise().done(function () {
                                        IDB(data, Listaprestaciones, formaPago, ListaDiferencia, ListaDiferenciaSaldo, formProfesional);
                                    });
                                }
                            });
                        }
                        function regulatizaGarantia() {
                            var data = {
                                idPagoCuenta: $("#checkRegularizar").data('idpagocuenta'),
                                observacionRegularizacion: $("#observacionRegularizacion").val(),
                            };
                            $.ajax({
                                type: 'POST',
                                url: "{{ path('Caja_PostPago_Regularizar_Garantia') }}",
                                data: data,
                                success: function (respuesta) {
                                    console.log(respuesta)
                                    bootbox.dialog("<div class='alert alert-block alert-success'>" +
                                        "    <p>" +
                                        "    <strong><i class='icon-ok'></i> Regularización Exitosa</strong>" +
                                        "    </p>" +
                                        "</div>", [
                                        {
                                            "label": "Aceptar",
                                            "class": "btn btn-mini alert",
                                            "callback": function () {
                                                bootbox.hideAll();
                                                location.reload();
                                            }
                                        }]);

                                },
                                error: function (jqXHR, textStatus, errorThrown) {
                                    bootbox.dialog("<strong class='red'>ERROR EN REGULARIZACION</strong>,<br><strong>Problemas de Comunicación</strong>,<br>No se ha podido efectuar la regularización..", [
                                        {
                                            "label": "Aceptar",
                                            "class": "btn btn-mini alert",
                                            "callback": function () {
                                                bootbox.hideAll();
                                            }
                                        }]);
                                },
                            });
                        }

                        function IDB(data, Listaprestaciones, formaPago, ListaDiferencia, ListaDiferenciaSaldo, formProfesional = []) {
                           $(".spcb").hide()
                            var auxBoleta = "";
                            $(".bar").css({width: "50%"}).delay(100);
                            var idReserva = idReservaAtencion;

                            if ($("#rebsol_hermesbundle_PrestacionType_derivadoExternoRut").val() != null) {
                                var derivadoRutExtAux = $("#rebsol_hermesbundle_PrestacionType_derivadoExternoRut").val();
                                var largo = derivadoRutExtAux.replace("-", "").length;
                                var r = derivadoRutExtAux.replace("-", "").substr(0, largo - 1);
                                var dv = derivadoRutExtAux.replace("-", "").substr(largo - 1, largo);
                                var derivadoRutExtArray = [r, dv];
                            } else {
                                var derivadoRutExtArray = null;
                            }

                            var formularios = {
                                idPnatural: data,
                                financiador: $("#rebsol_hermesbundle_PrestacionType_prevision").val(),
                                convenio: $("#rebsol_hermesbundle_PrestacionType_convenio").val(),
                                plan: $("#rebsol_hermesbundle_PrestacionType_plan").val(),
                                origen: $("#rebsol_hermesbundle_PrestacionType_origenSelect").val(),
                                derivadoInt: $("#rebsol_hermesbundle_PrestacionType_derivadoSelect").val(),
                                derivadoExt: $("#rebsol_hermesbundle_PrestacionType_derivadoExterno").val(),
                                derivadoRutExt: derivadoRutExtArray,
                                caja: idCaja,
                                sucursal: idSucursal,
                                ListaPrestacion: Listaprestaciones,
                                idReservaAtencion: idReserva,
                                TipoDeMedioPago: formaPago,
                                ListaTratamiento: (esTratamiento == 1) ? TratamientoArray : null,
                                ListaDiferencia: (esDiferencia == 1) ? ListaDiferencia : null,
                                ListaDiferenciaSaldo: (esDiferenciaSaldo == 1) ? ListaDiferenciaSaldo : null,
                                idDerivadoExterno: idDerivadoExterno,
                                idPrePagoCuenta: $("#idPrePagoCuenta").val(),
                                formProfesional: formProfesional
                            };

                            $.ajax({
                                type: 'get',
                                url: "{{ path('Caja_CasePay') }}",
                                async: false,
                                data: formularios,
                                success: function (respuesta) {
                                    // respuesta = $.trim(respuesta);
                                    if (respuesta === 'ok') {

                                        if (formaPago == 0) {
                                            /**
                                             * @todo Seguir Aqui con  TipoDeMedioPago: formaPago
                                             * @type {[type]}
                                             */
                                            var formPagos = $("#formMedios").serializeArray();
                                        } else {
                                            var formPagos = $("#formOtros").serializeArray();
                                        }
                                        $(".bar").css({width: "90%"}).delay(100);

                                        $.ajax({
                                            type: 'POST',
                                            url: "{{ path('Caja_CasePayMediosPago') }}",
                                            data: formPagos,
                                            // timeout: 20000,
                                            success: function (respuesta) {
// console.log(respuesta); return false;
                                                $(".spcb").css('pointer-events', 'auto');

                                                // respuesta = $.trim(respuesta);
// console.log(respuesta); return false;
                                                if(respuesta['mensaje'] === 'afectoConExencionSinBonos'){

                                                    bootbox.dialog("<div class='alert alert-block alert-danger'>" +
                                                        "    <p>" +
                                                        "    <strong><i class='icon-ok'></i> No se puede realizar el pago </strong>" +
                                                        "    <p>" +
                                                        "   Advertencia: Se está realizando el pago con una Isapre por lo que se debe emitir por lo menos con un tipo de bono " +
                                                        "    </p>" +
                                                        "</div>", [
                                                        {
                                                            "label": "Aceptar",
                                                            "class": "btn btn-mini alert",
                                                            "callback": function () {
                                                                bootbox.hideAll();
                                                            }
                                                        }]);

                                                    return false;
                                                }

                                                else if (respuesta['mensaje'] === 'pagado' || respuesta['mensaje'] === 'pagadoConErroresGeneracionDte') {

                                                    if (!idReservaAtencion) {
                                                        creaListaHistorica();
                                                    } else {
                                                        if (cajaAgenda === 0) {
                                                            if($.fn.fullCalendar) {
                                                                $('#calendar').fullCalendar('refetchEvents');
                                                                $('#calendarPanoramica').fullCalendar('refetchEvents');
                                                            } else {
                                                                location.reload();
                                                            }
                                                        } else {
                                                            creaListaHistorica();
                                                        }
                                                    }
                                                    $(".bar").css({width: "100%"}).delay(1000);
                                                    $('div.progress').parents('div').fadeOut();
console.log('creaListaHistorica!!!');
                                                    let mensajePago = '';
                                                    let alert = '';
                                                    if (respuesta['mensaje'] === 'pagado') {
                                                        mensajePago = 'Pagado Correctamente';
                                                        alert = 'alert-success';

                                                    } else {
                                                        mensajePago = 'Pagado Correctamente con problemas en la generación del documento electrónico. ' +
                                                            'Por favor reintentar la sección "Listado de Pagos Efectuados por Paciente" los pagos pendientes';
                                                        alert = 'alert-danger';
                                                    }
                                                    console.log('mensaje');
                                                    console.log(respuesta['mensaje']);
                                                    bootbox.dialog("<div class='alert alert-block " + alert +"'>" +
                                                        "    <p>" +
                                                        "    <strong><i class='icon-ok'></i> " + mensajePago + "</strong>" +
                                                        "    </p>" +
                                                        "</div>", [
                                                        {
                                                            "label": "Aceptar",
                                                            "class": "btn btn-mini alert",
                                                            "callback": function () {
                                                                if (idReservaAtencion) {
                                                                    if (cajaAgenda === 0) {
                                                                        if($.fn.fullCalendar) {
                                                                            $('#calendar').fullCalendar('refetchEvents');
                                                                            $('#calendarPanoramica').fullCalendar('refetchEvents');
                                                                        } else {
                                                                            location.reload();
                                                                        }
                                                                    }
                                                                }

                                                                bootbox.hideAll();
                                                                if('data' in respuesta && respuesta['data']){
                                                                    enviarAImprimirBoleta(respuesta['data']);
                                                                }

                                                                verificaCorrelativo();
                                                                PagadoAceptar();

                                                            }
                                                        }]);
                                                } else if (respuesta['mensaje'] === 'varios') {
                                                    if (!idReservaAtencion) {

                                                        creaListaHistorica();
                                                    } else {
                                                        if (cajaAgenda === 0) {
                                                            if($.fn.fullCalendar) {
                                                                $('#calendar').fullCalendar('refetchEvents');
                                                                $('#calendarPanoramica').fullCalendar('refetchEvents');
                                                            } else {
                                                                location.reload();
                                                            }
                                                        } else {
                                                            creaListaHistorica();
                                                        }
                                                    }
                                                    $(".bar").css({width: "100%"}).delay(1000);
                                                    $('div.progress').parents('div').fadeOut();
                                                    bootbox.dialog("<div class='alert alert-block alert-success'>" +
                                                        "    <p>" +
                                                        "    <strong><i class='icon-ok'></i> Pagado Correctamente</strong>" +
                                                        "    </p>" +
                                                        "</div>", [
                                                        {
                                                            "label": "Aceptar",
                                                            "class": "btn btn-mini alert",
                                                            "callback": function () {
                                                                if (!idReservaAtencion) {
                                                                    PagadoAceptarDocumentos();
                                                                    bootbox.hideAll();
                                                                } else {
                                                                    if (cajaAgenda === 0) {
                                                                        if($.fn.fullCalendar) {
                                                                            $('#calendar').fullCalendar('refetchEvents');
                                                                            $('#calendarPanoramica').fullCalendar('refetchEvents');
                                                                        } else {
                                                                            location.reload();
                                                                        }
                                                                        bootbox.hideAll();
                                                                        verificaCorrelativo();
                                                                        PagadoAceptarDocumentos();
                                                                    } else {
                                                                        PagadoAceptarDocumentos();
                                                                    }


                                                                }
                                                            }
                                                        }]);

                                                } else if (respuesta['mensaje'] == 1) {

                                                    if (!idReservaAtencion) {
                                                        creaListaHistorica();
                                                    } else {
                                                        if (cajaAgenda === 0) {
                                                            if($.fn.fullCalendar) {
                                                                $('#calendar').fullCalendar('refetchEvents');
                                                                $('#calendarPanoramica').fullCalendar('refetchEvents');
                                                            } else {
                                                                location.reload();
                                                            }
                                                        } else {
                                                            creaListaHistorica();
                                                        }
                                                    }
                                                    $(".bar").css({width: "100%"}).delay(1000);
                                                    bootbox.dialog("<div class='alert alert-block alert-success'>" +
                                                        "    <p>" +
                                                        "    <strong><i class='icon-ok'></i> Pagado Correctamente</strong>" +
                                                        "    </p>" +
                                                        "</div>", [
                                                        {
                                                            "label": "Aceptar",
                                                            "class": "btn btn-mini alert",
                                                            "callback": function () {
                                                                if (!idReservaAtencion) {
                                                                    bootbox.hideAll();
                                                                } else {
                                                                    if (cajaAgenda === 0) {
                                                                        if($.fn.fullCalendar) {
                                                                            $('#calendar').fullCalendar('refetchEvents');
                                                                            $('#calendarPanoramica').fullCalendar('refetchEvents');
                                                                        } else {
                                                                            location.reload();
                                                                        }
                                                                    } else {
                                                                        bootbox.hideAll();
                                                                    }
                                                                }
                                                                PagoConBoleta();

                                                            }
                                                        }]);

                                                } else if(respuesta['mensaje'] === 'sinPrestaciones'){

                                                    bootbox.dialog("<div class='alert alert-block alert-danger'>" +
                                                        "    <p>" +
                                                        "    <strong><i class='icon-ok'></i> No se puede realizar el pago </strong>" +
                                                        "    <p>" +
                                                        "   Advertencia: No se puede realizar el pago debido a que no hay prestaciones asociadas " +
                                                        "    </p>" +
                                                        "</div>", [
                                                        {
                                                            "label": "Aceptar",
                                                            "class": "btn btn-mini alert",
                                                            "callback": function () {
                                                                bootbox.hideAll();
                                                            }
                                                        }]);

                                                    return false;
                                                }
                                            },
                                            error: function (jqXHR, textStatus, errorThrown) {
                                                if (textStatus === "timeout") {
                                                    if (!idReservaAtencion) {
                                                        bootbox.hideAll();
                                                    } else {
                                                        if (cajaAgenda === 0) {
                                                        } else {
                                                            bootbox.hideAll();
                                                        }
                                                    }
                                                    bootbox.dialog("<strong class='red'>ERROR EN PAGO</strong>,<br><strong>Se agotó el tiempo de ejecución</strong>,<br>No se ha podido efectuar el pago, verifique su conexión y reintente.", [
                                                        {
                                                            "label": "Aceptar",
                                                            "class": "btn btn-mini alert",
                                                            "callback": function () {
                                                                if (!idReservaAtencion) {
                                                                    bootbox.hideAll();
                                                                }

                                                            }
                                                        }]);
                                                }
                                            }
                                        });
                                    } else {
                                        if (!idReservaAtencion) {
                                            bootbox.hideAll();
                                        } else {
                                            if (cajaAgenda === 0) {
                                                if($.fn.fullCalendar) {
                                                    $('#calendar').fullCalendar('refetchEvents');
                                                    $('#calendarPanoramica').fullCalendar('refetchEvents');
                                                } else {
                                                    location.reload();
                                                }
                                            } else {
                                                bootbox.hideAll();
                                            }
                                        }
                                        bootbox.dialog("<strong class='red'>ERROR EN PAGO</strong>,<br><strong>Problemas de Comunicación</strong>,<br>No se ha podido efectuar el pago..", [
                                            {
                                                "label": "Aceptar",
                                                "class": "btn btn-mini alert",
                                                "callback": function () {

                                                }
                                            }]);
                                    }
                                }
                            });

                        }


                        function arrayParaDiferencia(i) {
                            switch (i) {
                                case 0:
                                    n = 'como';
                                    break;
                                case 1:
                                    n = 'agrupcion';
                                    break;
                                case 2:
                                    n = 'tipoDiferenciaGlobal';
                                    break;
                                case 3:
                                    n = 'subTotal';
                                    break;
                                case 4:
                                    n = 'DifTotal';
                                    break;
                                case 5:
                                    n = 'FullTotal';
                                    break;
                                case 6:
                                    n = 'listadoPrestaciones';
                                    break;
                            }
                            return n;
                        }

                        function arrayParaDiferenciaSaldo(i) {
                            switch (i) {
                                case 0:
                                    n = 'tipoDiferenciaGlobal';
                                    break;
                                case 1:
                                    n = 'subTotal';
                                    break;
                                case 2:
                                    n = 'DifTotal';
                                    break;
                                case 3:
                                    n = 'FullTotal';
                                    break;
                                case 4:
                                    n = 'motivoDiferencia'; break;
                            }
                            return n;
                        }


                        function PagoConBoleta() {

                            $.ajax({
                                type: 'get',
                                url: "{{ path('Caja_PostPago_Boleta') }}",
                                success: function (respuesta) {
                                    if (!idReservaAtencion) {
                                        bootbox.hideAll();
                                    } else {
                                        if (cajaAgenda === 0) {
                                        } else {
                                            bootbox.hideAll();
                                        }
                                    }
                                    $(".modalVerBoleta").html('');
                                    var vistaHtml = respuesta;
                                    bootbox.dialog(vistaHtml, [
                                        {
                                            "label": "<i class='icon-arrow-left'></i> Aceptar",
                                            "class": "btn btn-mini",
                                            "callback": function () {
                                                $(".modalVerBoleta").html('');
                                                if (idReservaAtencion) {
                                                    if (cajaAgenda === 0) {
                                                        bootbox.hideAll();
                                                        $("#loading").hide();
                                                    } else {
                                                        bootbox.hideAll();
                                                        verificaCorrelativo();
                                                        PagadoAceptar();
                                                    }
                                                } else {
                                                    bootbox.hideAll();
                                                    verificaCorrelativo();
                                                    PagadoAceptar();
                                                }
                                            }
                                        },
                                        {
                                            "label": "<i class='icon-print'></i> Imprimir",
                                            "class": "btn btn-mini btn-success btn-print",
                                            "callback": function () {
                                                bucleBoleta();
                                                $("#formBoleta").submit();
                                                if (!idReservaAtencion) {
                                                    bootbox.hideAll();
                                                } else {
                                                    if (cajaAgenda === 0) {
                                                    } else {
                                                        bootbox.hideAll();
                                                    }
                                                }
                                            }
                                        }
                                    ]);
                                }
                            });
                        }

                        function bucleBoleta() {
                            PagoConBoleta();
                        }

                        function IDB2(data, Listaprestaciones) {
                            $(".bar").css({width: "60%"});
                            var formularios = {
                                idPnatural: data,
                                financiador: $("#rebsol_hermesbundle_PrestacionType_prevision").val(),
                                convenio: $("#rebsol_hermesbundle_PrestacionType_convenio").val(),
                                plan: $("#rebsol_hermesbundle_PrestacionType_plan").val(),
                                origen: $("#rebsol_hermesbundle_PrestacionType_origenSelect").val(),
                                derivadoInt: $("#rebsol_hermesbundle_PrestacionType_derivadoSelect").val(),
                                derivadoExt: $("#rebsol_hermesbundle_PrestacionType_derivadoExterno").val(),
                                ListaPrestacion: Listaprestaciones,
                                idReservaAtencion: idReservaAtencion
                            };
                            $.ajax({
                                type: 'get',
                                url: "{{ path('Caja_CasePayApi') }}",
                                async: false,
                                data: formularios,
                                success: function (respuesta) {
                                    respuesta = $.trim(respuesta);
                                    if (respuesta === 'Pagado') {
                                        $(".bar").css({width: "100%"});
                                        bootbox.hideAll();
                                        bootbox.dialog("<div class='alert alert-block alert-success'>" +
                                            "    <p>" +
                                            "    <strong><i class='icon-ok'></i> Pagado Correctamente</strong>" +
                                            "    </p>" +
                                            "</div>", [
                                            {
                                                "label": "Aceptar",
                                                "class": "btn btn-mini alert",
                                                "callback": function () {
                                                    if($.fn.fullCalendar) {
                                                        $('#calendar').fullCalendar('refetchEvents');
                                                        $('#calendarPanoramica').fullCalendar('refetchEvents');
                                                    } else {
                                                        location.reload();
                                                    }
                                                    bootbox.hideAll();

                                                }
                                            }]);
                                    } else {
                                        bootbox.hideAll();
                                        bootbox.dialog("<strong class='red'>ERROR DE DATOS</strong>,<br><strong>Datos Corruptos en Pago</strong>,<br>Deberá reingrsar correctamente los montos en los medios de pago.", [
                                            {
                                                "label": "Aceptar",
                                                "class": "btn btn-mini alert",
                                                "callback": function () {

                                                }
                                            }]);
                                    }
                                }
                            });

                        }

                        function DocumentosPostPago() {
                            $(".bar").css({width: "50%"});
                            var ruta = "{{ path('Caja_PostPago_DocumentosPostPago') }}";
                            $(".modalVerDocs").load(ruta, function (response, status, xhr) {
                                var vistaHtml = response;
                                $(".modalVerDocs").html('');
                                $(".bar").css({width: "100%"});
                                bootbox.dialog(vistaHtml, [{
                                    "label": "Aceptar",
                                    "class": "btn btn-mini btn-info",
                                    "callback": function () {
                                        if (!idReservaAtencion) {
                                            verificaCorrelativo();
                                            PagadoAceptar();
                                            bootbox.hideAll();
                                        } else {
                                            if (cajaAgenda === 0) {
                                                bootbox.hideAll();
                                                verificaCorrelativo();
                                            } else {
                                                verificaCorrelativo();
                                                PagadoAceptar();
                                                bootbox.hideAll();
                                            }


                                        }
                                    }


                                }]);
                            });
                            $(".modalVerDocs").html('');
                        }

                        function reservarFolioGlobal(idPrestacion, financiador) {
                            var Listaprestaciones = [];
                            var d = 0;

                            $('.cambioCantidad').each(function () {
                                var row = $(this).closest('tr');
                                var a = row.attr('name');
                                var aa = ($(this).parents().eq(5).attr('id').replace("td", "") !== 'prestacionesTable') ? $(this).parents().eq(5).attr('id').replace("td", "") : $(this).parents().eq(3).attr('id').replace("td", "");
                                //var aa = row.find('.cantidad').attr('id').replace("td", "");
                                var b = $(this).val();
                                var c = removeComas($("#precio" + aa).text());
                                var x = $("#tipoDoc" + aa).text();
                                if ($("#examenPacienteFc" + a).length == 0) {
                                    var idExamen = null;
                                } else {
                                    var idExamen = $("#examenPacienteFc" + a).val();
                                }
                                var idPagoCuenta = $("#idPagoCuenta" + aa).val();
                                var idAccionClinicaPaciente = $("#idAccionClinicaPaciente" + aa).val();
                                var idDetalleTratamiento = $("#td" + aa).data('iddetalletratamiento');
                                var prestaciones = [a, b, c, x, idExamen, idPagoCuenta, idAccionClinicaPaciente, idDetalleTratamiento];
                                Listaprestaciones[d] = prestaciones;
                                d++;
                                var prestaciones = [];

                            });

                            var data = {
                                idPrestacion: idPrestacion,
                                ListaPrestacion: Listaprestaciones,
                                financiador: financiador
                            };
                            var resultado;

                            $.ajax({
                                type: 'get',
                                url: "{{ path('Caja_reservarFolio') }}",
                                data: data,
                                async: false,
                                success: function (data) {

                                    if (data['message'] == 'nohaytalonario') {
                                        noTalonarioDisponible(data['subempresa']);
                                        resultado = false;
                                    } else if (data['message'] == 'nohayfolios') {
                                        noFolioDisponible(data['subempresa']);
                                        resultado = false;
                                    } else if (data['message'] == 'folioreservado') {
                                        //folioReservado();
                                        resultado = true;
                                    } else if (data['message'] == 'alertaminimofolios') {
                                        alertaMinimoFolios(data['subempresa']);
                                        resultado = true;
                                    } else {
                                        resultado = true;
                                    }
                                }
                            });
                            return resultado;
                        }

                        function noTalonarioDisponible(subempresa) {

                            var error = "" +
                                "<div class='alert alert-block alert-danger'>" +
                                "    <p>" +
                                "    <strong>No hay Talonarios activos:</strong>" +
                                "    <br>" +
                                "    <br>Motivo: No hay talonarios activos para " + subempresa
                            "    <br>Por favor, agregue un talonario nuevo." +
                            "    </p>" +
                            "</div>";
                            bootbox.dialog(error, [{
                                "label": "Aceptar",
                                "class": "btn btn-mini",
                                "callback": function () {
                                }
                            }]);
                            return;
                        }

                        function noFolioDisponible(subempresa) {

                            var error = "" +
                                "<div class='alert alert-block alert-danger'>" +
                                "    <p>" +
                                "    <strong>No hay folios disponibles:</strong>" +
                                "    <br>" +
                                "    <br>Motivo: No hay talonarios con folios disponibles para " + subempresa
                            "    <br>Por favor, agregue un talonario nuevo." +
                            "    </p>" +
                            "</div>";
                            bootbox.dialog(error, [{
                                "label": "Aceptar",
                                "class": "btn btn-mini",
                                "callback": function () {
                                }
                            }]);
                            return;
                        }

                        function folioReservado() {
                            var ok = "" +
                                "<div class='alert alert-block alert-success'>" +
                                "    <p>" +
                                "    <strong>Se agregó correctamente el folio:</strong>" +
                                "    <br>" +
                                "    <br>Se agregó correctamente un nuevo folio a la prestación ingresada " +
                                "    </p>" +
                                "</div>";
                            bootbox.dialog(ok, [{
                                "label": "Aceptar",
                                "class": "btn btn-mini",
                                "callback": function () {
                                }
                            }]);
                            return;
                        }

                        function alertaMinimoFolios(subempresa) {
                            var ok = "" +
                                "<div class='alert alert-block alert-info'>" +
                                "    <p>" +
                                "    <strong>Alerta: Queda menos del mínimo de folios disponibles</strong>" +
                                "    <br>" +
                                "    <br>Por favor, agregar un nuevo talonario a " + subempresa
                            "    </p>" +
                            "</div>";
                            bootbox.dialog(ok, [{
                                "label": "Aceptar",
                                "class": "btn btn-mini",
                                "callback": function () {
                                }
                            }]);
                            return;
                        }

                        function enviarAImprimirBoleta(boletasDTE){

                            $.ajax({
                                type: 'get',
                                url: "{{ path('Caja_PostPago_Boleta_Dte') }}",
                                data: {
                                    boletasDTE: boletasDTE
                                },
                                success: function (respuesta) {
                                    $(".modalVerBoleta").html('');
                                    var vistaHtml = respuesta;
                                    $('.loading-temporal').css('display', 'none');
                                    bootbox.dialog(vistaHtml, [
                                        {
                                            "label": "<i class='icon-arrow-left'></i> Volver",
                                            "class": "btn btn-mini",
                                            "callback": function () {
                                                $(".modalVerBoleta").html('');
                                                bootbox.hideAll();
                                            }
                                        }
                                    ]);
                                }
                            });
                        }
                    </script>
                {% endmacro %}
