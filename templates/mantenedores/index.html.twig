{% extends 'base.html.twig' %}

{% block title %}Mantenedores - {{ tenant.name }}{% endblock %}

{% block dashboard_indicator %}
    üè• Mantenedores - {{ tenant.name }}
{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar igual al dashboard principal -->
        <nav class="col-md-3 col-lg-2 d-md-block bg-dark sidebar position-fixed">
            <div class="position-sticky pt-3">
                <div class="text-center mb-4">
                    <h5 class="text-white">üè• {{ tenant.name }}</h5>
                    <small class="text-muted">{{ tenant.subdomain }}.melisaupgrade.prod</small>
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link text-white" href="/dashboard">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="/pacientes">
                            <i class="fas fa-users"></i> Pacientes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="/emergencias">
                            <i class="fas fa-ambulance"></i> Emergencias
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="/quirofanos">
                            <i class="fas fa-procedures"></i> Quir√≥fanos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="/laboratorio">
                            <i class="fas fa-vial"></i> Laboratorio
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="/farmacia">
                            <i class="fas fa-pills"></i> Farmacia
                        </a>
                    </li>
                    
                    <!-- Separador -->
                    <li class="nav-item mt-3">
                        <hr class="sidebar-divider" style="border-color: #495057;">
                        <small class="text-muted px-3">ADMINISTRACI√ìN</small>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link active text-white" href="/mantenedores">
                            <i class="fas fa-cogs"></i> Mantenedores
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="/configuracion">
                            <i class="fas fa-wrench"></i> Configuraci√≥n
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- Main content con offset para sidebar -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">
                    <i class="fas fa-cogs me-2"></i>
                    Mantenedores
                </h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group me-2">
                        <button type="button" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-cog"></i> Configurar
                        </button>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Men√∫ lateral de mantenedores -->
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-list me-2"></i>
                                Categor√≠as
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush">
                                <!-- B√°sicos -->
                                <div class="list-group-item">
                                    <h6 class="mb-2 text-primary">
                                        <i class="fas fa-database me-2"></i>
                                        B√°sicos
                                    </h6>
                                    <div class="ms-3">
                                        <a href="#" 
                                           class="d-block py-1 text-decoration-none" 
                                           data-action="cargar-mantenedor"
                                           data-url="/mantenedores/basico/pais/content">
                                            <i class="fas fa-globe me-2"></i>Pa√≠ses
                                        </a>
                                        <a href="#" 
                                           class="d-block py-1 text-decoration-none" 
                                           data-action="cargar-mantenedor"
                                           data-url="/mantenedores/basico/regiones">
                                            <i class="fas fa-map me-2"></i>Regiones
                                        </a>
                                        <a href="#" 
                                           class="d-block py-1 text-decoration-none" 
                                           data-action="cargar-mantenedor"
                                           data-url="/mantenedores/basico/religiones">
                                            <i class="fas fa-pray me-2"></i>Religiones
                                        </a>
                                        <a href="#" 
                                           class="d-block py-1 text-decoration-none" 
                                           data-action="cargar-mantenedor"
                                           data-url="/mantenedores/basico/sexo">
                                            <i class="fas fa-venus-mars me-2"></i>Sexo
                                        </a>
                                    </div>
                                </div>
                                
                                <!-- Personas -->
                                <div class="list-group-item">
                                    <h6 class="mb-2 text-success">
                                        <i class="fas fa-users me-2"></i>
                                        Personas
                                    </h6>
                                    <div class="ms-3">
                                        <a href="#" class="d-block py-1 text-decoration-none">
                                            <i class="fas fa-user-md me-2"></i>M√©dicos
                                        </a>
                                        <a href="#" class="d-block py-1 text-decoration-none">
                                            <i class="fas fa-user-nurse me-2"></i>Enfermeros
                                        </a>
                                        <a href="#" class="d-block py-1 text-decoration-none">
                                            <i class="fas fa-user-tie me-2"></i>Administrativos
                                        </a>
                                    </div>
                                </div>
                                
                                <!-- M√©dicos -->
                                <div class="list-group-item">
                                    <h6 class="mb-2 text-info">
                                        <i class="fas fa-stethoscope me-2"></i>
                                        M√©dicos
                                    </h6>
                                    <div class="ms-3">
                                        <a href="#" class="d-block py-1 text-decoration-none">
                                            <i class="fas fa-hospital me-2"></i>Especialidades
                                        </a>
                                        <a href="#" class="d-block py-1 text-decoration-none">
                                            <i class="fas fa-pills me-2"></i>Medicamentos
                                        </a>
                                        <a href="#" class="d-block py-1 text-decoration-none">
                                            <i class="fas fa-file-medical me-2"></i>Diagn√≥sticos
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Columna de contenido -->
                <div class="col-md-9">
                    <div id="content-column" class="card">
                        <div class="card-header bg-light">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Selecciona un mantenedor
                            </h5>
                        </div>
                        <div class="card-body text-center text-muted">
                            <i class="fas fa-arrow-left fa-3x mb-3 opacity-50"></i>
                            <p>Selecciona un elemento del men√∫ lateral para comenzar</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
    console.log('=== MANTENEDORES CARGADO ===');
    
    // Configurar event delegation cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM listo, configurando eventos...');
        setupEventDelegation();
        
        // Test manual - verificar que los elementos existan
        const contentColumn = document.getElementById('content-column');
        const paisesLink = document.querySelector('[data-action="cargar-mantenedor"]');
        
        console.log('Elementos encontrados:', {
            contentColumn: !!contentColumn,
            paisesLink: !!paisesLink
        });
        
        if (paisesLink) {
            console.log('URL del enlace pa√≠ses:', paisesLink.getAttribute('data-url'));
        }
    });
    
    // Event delegation para manejar clicks en contenido cargado din√°micamente
    function setupEventDelegation() {
        console.log('Configurando event delegation...');
        
        // Remover listeners anteriores si existen
        document.removeEventListener('click', handleDocumentClick);
        
        // Agregar listener principal
        document.addEventListener('click', handleDocumentClick);
        
        console.log('Event delegation configurado');
    }
    
    // Handler principal para todos los clicks
    function handleDocumentClick(e) {
        console.log('Click detectado en documento, elemento:', e.target);
        
        const target = e.target.closest('[data-action]');
        
        if (!target) {
            console.log('No se encontr√≥ elemento con data-action');
            return;
        }
        
        const action = target.getAttribute('data-action');
        const url = target.getAttribute('data-url');
        const id = target.getAttribute('data-id');
        
        console.log('Click detectado en elemento con data-action:', { action, url, id, target });
        
        e.preventDefault();
        e.stopPropagation();
        
        // Ejecutar acciones
        switch(action) {
            case 'cargar-mantenedor':
                console.log('Cargando mantenedor:', url);
                cargarMantenedor(url);
                break;
            case 'crear-pais':
                console.log('Creando pa√≠s...');
                ejecutarCrearPais();
                break;
            case 'editar-pais':
                console.log('Editando pa√≠s:', id);
                ejecutarEditarPais(id);
                break;
            case 'eliminar-pais':
                console.log('Eliminando pa√≠s:', id);
                ejecutarEliminarPais(id);
                break;
            default:
                console.log('Acci√≥n no reconocida:', action);
        }
    }
    
    // Funci√≥n para cargar mantenedor din√°micamente
    function cargarMantenedor(url) {
        console.log('=== CARGAR MANTENEDOR ===', url);
        
        const contentDiv = document.getElementById('content-column');
        
        if (!contentDiv) {
            console.error('Contenedor de contenido no encontrado');
            return;
        }
        
        // Mostrar loading
        contentDiv.innerHTML = `
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    Cargando...
                </h5>
            </div>
            <div class="card-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="text-muted">Cargando contenido del mantenedor...</p>
            </div>
        `;
        
        // Hacer petici√≥n AJAX
        fetch(url)
            .then(response => {
                console.log('Respuesta recibida:', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                return response.text();
            })
            .then(html => {
                console.log('HTML recibido, longitud:', html.length);
                
                // Reemplazar el contenido completo
                contentDiv.innerHTML = html;
                
                console.log('Contenido actualizado');
                
                // Verificar que los elementos se cargaron
                setTimeout(() => {
                    const botonCrear = document.querySelector('[data-action="crear-pais"]');
                    console.log('Bot√≥n crear encontrado despu√©s de cargar:', !!botonCrear);
                    
                    if (botonCrear) {
                        console.log('Bot√≥n crear configurado correctamente');
                    } else {
                        console.warn('Bot√≥n crear no encontrado en el contenido cargado');
                    }
                }, 100);
            })
            .catch(error => {
                console.error('Error al cargar mantenedor:', error);
                contentDiv.innerHTML = `
                    <div class="card-header bg-danger text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error al cargar
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-danger">
                            <strong>Error:</strong> ${error.message}
                            <br><br>
                            <button class="btn btn-secondary btn-sm" onclick="location.reload()">
                                <i class="fas fa-refresh me-1"></i>
                                Recargar p√°gina
                            </button>
                        </div>
                    </div>
                `;
            });
    }
    
    // =================== FUNCIONES PARA PA√çSES ===================
    
    function ejecutarCrearPais() {
        console.log('=== CREAR PA√çS ===');
        
        const modal = document.getElementById('paisModal');
        const modalTitle = document.getElementById('modalTitle');
        const form = document.getElementById('paisForm');
        const paisId = document.getElementById('paisId');
        const activo = document.getElementById('activo');
        
        console.log('Elementos encontrados:', {
            modal: !!modal,
            modalTitle: !!modalTitle,
            form: !!form,
            paisId: !!paisId,
            activo: !!activo
        });
        
        if (!modal) {
            console.error('Modal paisModal no encontrado');
            alert('Error: Modal no encontrado. Aseg√∫rate de que el contenido est√© cargado.');
            return;
        }
        
        // Configurar modal para crear
        if (modalTitle) modalTitle.textContent = 'Crear Pa√≠s';
        if (form) form.reset();
        if (paisId) paisId.value = '';
        if (activo) activo.checked = true;
        
        // Limpiar errores previos
        limpiarErroresFormulario();
        
        // Mostrar modal
        try {
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            console.log('Modal mostrado exitosamente');
        } catch (error) {
            console.error('Error al mostrar modal:', error);
            alert('Error al abrir el modal: ' + error.message);
        }
    }
    
    function ejecutarEditarPais(id) {
        console.log('=== EDITAR PA√çS ===', id);
        
        if (!id) {
            console.error('ID de pa√≠s no proporcionado');
            alert('Error: ID de pa√≠s no v√°lido');
            return;
        }
        
        // Obtener datos del pa√≠s desde la API
        fetch(`/mantenedores/basico/pais/${id}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (!data.success) {
                    throw new Error(data.error || 'Error desconocido');
                }
                
                const pais = data.data;
                
                const modal = document.getElementById('paisModal');
                const modalTitle = document.getElementById('modalTitle');
                const paisId = document.getElementById('paisId');
                const nombrePais = document.getElementById('nombrePais');
                const nombreGentilicio = document.getElementById('nombreGentilicio');
                const activo = document.getElementById('activo');
                
                if (!modal) {
                    console.error('Modal no encontrado');
                    alert('Error: Modal no encontrado');
                    return;
                }
                
                // Configurar modal para editar
                if (modalTitle) modalTitle.textContent = 'Editar Pa√≠s';
                if (paisId) paisId.value = pais.id;
                if (nombrePais) nombrePais.value = pais.nombrePais;
                if (nombreGentilicio) nombreGentilicio.value = pais.nombreGentilicio;
                if (activo) activo.checked = pais.activo;
                
                limpiarErroresFormulario();
                
                const bsModal = new bootstrap.Modal(modal);
                bsModal.show();
                console.log('Modal de edici√≥n mostrado con datos:', pais);
            })
            .catch(error => {
                console.error('Error al obtener datos del pa√≠s:', error);
                alert('Error al cargar los datos del pa√≠s: ' + error.message);
            });
    }
    
    function ejecutarEliminarPais(id) {
        console.log('=== ELIMINAR PA√çS ===', id);
        
        if (!id) {
            alert('Error: ID de pa√≠s no v√°lido');
            return;
        }
        
        // Obtener datos del pa√≠s primero para mostrar confirmaci√≥n
        fetch(`/mantenedores/basico/pais/${id}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (!data.success) {
                    throw new Error(data.error || 'Error desconocido');
                }
                
                const pais = data.data;
                const confirmacion = confirm(`¬øEst√°s seguro de que deseas eliminar el pa√≠s "${pais.nombrePais}"?\n\nEsta acci√≥n no se puede deshacer.`);
                
                if (confirmacion) {
                    console.log('Eliminando pa√≠s:', id);
                    
                    // Llamada AJAX para eliminar
                    fetch(`/mantenedores/basico/pais/${id}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Error ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(result => {
                        if (result.success) {
                            alert('Pa√≠s eliminado exitosamente!');
                            cargarMantenedor('pais'); // Recargar la lista
                        } else {
                            throw new Error(result.error || 'Error al eliminar pa√≠s');
                        }
                    })
                    .catch(error => {
                        console.error('Error al eliminar pa√≠s:', error);
                        alert('Error al eliminar pa√≠s: ' + error.message);
                    });
                }
            })
            .catch(error => {
                console.error('Error al obtener datos del pa√≠s:', error);
                alert('Error al cargar los datos del pa√≠s: ' + error.message);
            });
    }
    
    // Funci√≥n para limpiar errores de formulario
    function limpiarErroresFormulario() {
        document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
        document.querySelectorAll('.invalid-feedback').forEach(el => el.style.display = 'none');
    }
    
    // Funci√≥n para manejar el submit del formulario de pa√≠s
    function handlePaisFormSubmit(event) {
        event.preventDefault();
        
        const form = event.target;
        const formData = new FormData(form);
        const paisId = formData.get('id');
        
        // Determinar si es crear o editar
        const isEdit = paisId && paisId.trim() !== '';
        const url = isEdit ? `/mantenedores/basico/pais/${paisId}` : '/mantenedores/basico/pais';
        const method = isEdit ? 'PUT' : 'POST';
        
        console.log(`${isEdit ? 'Editando' : 'Creando'} pa√≠s:`, {
            url,
            method,
            data: Object.fromEntries(formData)
        });
        
        // Limpiar errores previos
        limpiarErroresFormulario();
        
        // Preparar datos para env√≠o
        const requestData = {
            nombrePais: formData.get('nombrePais'),
            nombreGentilicio: formData.get('nombreGentilicio'),
            activo: formData.has('activo')
        };
        
        // Realizar petici√≥n
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(requestData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('paisModal'));
                if (modal) {
                    modal.hide();
                }
                
                // Mostrar mensaje de √©xito
                alert(`Pa√≠s ${isEdit ? 'actualizado' : 'creado'} exitosamente!`);
                
                // Recargar la lista
                cargarMantenedor('pais');
            } else {
                throw new Error(result.error || `Error al ${isEdit ? 'actualizar' : 'crear'} pa√≠s`);
            }
        })
        .catch(error => {
            console.error(`Error al ${isEdit ? 'actualizar' : 'crear'} pa√≠s:`, error);
            alert(`Error al ${isEdit ? 'actualizar' : 'crear'} pa√≠s: ` + error.message);
        });
    }
    
    // Configurar event listener para el formulario
    function setupFormHandlers() {
        // Usar delegaci√≥n de eventos para el formulario
        document.addEventListener('submit', function(event) {
            const form = event.target;
            
            // Verificar si es el formulario de pa√≠s
            if (form.id === 'paisForm' || form.getAttribute('data-action') === 'guardar-pais') {
                console.log('Submit del formulario de pa√≠s detectado');
                handlePaisFormSubmit(event);
            }
        });
    }
    
    // Tambi√©n configurar cuando la p√°gina est√© completamente cargada
    window.addEventListener('load', function() {
        console.log('P√°gina completamente cargada');
        setupEventDelegation();
        setupFormHandlers();
    });
    
    console.log('=== SCRIPT MANTENEDORES TERMINADO ===');
</script>
{% endblock %}