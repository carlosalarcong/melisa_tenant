{% extends 'base.html.twig' %}

{% block title %}Mantenedores - {{ tenant.name }}{% endblock %}

{% block dashboard_indicator %}
    üè• Mantenedores - {{ tenant.name }}
{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar igual al dashboard principal -->
        <nav class="col-md-3 col-lg-2 d-md-block bg-dark sidebar position-fixed">
            <div class="position-sticky pt-3">
                <div class="text-center mb-4">
                    <h5 class="text-white">üè• {{ tenant.name }}</h5>
                    <small class="text-muted">{{ tenant.subdomain }}.melisaupgrade.prod</small>
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link text-white" href="/dashboard">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="/pacientes">
                            <i class="fas fa-users"></i> Pacientes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="/emergencias">
                            <i class="fas fa-ambulance"></i> Emergencias
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="/quirofanos">
                            <i class="fas fa-procedures"></i> Quir√≥fanos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="/laboratorio">
                            <i class="fas fa-vial"></i> Laboratorio
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="/farmacia">
                            <i class="fas fa-pills"></i> Farmacia
                        </a>
                    </li>
                    
                    <!-- Separador -->
                    <li class="nav-item mt-3">
                        <hr class="sidebar-divider" style="border-color: #495057;">
                        <small class="text-muted px-3">ADMINISTRACI√ìN</small>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link active text-white" href="/mantenedores">
                            <i class="fas fa-cogs"></i> Mantenedores
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="/configuracion">
                            <i class="fas fa-wrench"></i> Configuraci√≥n
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- Main content con offset para sidebar -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">
                    <i class="fas fa-cogs me-2"></i>
                    Mantenedores
                </h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group me-2">
                        <button type="button" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-cog"></i> Configurar
                        </button>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Men√∫ lateral de mantenedores -->
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-list me-2"></i>
                                Categor√≠as
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush">
                                <!-- B√°sicos -->
                                <div class="list-group-item">
                                    <h6 class="mb-2 text-primary">
                                        <i class="fas fa-database me-2"></i>
                                        B√°sicos
                                    </h6>
                                    <div class="ms-3">
                                        <a href="#" 
                                           class="d-block py-1 text-decoration-none mantenedor-link" 
                                           data-action="cargar-mantenedor"
                                           data-url="/mantenedores/basico/pais/content"
                                           style="cursor: pointer;">
                                            <i class="fas fa-globe me-2"></i>Pa√≠ses
                                        </a>
                                        <a href="#" 
                                           class="d-block py-1 text-decoration-none" 
                                           data-action="cargar-mantenedor"
                                           data-url="/mantenedores/basico/regiones">
                                            <i class="fas fa-map me-2"></i>Regiones
                                        </a>
                                        <a href="#" 
                                           class="d-block py-1 text-decoration-none" 
                                           data-action="cargar-mantenedor"
                                           data-url="/mantenedores/basico/religiones">
                                            <i class="fas fa-pray me-2"></i>Religiones
                                        </a>
                                        <a href="#" 
                                           class="d-block py-1 text-decoration-none" 
                                           data-action="cargar-mantenedor"
                                           data-url="/mantenedores/basico/sexo">
                                            <i class="fas fa-venus-mars me-2"></i>Sexo
                                        </a>
                                    </div>
                                </div>
                                
                                <!-- Personas -->
                                <div class="list-group-item">
                                    <h6 class="mb-2 text-success">
                                        <i class="fas fa-users me-2"></i>
                                        Personas
                                    </h6>
                                    <div class="ms-3">
                                        <a href="#" class="d-block py-1 text-decoration-none">
                                            <i class="fas fa-user-md me-2"></i>M√©dicos
                                        </a>
                                        <a href="#" class="d-block py-1 text-decoration-none">
                                            <i class="fas fa-user-nurse me-2"></i>Enfermeros
                                        </a>
                                        <a href="#" class="d-block py-1 text-decoration-none">
                                            <i class="fas fa-user-tie me-2"></i>Administrativos
                                        </a>
                                    </div>
                                </div>
                                
                                <!-- M√©dicos -->
                                <div class="list-group-item">
                                    <h6 class="mb-2 text-info">
                                        <i class="fas fa-stethoscope me-2"></i>
                                        M√©dicos
                                    </h6>
                                    <div class="ms-3">
                                        <a href="#" class="d-block py-1 text-decoration-none">
                                            <i class="fas fa-hospital me-2"></i>Especialidades
                                        </a>
                                        <a href="#" class="d-block py-1 text-decoration-none">
                                            <i class="fas fa-pills me-2"></i>Medicamentos
                                        </a>
                                        <a href="#" class="d-block py-1 text-decoration-none">
                                            <i class="fas fa-file-medical me-2"></i>Diagn√≥sticos
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Columna de contenido -->
                <div class="col-md-9">
                    <div id="content-column" class="card">
                        <div class="card-header bg-light">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Selecciona un mantenedor
                            </h5>
                        </div>
                        <div class="card-body text-center text-muted">
                            <i class="fas fa-arrow-left fa-3x mb-3 opacity-50"></i>
                            <p>Selecciona un elemento del men√∫ lateral para comenzar</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
    console.log('=== MANTENEDORES CARGADO ===');
    
    // Configurar event delegation cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM listo, configurando eventos...');
        setupEventDelegation();
        
        // Test manual - verificar que los elementos existan
        const contentColumn = document.getElementById('content-column');
        const paisesLink = document.querySelector('[data-action="cargar-mantenedor"]');
        
        console.log('Elementos encontrados:', {
            contentColumn: !!contentColumn,
            paisesLink: !!paisesLink
        });
        
        if (paisesLink) {
            console.log('URL del enlace pa√≠ses:', paisesLink.getAttribute('data-url'));
        }
    });
    
    // Event delegation para manejar clicks en contenido cargado din√°micamente
    function setupEventDelegation() {
        console.log('Configurando event delegation...');
        
        // Remover listeners anteriores si existen
        document.removeEventListener('click', handleDocumentClick);
        
        // Agregar listener principal
        document.addEventListener('click', handleDocumentClick);
        
        // Listener espec√≠fico para enlaces de mantenedores
        document.addEventListener('click', function(e) {
            // Verificar si se hizo clic en un enlace de mantenedor
            const mantenedorLink = e.target.closest('.mantenedor-link');
            if (mantenedorLink) {
                console.log('=== CLICK EN ENLACE MANTENEDOR ===');
                e.preventDefault();
                e.stopPropagation();
                
                const url = mantenedorLink.getAttribute('data-url');
                console.log('URL del mantenedor:', url);
                
                if (url) {
                    cargarMantenedor(url);
                } else {
                    console.error('URL no encontrada en el enlace');
                }
            }
        });
        
        console.log('Event delegation configurado');
    }
    
    // Handler principal para todos los clicks
    function handleDocumentClick(e) {
        console.log('=== CLICK DETECTADO ===');
        console.log('Elemento clickeado:', e.target);
        console.log('Texto del elemento:', e.target.textContent);
        console.log('Clase del elemento:', e.target.className);
        
        // Buscar el elemento con data-action subiendo en el DOM
        let target = e.target;
        let attempts = 0;
        const maxAttempts = 5;
        
        while (target && attempts < maxAttempts) {
            console.log(`Intento ${attempts + 1}: Revisando elemento`, target.tagName, target.className);
            
            if (target.hasAttribute && target.hasAttribute('data-action')) {
                console.log('¬°Elemento con data-action encontrado!');
                break;
            }
            
            target = target.parentElement;
            attempts++;
        }
        
        if (!target || !target.hasAttribute('data-action')) {
            console.log('No se encontr√≥ elemento con data-action despu√©s de', attempts, 'intentos');
            return;
        }
        
        const action = target.getAttribute('data-action');
        const url = target.getAttribute('data-url');
        const id = target.getAttribute('data-id');
        
        console.log('=== ACCI√ìN DETECTADA ===');
        console.log('Action:', action);
        console.log('URL:', url);
        console.log('ID:', id);
        
        // NO prevenir default para botones de submit
        if (action === 'guardar-pais') {
            return; // Permitir que el evento submit se dispare normalmente
        }
        
        e.preventDefault();
        e.stopPropagation();
        
        // Ejecutar acciones
        switch(action) {
            case 'cargar-mantenedor':
                cargarMantenedor(url);
                break;
            case 'crear-pais':
                ejecutarCrearPais();
                break;
            case 'editar-pais':
            case 'edit':
                ejecutarEditarPais(id);
                break;
            case 'eliminar-pais':
            case 'delete':
                const paisNombre = target.getAttribute('data-name');
                ejecutarEliminarPais(id, paisNombre);
                break;
            default:
                console.log('Acci√≥n no reconocida:', action);
        }
    }
    
    // Funci√≥n para cargar mantenedor din√°micamente
    function cargarMantenedor(url) {
        console.log('=== CARGAR MANTENEDOR ===');
        console.log('URL recibida:', url);
        
        const contentDiv = document.getElementById('content-column');
        
        if (!contentDiv) {
            console.error('Contenedor de contenido no encontrado');
            return;
        }
        
        // Construir URL completa
        const baseUrl = window.location.origin;
        const fullUrl = url.startsWith('http') ? url : baseUrl + url;
        
        console.log('URL completa:', fullUrl);
        console.log('Base URL:', baseUrl);
        
        // Mostrar loading
        contentDiv.innerHTML = `
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    Cargando...
                </h5>
            </div>
            <div class="card-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="text-muted">Cargando contenido del mantenedor...</p>
                <small class="text-muted">URL: ${fullUrl}</small>
            </div>
        `;
        
        // Hacer petici√≥n AJAX
        console.log('Iniciando fetch a:', fullUrl);
        fetch(fullUrl)
            .then(response => {
                console.log('Respuesta recibida:', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                return response.text();
            })
            .then(html => {
                console.log('HTML recibido, longitud:', html.length);
                // Reemplazar el contenido completo
                contentDiv.innerHTML = html;
                
                // Actualizar la URL del navegador sin recargar la p√°gina
                const newUrl = determinarNuevaUrl(url);
                if (newUrl && newUrl !== window.location.pathname) {
                    console.log('Actualizando URL del navegador a:', newUrl);
                    window.history.pushState({mantenedor: url}, '', newUrl);
                }
                
                // Ejecutar scripts del contenido cargado
                executeScriptsInContainer(contentDiv);
                
                // Configurar form handlers para el nuevo contenido
                if (!formHandlersSetup) {
                    setupFormHandlers();
                }
                
                console.log('Contenido cargado exitosamente');
            })
            .catch(error => {
                console.error('Error al cargar mantenedor:', error);
                contentDiv.innerHTML = `
                    <div class="card-header bg-danger text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error al cargar
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-danger">
                            <strong>Error:</strong> ${error.message}
                            <br><strong>URL:</strong> ${fullUrl}
                            <br><br>
                            <button class="btn btn-secondary btn-sm" onclick="location.reload()">
                                <i class="fas fa-refresh me-1"></i>
                                Recargar p√°gina
                            </button>
                        </div>
                    </div>
                `;
            });
    }
    
    // =================== FUNCIONES PARA PA√çSES ===================
    
    function ejecutarCrearPais() {
        console.log('=== CREAR PA√çS ===');
        
        const modal = document.getElementById('paisModal');
        const modalTitle = document.getElementById('modalTitle');
        const form = document.getElementById('paisForm');
        const paisId = document.getElementById('paisId');
        const activo = document.getElementById('activo');
        
        console.log('Elementos encontrados:', {
            modal: !!modal,
            modalTitle: !!modalTitle,
            form: !!form,
            paisId: !!paisId,
            activo: !!activo
        });
        
        if (!modal) {
            console.error('Modal paisModal no encontrado');
            alert('Error: Modal no encontrado. Aseg√∫rate de que el contenido est√© cargado.');
            return;
        }
        
        // Configurar modal para crear
        if (modalTitle) modalTitle.textContent = 'Crear Pa√≠s';
        if (form) form.reset();
        if (paisId) paisId.value = '';
        if (activo) activo.checked = true;
        
        // Limpiar errores previos
        limpiarErroresFormulario();
        
        // Mostrar modal
        try {
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            console.log('Modal mostrado exitosamente');
        } catch (error) {
            console.error('Error al mostrar modal:', error);
            alert('Error al abrir el modal: ' + error.message);
        }
    }
    
    function ejecutarEditarPais(id) {
        if (!id) {
            mostrarMensajeError('Error', 'ID de pa√≠s no v√°lido');
            return;
        }
        
        // Obtener datos del pa√≠s desde la API
        const BASE_URL = window.location.origin;
        const url = `${BASE_URL}/mantenedores/basico/pais/${id}`;
        
        fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (!data.success) {
                throw new Error(data.error || 'Error desconocido');
            }
            
            const pais = data.data;
            
            // Buscar elementos del modal
            const modal = document.getElementById('paisModal');
            const modalTitle = document.getElementById('paisModalLabel');
            const paisId = document.getElementById('paisId');
            const nombrePais = document.getElementById('nombrePais');
            const nombreGentilicio = document.getElementById('nombreGentilicio');
            const activo = document.getElementById('activo');
            
            if (!modal) {
                mostrarMensajeError('Error', 'Modal no encontrado');
                return;
            }
            
            // Configurar modal para editar
            if (modalTitle) {
                modalTitle.innerHTML = '<i class="fas fa-edit me-2"></i>Editar Pa√≠s';
            }
            if (paisId) paisId.value = pais.idPais;
            if (nombrePais) nombrePais.value = pais.nombrePais || '';
            if (nombreGentilicio) nombreGentilicio.value = pais.nombreGentilicio || '';
            if (activo) activo.checked = pais.activo || false;
            
            limpiarErroresFormulario();
            
            // Mostrar modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        })
        .catch(error => {
            console.error('Error al obtener datos del pa√≠s:', error);
            mostrarMensajeError('Error', 'Error al cargar los datos del pa√≠s: ' + error.message);
        });
    }
    
    function ejecutarEliminarPais(id, paisNombre = null) {
        console.log('=== ELIMINAR PA√çS ===', { id, paisNombre });
        
        if (!id) {
            mostrarMensajeError('Error', 'ID de pa√≠s no v√°lido');
            return;
        }
        
        // Si ya tenemos el nombre, usarlo directamente
        if (paisNombre) {
            confirmarYEliminarPais(id, paisNombre);
            return;
        }
        
        // Si no tenemos el nombre, obtener datos del pa√≠s primero
        fetch(`/mantenedores/basico/pais/${id}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (!data.success) {
                    throw new Error(data.error || 'Error desconocido');
                }
                
                const pais = data.data;
                confirmarYEliminarPais(id, pais.nombrePais);
            })
            .catch(error => {
                console.error('Error al obtener datos del pa√≠s:', error);
                mostrarMensajeError('Error', 'Error al obtener datos del pa√≠s: ' + error.message);
            });
    }
    
    function confirmarYEliminarPais(id, paisNombre) {
        // Mostrar confirmaci√≥n con SweetAlert2
        mostrarConfirmacion(
            '¬øEliminar pa√≠s?',
            `¬øEst√°s seguro de que deseas eliminar el pa√≠s "${paisNombre}"? Esta acci√≥n no se puede deshacer.`
        ).then((result) => {
            if (result.isConfirmed) {
                console.log('Eliminando pa√≠s:', id);
                
                // Llamada AJAX para eliminar
                fetch(`/mantenedores/basico/pais/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(result => {
                    if (result.success) {
                        mostrarMensajeExito('¬°Eliminado!', 'Pa√≠s eliminado exitosamente');
                        cargarMantenedor('/mantenedores/basico/pais/content'); // Recargar la lista
                    } else {
                        throw new Error(result.error || 'Error al eliminar pa√≠s');
                    }
                })
                .catch(error => {
                    console.error('Error al eliminar pa√≠s:', error);
                    mostrarMensajeError('Error', 'Error al eliminar pa√≠s: ' + error.message);
                });
            }
        });
    }
    
    // Funci√≥n para limpiar errores de formulario
    function limpiarErroresFormulario() {
        document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
        document.querySelectorAll('.invalid-feedback').forEach(el => el.style.display = 'none');
    }
    
    // Funciones para mostrar mensajes con SweetAlert2
    function mostrarMensajeExito(titulo, mensaje) {
        Swal.fire({
            icon: 'success',
            title: titulo,
            text: mensaje,
            confirmButtonText: 'Aceptar',
            confirmButtonColor: '#28a745',
            timer: 3000,
            timerProgressBar: true
        });
    }
    
    function mostrarMensajeError(titulo, mensaje) {
        Swal.fire({
            icon: 'error',
            title: titulo,
            text: mensaje,
            confirmButtonText: 'Aceptar',
            confirmButtonColor: '#dc3545'
        });
    }
    
    function mostrarConfirmacion(titulo, mensaje) {
        return Swal.fire({
            icon: 'question',
            title: titulo,
            text: mensaje,
            showCancelButton: true,
            confirmButtonText: 'S√≠, eliminar',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            reverseButtons: true
        });
    }
    
    // Funci√≥n para manejar el submit del formulario de pa√≠s
    function handlePaisFormSubmit(event) {
        event.preventDefault();
        
        const form = event.target;
        const formData = new FormData(form);
        const paisId = formData.get('paisId');
        
        // Determinar si es crear o editar
        const isEdit = paisId && paisId.trim() !== '';
        
        // Usar URL base correcta
        const BASE_URL = window.location.origin;
        const url = isEdit ? `${BASE_URL}/mantenedores/basico/pais/${paisId}` : `${BASE_URL}/mantenedores/basico/pais`;
        const method = isEdit ? 'PUT' : 'POST';
        
        // Limpiar errores previos
        limpiarErroresFormulario();
        
        // Preparar datos para env√≠o
        const requestData = {
            nombrePais: formData.get('nombrePais'),
            nombreGentilicio: formData.get('nombreGentilicio'),
            activo: formData.has('activo')
        };
        
        // Realizar petici√≥n
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(requestData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                // Cerrar modal correctamente
                limpiarModal('paisModal');
                
                // Mostrar mensaje de √©xito
                mostrarMensajeExito(
                    '¬°√âxito!', 
                    `Pa√≠s ${isEdit ? 'actualizado' : 'creado'} exitosamente`
                );
                
                // Recargar la lista de pa√≠ses
                cargarMantenedor('/mantenedores/basico/pais/content');
            } else {
                throw new Error(result.error || `Error al ${isEdit ? 'actualizar' : 'crear'} pa√≠s`);
            }
        })
        .catch(error => {
            console.error(`Error al ${isEdit ? 'actualizar' : 'crear'} pa√≠s:`, error);
            mostrarMensajeError(
                'Error',
                `Error al ${isEdit ? 'actualizar' : 'crear'} pa√≠s: ${error.message}`
            );
        });
    }    // Variable para evitar m√∫ltiples event listeners
    let formHandlersSetup = false;
    
    // Configurar event listener para el formulario
    function setupFormHandlers() {
        console.log('=== CONFIGURANDO FORM HANDLERS ===');
        
        // Solo configurar una vez para evitar duplicados
        if (formHandlersSetup) {
            console.log('Form handlers ya configurados, saltando...');
            return;
        }
        
        // Usar delegaci√≥n de eventos para el formulario
        document.addEventListener('submit', function(event) {
            console.log('=== SUBMIT EVENT DETECTADO ===', event.target);
            const form = event.target;
            
            console.log('Form ID:', form.id);
            console.log('Form data-action:', form.getAttribute('data-action'));
            
            // Verificar si es el formulario de pa√≠s
            if (form.id === 'paisForm' || form.getAttribute('data-action') === 'guardar-pais') {
                console.log('Submit del formulario de pa√≠s detectado');
                handlePaisFormSubmit(event);
            } else {
                console.log('Form no reconocido, no se maneja');
            }
        });
        
        formHandlersSetup = true;
        console.log('Form handlers configurados');
    }
    
    // Tambi√©n configurar cuando la p√°gina est√© completamente cargada
    window.addEventListener('load', function() {
        setupEventDelegation();
        setupFormHandlers();
        setupHistoryHandling();
        
        // Agregar listener global para limpiar modales
        document.addEventListener('hidden.bs.modal', function() {
            setTimeout(() => {
                const backdrops = document.querySelectorAll('.modal-backdrop');
                if (backdrops.length > 0) {
                    backdrops.forEach(backdrop => backdrop.remove());
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }
            }, 100);
        });
    });
    
    // Configurar manejo del historial del navegador
    function setupHistoryHandling() {
        console.log('Configurando manejo de historial...');
        
        // Manejar botones atr√°s/adelante del navegador
        window.addEventListener('popstate', function(event) {
            console.log('=== POPSTATE EVENT ===');
            console.log('Estado:', event.state);
            console.log('URL actual:', window.location.pathname);
            
            if (event.state && event.state.mantenedor) {
                // El usuario naveg√≥ a una p√°gina con mantenedor
                console.log('Cargando mantenedor desde historial:', event.state.mantenedor);
                cargarMantenedorSinHistory(event.state.mantenedor);
            } else {
                // El usuario naveg√≥ de vuelta a la p√°gina principal de mantenedores
                console.log('Volviendo a p√°gina principal de mantenedores');
                mostrarPaginaPrincipalMantenedores();
            }
        });
        
        // Verificar si hay contenido precargado desde el servidor
        {% if preload_data is defined and preload_data.content_html is defined %}
        console.log('Contenido precargado disponible para: {{ preload_content|default("desconocido") }}');
        const contentDiv = document.getElementById('content-column');
        if (contentDiv) {
            contentDiv.innerHTML = `{{ preload_data.content_html|e('js') }}`;
            
            // Ejecutar scripts del contenido precargado
            executeScriptsInContainer(contentDiv);
            
            // Configurar form handlers
            if (!formHandlersSetup) {
                setupFormHandlers();
            }
            
            console.log('Contenido precargado inyectado exitosamente');
        }
        {% else %}
        // Verificar si necesitamos cargar un mantenedor basado en la URL actual
        const currentPath = window.location.pathname;
        const mantenedorUrl = obtenerUrlMantenedorDesdePath(currentPath);
        
        if (mantenedorUrl) {
            console.log('Cargando mantenedor basado en URL actual:', mantenedorUrl);
            cargarMantenedorSinHistory(mantenedorUrl);
        }
        {% endif %}
        
        console.log('Manejo de historial configurado');
    }
    
    // Funci√≥n para cargar mantenedor sin agregar entrada al historial
    function cargarMantenedorSinHistory(url) {
        const contentDiv = document.getElementById('content-column');
        if (!contentDiv) return;
        
        const baseUrl = window.location.origin;
        const fullUrl = url.startsWith('http') ? url : baseUrl + url;
        
        contentDiv.innerHTML = `
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    Cargando...
                </h5>
            </div>
            <div class="card-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="text-muted">Cargando contenido del mantenedor...</p>
            </div>
        `;
        
        fetch(fullUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                return response.text();
            })
            .then(html => {
                contentDiv.innerHTML = html;
                executeScriptsInContainer(contentDiv);
                if (!formHandlersSetup) {
                    setupFormHandlers();
                }
            })
            .catch(error => {
                console.error('Error al cargar mantenedor:', error);
                contentDiv.innerHTML = `
                    <div class="card-header bg-danger text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error al cargar
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-danger">
                            <strong>Error:</strong> ${error.message}
                        </div>
                    </div>
                `;
            });
    }
    
    // Funci√≥n para obtener URL de mantenedor desde el path del navegador
    function obtenerUrlMantenedorDesdePath(path) {
        const pathMapping = {
            '/mantenedores/basico/pais': '/mantenedores/basico/pais/content',
            '/mantenedores/pais': '/mantenedores/basico/pais/content',
            '/mantenedores/regiones': '/mantenedores/basico/regiones',
            '/mantenedores/religiones': '/mantenedores/basico/religiones',
            '/mantenedores/sexo': '/mantenedores/basico/sexo'
        };
        
        return pathMapping[path];
    }
    
    // Funci√≥n para mostrar la p√°gina principal de mantenedores
    function mostrarPaginaPrincipalMantenedores() {
        const contentDiv = document.getElementById('content-column');
        if (!contentDiv) return;
        
        contentDiv.innerHTML = `
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Selecciona un mantenedor
                </h5>
            </div>
            <div class="card-body text-center text-muted">
                <i class="fas fa-arrow-left fa-3x mb-3 opacity-50"></i>
                <p>Selecciona un elemento del men√∫ lateral para comenzar</p>
            </div>
        `;
    }
    
    // Funci√≥n para ejecutar scripts en contenido cargado din√°micamente
    function executeScriptsInContainer(container) {
        console.log('üîß Ejecutando scripts en contenedor...');
        
        const scripts = container.querySelectorAll('script');
        console.log(`üìú Scripts encontrados: ${scripts.length}`);
        
        scripts.forEach((script, index) => {
            console.log(`üìú Ejecutando script ${index + 1}/${scripts.length}`);
            
            try {
                if (script.src) {
                    // Script externo - crear nuevo elemento script
                    const newScript = document.createElement('script');
                    newScript.src = script.src;
                    document.head.appendChild(newScript);
                    console.log(`‚úÖ Script externo cargado: ${script.src}`);
                } else {
                    // Script inline - ejecutar directamente
                    const scriptFunction = new Function(script.innerHTML);
                    scriptFunction();
                    console.log(`‚úÖ Script inline ejecutado`);
                }
            } catch (error) {
                console.error(`‚ùå Error ejecutando script ${index + 1}:`, error);
            }
        });
        
        console.log('üéØ Ejecuci√≥n de scripts completada');
    }
    
    // Funci√≥n para determinar la nueva URL del navegador basada en la URL del contenido
    function determinarNuevaUrl(contentUrl) {
        console.log('Determinando nueva URL para:', contentUrl);
        
        // Mapeo de URLs de contenido a URLs del navegador
        const urlMapping = {
            '/mantenedores/basico/pais/content': '/mantenedores/basico/pais',
            '/mantenedores/basico/regiones': '/mantenedores/basico/regiones',
            '/mantenedores/basico/religiones': '/mantenedores/basico/religiones',
            '/mantenedores/basico/sexo': '/mantenedores/basico/sexo'
        };
        
        const newUrl = urlMapping[contentUrl];
        console.log('Nueva URL mapeada:', newUrl);
        
        return newUrl;
    }
    
    // Funci√≥n utilitaria para limpiar modales correctamente
    function limpiarModal(modalId) {
        const modalElement = document.getElementById(modalId);
        if (modalElement) {
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
        }
        
        // Limpiar backdrop y clases del body
        setTimeout(() => {
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }, 300);
    }
    
    console.log('=== SCRIPT MANTENEDORES TERMINADO ===');
</script>
{% endblock %}