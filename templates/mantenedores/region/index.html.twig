{% extends 'mantenedores/index.html.twig' %}

{% block page_title %}Mantenedor de Regiones{% endblock %}
{% block entity_title %}Regiones{% endblock %}
{% block entity_description %}Gestión de regiones geográficas y datos IoT{% endblock %}

{% block menu_items %}
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-basicos">
                <i class="fas fa-database me-2"></i>
                Datos Básicos
            </button>
        </h2>
        <div id="collapse-basicos" class="accordion-collapse collapse show">
            <div class="accordion-body">
                <a href="{{ path('mantenedores_sexo_index') }}" class="menu-item">
                    <i class="fas fa-venus-mars"></i>
                    <span>Sexo</span>
                </a>
                <a href="{{ path('mantenedores_region_index') }}" class="menu-item active">
                    <i class="fas fa-globe-americas"></i>
                    <span>Regiones</span>
                </a>
            </div>
        </div>
    </div>
    
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-geograficos">
                <i class="fas fa-map me-2"></i>
                Geográficos
            </button>
        </h2>
        <div id="collapse-geograficos" class="accordion-collapse collapse">
            <div class="accordion-body">
                <a href="#" class="menu-item">
                    <i class="fas fa-flag"></i>
                    <span>Países</span>
                </a>
                <a href="#" class="menu-item">
                    <i class="fas fa-city"></i>
                    <span>Ciudades</span>
                </a>
                <a href="#" class="menu-item">
                    <i class="fas fa-map-pin"></i>
                    <span>Comunas</span>
                </a>
            </div>
        </div>
    </div>

    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-iot">
                <i class="fas fa-wifi me-2"></i>
                IoT y Sensores
            </button>
        </h2>
        <div id="collapse-iot" class="accordion-collapse collapse">
            <div class="accordion-body">
                <a href="#" class="menu-item">
                    <i class="fas fa-thermometer-half"></i>
                    <span>Sensores Temperatura</span>
                </a>
                <a href="#" class="menu-item">
                    <i class="fas fa-tint"></i>
                    <span>Sensores Humedad</span>
                </a>
                <a href="#" class="menu-item">
                    <i class="fas fa-chart-area"></i>
                    <span>Métricas IoT</span>
                </a>
            </div>
        </div>
    </div>
{% endblock %}

{% block table_headers %}
    <tr>
        <th class="sortable" data-sort="id">
            ID
            <span class="sort-icon"></span>
        </th>
        <th class="sortable" data-sort="nombre">
            Región
            <span class="sort-icon"></span>
        </th>
        <th class="sortable" data-sort="pais">
            País
            <span class="sort-icon"></span>
        </th>
        <th class="sortable" data-sort="codigo">
            Código
            <span class="sort-icon"></span>
        </th>
        {% if tenant == 'melisawiclinic' %}
            <th class="sortable" data-sort="iot_habilitado">
                IoT
                <span class="sort-icon"></span>
            </th>
        {% endif %}
        <th class="sortable" data-sort="activo">
            Estado
            <span class="sort-icon"></span>
        </th>
        <th class="sortable" data-sort="updated_at">
            Última Modificación
            <span class="sort-icon"></span>
        </th>
        <th width="120">Acciones</th>
    </tr>
{% endblock %}

{% block table_body %}
    <tbody id="table-body">
        {% for region in regiones|default([]) %}
            <tr data-id="{{ region.id }}" class="table-row">
                <td>{{ region.id }}</td>
                <td>
                    <strong>{{ region.nombre }}</strong>
                    {% if region.codigoIso %}
                        <small class="text-muted d-block">ISO: {{ region.codigoIso }}</small>
                    {% endif %}
                </td>
                <td>
                    <i class="fas fa-flag me-1"></i>
                    {{ region.pais|default('No especificado') }}
                </td>
                <td>
                    <span class="badge bg-secondary">{{ region.codigo|default('N/A') }}</span>
                </td>
                {% if tenant == 'melisawiclinic' %}
                    <td>
                        {% if region.iotHabilitado %}
                            <span class="badge bg-success">
                                <i class="fas fa-wifi me-1"></i>
                                Habilitado
                            </span>
                        {% else %}
                            <span class="badge bg-secondary">
                                <i class="fas fa-wifi-slash me-1"></i>
                                Deshabilitado
                            </span>
                        {% endif %}
                    </td>
                {% endif %}
                <td>
                    {% if region.activo %}
                        <span class="badge-activo">
                            <i class="status-indicator active"></i>
                            Activo
                        </span>
                    {% else %}
                        <span class="badge-inactivo">
                            <i class="status-indicator inactive"></i>
                            Inactivo
                        </span>
                    {% endif %}
                </td>
                <td>
                    <small>
                        {{ region.updatedAt|date('d/m/Y H:i') }}
                        {% if region.updatedBy %}
                            <br>por {{ region.updatedBy }}
                        {% endif %}
                    </small>
                </td>
                <td>
                    <div class="btn-group" role="group">
                        <button type="button" 
                                class="btn btn-action btn-edit" 
                                data-action="edit" 
                                data-id="{{ region.id }}"
                                title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        {% if tenant == 'melisawiclinic' and region.iotHabilitado %}
                            <button type="button" 
                                    class="btn btn-action btn-warning" 
                                    data-action="iot-config" 
                                    data-id="{{ region.id }}"
                                    title="Configurar IoT">
                                <i class="fas fa-cog"></i>
                            </button>
                        {% endif %}
                        <button type="button" 
                                class="btn btn-action btn-delete" 
                                data-action="delete" 
                                data-id="{{ region.id }}"
                                title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        {% else %}
            <tr>
                <td colspan="{{ tenant == 'melisawiclinic' ? '8' : '7' }}" class="text-center">
                    <div class="empty-state">
                        <i class="fas fa-globe-americas"></i>
                        <h5>No hay regiones registradas</h5>
                        <p>Comienza agregando la primera región</p>
                    </div>
                </td>
            </tr>
        {% endfor %}
    </tbody>
{% endblock %}

{% block modal_form %}
    <!-- Modal para Crear/Editar Región -->
    <div class="modal fade" id="regionModal" tabindex="-1" data-controller="mantenedores--modal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="regionForm" data-mantenedores--modal-target="form">
                    <div class="modal-header">
                        <h5 class="modal-title" data-mantenedores--modal-target="title">
                            <i class="fas fa-globe-americas me-2"></i>
                            <span data-mantenedores--modal-target="titleText">Nueva Región</span>
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    
                    <div class="modal-body">
                        <!-- ID oculto para edición -->
                        <input type="hidden" id="regionId" name="id" data-mantenedores--modal-target="entityId">
                        
                        <!-- Token CSRF -->
                        <input type="hidden" name="_token" value="{{ csrf_token('region_form') }}">
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="nombre" class="form-label">
                                        <i class="fas fa-map-marker-alt me-1"></i>
                                        Nombre de la Región *
                                    </label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="nombre" 
                                           name="nombre" 
                                           required 
                                           maxlength="100"
                                           placeholder="Ej: Región Metropolitana">
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="pais" class="form-label">
                                        <i class="fas fa-flag me-1"></i>
                                        País *
                                    </label>
                                    <select class="form-select" id="pais" name="pais" required>
                                        <option value="">Selecciona un país</option>
                                        <option value="Chile">Chile</option>
                                        <option value="Argentina">Argentina</option>
                                        <option value="Perú">Perú</option>
                                        <option value="Colombia">Colombia</option>
                                        <option value="México">México</option>
                                        <option value="España">España</option>
                                        <option value="Uruguay">Uruguay</option>
                                        <option value="Ecuador">Ecuador</option>
                                        <option value="Venezuela">Venezuela</option>
                                        <option value="Bolivia">Bolivia</option>
                                        <option value="Paraguay">Paraguay</option>
                                    </select>
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="codigo" class="form-label">
                                        <i class="fas fa-barcode me-1"></i>
                                        Código Regional
                                    </label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="codigo" 
                                           name="codigo"
                                           maxlength="10"
                                           placeholder="Ej: RM, V, VIII">
                                    <div class="form-text">Código abreviado de la región</div>
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="codigoIso" class="form-label">
                                        <i class="fas fa-globe me-1"></i>
                                        Código ISO
                                    </label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="codigoIso" 
                                           name="codigoIso"
                                           maxlength="10"
                                           placeholder="Código ISO 3166-2">
                                    <div class="form-text">Código estándar internacional</div>
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="descripcion" class="form-label">
                                <i class="fas fa-align-left me-1"></i>
                                Descripción
                            </label>
                            <textarea class="form-control" 
                                      id="descripcion" 
                                      name="descripcion" 
                                      rows="2"
                                      maxlength="500"
                                      placeholder="Descripción adicional de la región"></textarea>
                            <div class="form-text">Máximo 500 caracteres</div>
                            <div class="invalid-feedback"></div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           id="activo" 
                                           name="activo" 
                                           checked>
                                    <label class="form-check-label" for="activo">
                                        <i class="fas fa-toggle-on me-1"></i>
                                        Estado Activo
                                    </label>
                                </div>
                            </div>
                            
                            {% if tenant == 'melisawiclinic' %}
                                <div class="col-md-6">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" 
                                               type="checkbox" 
                                               id="iotHabilitado" 
                                               name="iotHabilitado">
                                        <label class="form-check-label" for="iotHabilitado">
                                            <i class="fas fa-wifi me-1"></i>
                                            IoT Habilitado
                                        </label>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Campos específicos del tenant Melisawiclinic -->
                        {% if tenant == 'melisawiclinic' %}
                            <div id="iotFields" style="display: none;">
                                <hr>
                                <h6 class="text-primary">
                                    <i class="fas fa-wifi me-2"></i>
                                    Configuración IoT
                                </h6>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="endpointIot" class="form-label">
                                                <i class="fas fa-link me-1"></i>
                                                Endpoint IoT
                                            </label>
                                            <input type="url" 
                                                   class="form-control" 
                                                   id="endpointIot" 
                                                   name="endpointIot"
                                                   placeholder="https://api.iot.example.com">
                                            <div class="invalid-feedback"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="claveApiIot" class="form-label">
                                                <i class="fas fa-key me-1"></i>
                                                Clave API IoT
                                            </label>
                                            <input type="password" 
                                                   class="form-control" 
                                                   id="claveApiIot" 
                                                   name="claveApiIot"
                                                   placeholder="Clave de acceso a la API">
                                            <div class="invalid-feedback"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="temperaturaMin" class="form-label">
                                                <i class="fas fa-thermometer-empty me-1"></i>
                                                Temp. Mínima (°C)
                                            </label>
                                            <input type="number" 
                                                   class="form-control" 
                                                   id="temperaturaMin" 
                                                   name="temperaturaMin"
                                                   step="0.1"
                                                   placeholder="15.0">
                                            <div class="invalid-feedback"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="temperaturaMax" class="form-label">
                                                <i class="fas fa-thermometer-full me-1"></i>
                                                Temp. Máxima (°C)
                                            </label>
                                            <input type="number" 
                                                   class="form-control" 
                                                   id="temperaturaMax" 
                                                   name="temperaturaMax"
                                                   step="0.1"
                                                   placeholder="35.0">
                                            <div class="invalid-feedback"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="humedadOptima" class="form-label">
                                                <i class="fas fa-tint me-1"></i>
                                                Humedad Óptima (%)
                                            </label>
                                            <input type="number" 
                                                   class="form-control" 
                                                   id="humedadOptima" 
                                                   name="humedadOptima"
                                                   min="0" 
                                                   max="100"
                                                   placeholder="60">
                                            <div class="invalid-feedback"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary" data-mantenedores--modal-target="submitBtn">
                            <i class="fas fa-save me-1"></i>
                            <span data-mantenedores--modal-target="submitText">Guardar</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal de Confirmación para Eliminar -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Confirmar Eliminación
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <i class="fas fa-trash-alt text-danger mb-3" style="font-size: 3rem;"></i>
                    <h6>¿Estás seguro?</h6>
                    <p class="text-muted mb-0">Esta acción no se puede deshacer</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                        <i class="fas fa-trash me-1"></i>
                        Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    {% if tenant == 'melisawiclinic' %}
        <!-- Modal de Configuración IoT -->
        <div class="modal fade" id="iotConfigModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-info text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-cog me-2"></i>
                            Configuración IoT
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center mb-4">
                            <i class="fas fa-wifi text-info mb-3" style="font-size: 3rem;"></i>
                            <h6 id="iotRegionName">Región: --</h6>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <h6 class="text-muted">Estado de Sensores</h6>
                                <div class="list-group mb-3">
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <span><i class="fas fa-thermometer-half text-danger me-2"></i>Sensor Temperatura</span>
                                        <span class="badge bg-success">Activo</span>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <span><i class="fas fa-tint text-primary me-2"></i>Sensor Humedad</span>
                                        <span class="badge bg-success">Activo</span>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <span><i class="fas fa-wind text-secondary me-2"></i>Sensor Presión</span>
                                        <span class="badge bg-warning">Mantenimiento</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-muted">Última Lectura</h6>
                                <div class="card bg-light">
                                    <div class="card-body p-2">
                                        <small class="text-muted">Temperatura: <strong>22.5°C</strong></small><br>
                                        <small class="text-muted">Humedad: <strong>65%</strong></small><br>
                                        <small class="text-muted">Actualizado: hace 2 min</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted">Estado de Conexión</h6>
                                <div class="card bg-light">
                                    <div class="card-body p-2">
                                        <small class="text-success"><i class="fas fa-circle me-1"></i>Conectado</small><br>
                                        <small class="text-muted">Latencia: 45ms</small><br>
                                        <small class="text-muted">Última sync: 10:30</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>
                            Cerrar
                        </button>
                        <button type="button" class="btn btn-info">
                            <i class="fas fa-sync me-1"></i>
                            Sincronizar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block info_panel_content %}
    <div class="card-body" data-mantenedores--list-target="infoPanel">
        <div class="text-center text-muted">
            <i class="fas fa-info-circle mb-3" style="font-size: 3rem; opacity: 0.3;"></i>
            <h6>Información de la Región</h6>
            <p>Selecciona una región de la tabla para ver sus detalles aquí</p>
        </div>
    </div>
{% endblock %}

{% block javascript_config %}
    <script>
        // Configuración específica para el mantenedor de Regiones
        window.MantenedorConfig = {
            entity: 'region',
            entityName: 'Región',
            entityNamePlural: 'Regiones',
            urls: {
                list: '{{ path('mantenedores_region_list') }}',
                create: '{{ path('mantenedores_region_create') }}',
                show: '{{ path('mantenedores_region_show', {id: '__ID__'}) }}',
                update: '{{ path('mantenedores_region_update', {id: '__ID__'}) }}',
                delete: '{{ path('mantenedores_region_delete', {id: '__ID__'}) }}',
                {% if tenant == 'melisawiclinic' %}
                iotConfig: '{{ path('mantenedores_region_configurar_iot', {id: '__ID__'}) }}',
                iotMetrics: '{{ path('mantenedores_region_metricas_iot') }}',
                iotDashboard: '{{ path('mantenedores_region_dashboard_tiempo_real') }}'
                {% endif %}
            },
            tenant: '{{ tenant|default('default') }}',
            csrf: {
                form: '{{ csrf_token('region_form') }}',
                delete: '{{ csrf_token('region_delete') }}'
            },
            search: {
                placeholder: 'Buscar por región, país, código...',
                fields: ['nombre', 'pais', 'codigo', 'codigoIso']
            },
            validation: {
                nombre: {
                    required: true,
                    maxLength: 100
                },
                pais: {
                    required: true,
                    maxLength: 100
                },
                codigo: {
                    maxLength: 10
                },
                codigoIso: {
                    maxLength: 10
                },
                descripcion: {
                    maxLength: 500
                }
            }
        };
        
        {% if tenant == 'melisawiclinic' %}
        // JavaScript específico para IoT
        document.addEventListener('DOMContentLoaded', function() {
            const iotHabilitado = document.getElementById('iotHabilitado');
            const iotFields = document.getElementById('iotFields');
            
            if (iotHabilitado && iotFields) {
                iotHabilitado.addEventListener('change', function() {
                    iotFields.style.display = this.checked ? 'block' : 'none';
                });
                
                // Trigger inicial
                iotFields.style.display = iotHabilitado.checked ? 'block' : 'none';
            }
            
            // Manejar botón de configuración IoT
            document.addEventListener('click', function(e) {
                if (e.target.closest('[data-action="iot-config"]')) {
                    const regionId = e.target.closest('[data-action="iot-config"]').dataset.id;
                    const regionName = e.target.closest('tr').querySelector('td:nth-child(2) strong').textContent;
                    
                    document.getElementById('iotRegionName').textContent = 'Región: ' + regionName;
                    new bootstrap.Modal(document.getElementById('iotConfigModal')).show();
                }
            });
        });
        {% endif %}
    </script>
{% endblock %}