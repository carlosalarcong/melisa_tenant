# This file is the entry point to configure your own services.
# Files in the packages/ subdirectory configure your dependencies.

# Put parameters here that don't need to change on each machine where the app is deployed
# https://symfony.com/doc/current/best_practices.html#use-parameters-for-application-configuration
parameters:
    # Configuración de resolución dinámica de controladores por tenant
    tenant.dynamic_resolution.excluded_controllers:
        - 'App\Controller\LoginController'
        - 'App\Controller\SecurityController'
        - 'App\Controller\LocaleController'
        - 'App\Controller\PasswordResetController'
    
    tenant.dynamic_resolution.excluded_namespaces:
        - 'Symfony\'
        - 'App\Controller\Mantenedores\'
    
    # Parámetros legacy de Symfony 3 para compatibilidad
    estado_activo: 1
    estado_inactivo: 0
    estado_usuario_activo: 1
    estado_usuario_inactivo: 0
    estado_usuario_bloqueado: 2
    parametro_rebsol: 1
    parametro_empresa: 0
    arancel_publico: 1
    arancel_privado: 2
    arancel_pubpriv: 3
    rol_medico: 1
    ambulatoria: 1
    modulo_caja: 11
    
    # Parámetros de entidades (formato nuevo)
    Estado.activo: 1
    Estado.inactivo: 0
    EstadoPila.activo: 1
    EstadoPila.inactivo: 0
    EstadoReapertura.cerrada: 0
    EstadoReapertura.abierta: 1
    EstadoPago.anulado: 0
    EstadoPago.pagadoNormal: 1
    EstadoPago.garantia: 2
    EstadoPago.garantiaRegularizada: 3
    EstadoPago.pendientePago: 4
    EstadoCuenta.cerradaPagada: 1
    EstadoCuenta.anulado: 2
    EstadoCuenta.abiertaEnGarantia: 3
    EstadoCuenta.cerradaRevisionInterna: 4
    EstadoCuenta.cerradaPendientePago: 6
    EstadoCuenta.cerradaPagadaTotal: 10
    EstadoCuenta.abiertaPendientePago: 11
    EstadoCuenta.abiertaPagadaTotal: 12
    EstadoDetalleTalonario.porEmitir: 0
    EstadoDetalleTalonario.emitidas: 1
    EstadoDetalleTalonario.anulada: 2
    EstadoTalonarioDetalle.disponible: 0
    EstadoTalonarioDetalle.reservada: 1
    EstadoTalonarioDetalle.ocupada: 2
    EstadoDiferencia.cajeroPideAutorizacion: 0
    EstadoDiferencia.autorizada: 1
    EstadoAccionClinica.solicitado: 1
    EstadoAccionClinica.planificado: 10
    EstadoTratamiento.Finalizado: 0
    EstadoTratamiento.EnProceso: 1
    EstadoTratamiento.Anulado: 2
    EstadoRelUbicacionCajero.Inactivo: 0
    EstadoRelUbicacionCajero.Activo: 1
    EstadoUsuarios.activo: 1
    TipoAtencion.ambulatoria: 1
    TipoAtencion.urgencia: 3
    caja.idModulo: 11

services:
    # default configuration for services in *this* file
    _defaults:
        autowire: true      # Automatically injects dependencies in your services.
        autoconfigure: true # Automatically registers your services as commands, event subscribers, etc.

    # makes classes in src/ available to be used as services
    # this creates a service per class whose id is the fully-qualified class name
    App\:
        resource: '../src/'
        exclude:
            - '../src/DependencyInjection/'
            - '../src/Entity/'
            - '../src/Kernel.php'

    # add more service definitions when explicit configuration is needed
    # please note that last definitions always *replace* previous ones

    # Servicios específicos de Melisa Tenant

    App\Service\TenantResolver:
        arguments:
            $centralDbUrl: '%env(DATABASE_URL)%'

    App\Service\TenantContext:
        arguments:
            $centralDbUrl: '%env(DATABASE_URL)%'

    # CustomTenantConfigProvider: Integración con hakam/multi-tenancy-bundle
    # Usa TenantResolver para leer desde melisa_central
    App\Service\CustomTenantConfigProvider: ~

    # Alias para que el bundle use nuestro provider personalizado
    Hakam\MultiTenancyBundle\Port\TenantConfigProviderInterface:
        alias: App\Service\CustomTenantConfigProvider
        public: true

    # Extensiones Twig
    App\Twig\LocalizationExtension:
        tags: ['twig.extension']

    # Event Listeners
    App\EventListener\LocaleListener:
        tags:
            - { name: kernel.event_subscriber }

    App\EventListener\TenantTranslationListener:
        arguments:
            $projectDir: '%kernel.project_dir%'
        tags:
            - { name: kernel.event_subscriber }

    # TenantDatabaseSwitchListener: Usa SwitchDbEvent del bundle
    # Reemplaza al antiguo TenantConnectionListener (eliminado)
    App\EventListener\TenantDatabaseSwitchListener: ~

    #App\EventListener\AuthenticationListener:
    #    arguments:
    #        $urlGenerator: '@router'
    #    tags:
    #        - { name: kernel.event_subscriber }

    # Event Subscribers
    App\EventSubscriber\DynamicControllerSubscriber:
        arguments:
            $excludedControllers: '%tenant.dynamic_resolution.excluded_controllers%'
            $excludedNamespaces: '%tenant.dynamic_resolution.excluded_namespaces%'
        tags:
            - { name: kernel.event_subscriber }

    # Commands (Legacy - deprecated)
    App\Command\MigrationsTenantLegacyCommand:
        arguments:
            $centralDbUrl: '%env(DATABASE_URL)%'
        tags:
            - { name: console.command }
